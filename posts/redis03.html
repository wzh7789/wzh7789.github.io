<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redisé«˜çº§ | Wzhçš„çº¸ç®±ğŸ§Š</title><meta name="keywords" content="æ•°æ®åº“,Redis"><meta name="author" content="çˆ±å­¦æŠ€æœ¯çš„å°å´ğŸµ"><meta name="copyright" content="çˆ±å­¦æŠ€æœ¯çš„å°å´ğŸµ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="ä¸€ä¸ªåŸºäºå†…å­˜çš„&#96;key-value&#96;ç»“æ„æ•°æ®åº“">
<meta property="og:type" content="article">
<meta property="og:title" content="Redisé«˜çº§">
<meta property="og:url" content="https://w-zx.cc/posts/redis03.html">
<meta property="og:site_name" content="Wzhçš„çº¸ç®±ğŸ§Š">
<meta property="og:description" content="ä¸€ä¸ªåŸºäºå†…å­˜çš„&#96;key-value&#96;ç»“æ„æ•°æ®åº“">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imgbed.link/file/27050">
<meta property="article:published_time" content="2023-05-15T10:19:03.000Z">
<meta property="article:modified_time" content="2023-05-20T14:00:00.000Z">
<meta property="article:author" content="çˆ±å­¦æŠ€æœ¯çš„å°å´ğŸµ">
<meta property="article:tag" content="æ•°æ®åº“">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imgbed.link/file/27050"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://w-zx.cc/posts/redis03"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redisé«˜çº§',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-20 22:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><link rel="stylesheet" href="https://npm.elemecdn.com/ethan4116-blog/lib/css/plane_v2.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Wzhçš„çº¸ç®±ğŸ§Š" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/26921" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">12</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> å›å¿†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Wzhçš„çº¸ç®±ğŸ§Š</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> å›å¿†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Redisé«˜çº§</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2023-05-15T10:19:03.000Z" title="å‘è¡¨äº 2023-05-15 18:19:03">2023-05-15</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-05-20T14:00:00.000Z" title="æ›´æ–°äº 2023-05-20 22:00:00">2023-05-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">4.8w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>186åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redisé«˜çº§"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>å†…å®¹æ¦‚è¿°</h1>
<ul>
<li>
<pre><code>çŸ­ä¿¡ç™»å½•
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  -</span> è¿™éƒ¨åˆ†ä¼šä½¿ç”¨Rediså…±äº«sessionæ¥å®ç°</span><br><span class="line"><span class="bullet">  -</span> ä½†å…¶å®æˆ‘åœ¨ä¹‹å‰çš„ç‘å‰å¤–å–çš„é¡¹ç›®ä¼˜åŒ–éƒ¨åˆ†å°±åšè¿‡äº†ï¼Œç”¨Redisæ›¿æ¢sessionæ¥å­˜å‚¨é‚®ç®±éªŒè¯ç </span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`å•†æˆ·æŸ¥è¯¢ç¼“å­˜`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> è¿™éƒ¨åˆ†è¦ç†è§£ç¼“å­˜å‡»ç©¿ï¼Œç¼“å­˜ç©¿é€ï¼Œç¼“å­˜é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¹äºè¿™äº›æ¦‚å¿µçš„ç†è§£ä¸ä»…ä»…æ˜¯åœç•™åœ¨æ¦‚å¿µä¸Šï¼Œæ›´æ˜¯èƒ½åœ¨ä»£ç ä¸­çœ‹åˆ°å¯¹åº”çš„å†…å®¹</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`ä¼˜æƒ åˆ¸ç§’æ€`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> è¿™éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥å­¦ä¼šRedisçš„è®¡æ•°å™¨åŠŸèƒ½ï¼Œç»“åˆLua(ä¹‹å‰ä¸€ç›´æƒ³å­¦Luaç„¶åå†™é¥¥è’mod)å®Œæˆé«˜æ€§èƒ½çš„Redisæ“ä½œï¼ŒåŒæ—¶å­¦ä¼šRedisåˆ†å¸ƒå¼é”çš„åŸç†ï¼ŒåŒ…æ‹¬Redisçš„ä¸‰ç§æ¶ˆæ¯é˜Ÿåˆ—</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">```</span></span><br><span class="line"><span class="code">  é™„è¿‘çš„å•†æˆ·</span></span><br></pre></td></tr></table></figure>

- åˆ©ç”¨Redisçš„GEOHash(æ–°æ•°æ®ç»“æ„ï¼Œå‰é¢æ²¡æœ‰åº”ç”¨åœºæ™¯å°±æ²¡ä»‹ç»)æ¥å®Œæˆå¯¹äºåœ°ç†åæ ‡çš„æ“ä½œ

</code></pre>
</li>
<li>
<pre><code>UVç»Ÿè®¡
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  -</span> ä¸»è¦æ˜¯ä½¿ç”¨Redisæ¥å®Œæˆç»Ÿè®¡åŠŸèƒ½</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`ç”¨æˆ·ç­¾åˆ°`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> ä½¿ç”¨Redisçš„BitMapæ•°æ®ç»Ÿè®¡åŠŸèƒ½</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`å¥½å‹å…³æ³¨`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> åŸºäºSeté›†åˆçš„å…³æ³¨ã€å–æ¶ˆå…³æ³¨ï¼Œå…±åŒå…³æ³¨ç­‰ç­‰åŠŸèƒ½ï¼Œè¿™éƒ¨åˆ†åœ¨ä¸Šç¯‡çš„ç»ƒä¹ é¢˜ä¸­å‡ºç°è¿‡ï¼Œè¿™æ¬¡æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æ¥ä½¿ç”¨ä¸€ä¸‹</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">```</span></span><br><span class="line"><span class="code">  è¾¾äººæ¢åº—</span></span><br></pre></td></tr></table></figure>

- åŸºäºListæ¥å®Œæˆç‚¹èµåˆ—è¡¨çš„æ“ä½œï¼ŒåŒæ—¶åŸºäºSortedSetæ¥å®Œæˆç‚¹èµçš„æ’è¡Œæ¦œåŠŸèƒ½

</code></pre>
</li>
</ul>
<h1>çŸ­ä¿¡ç™»å½•</h1>
<h2 id="å¯¼å…¥é¡¹ç›®">å¯¼å…¥é¡¹ç›®</h2>
<p>åœ¨å®ç°åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¯¼å…¥é¡¹ç›®ï¼Œè®©é¡¹ç›®è·‘èµ·æ¥</p>
<h3 id="å¯¼å…¥SQL">å¯¼å…¥SQL</h3>
<p>é»‘é©¬å·²ç»åœ¨èµ„æ–™ä¸­æä¾›å¥½äº†SQLæ–‡ä»¶ï¼Œè¿™é‡Œç®€å•åˆ†æä¸€ä¸‹æä¾›çš„è¡¨</p>
<table>
<thead>
<tr>
<th style="text-align:center">è¡¨</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">tb_user</td>
<td style="text-align:center">ç”¨æˆ·è¡¨</td>
</tr>
<tr>
<td style="text-align:center">tb_user_info</td>
<td style="text-align:center">ç”¨æˆ·è¯¦æƒ…è¡¨</td>
</tr>
<tr>
<td style="text-align:center">tb_shop</td>
<td style="text-align:center">å•†æˆ·ä¿¡æ¯è¡¨</td>
</tr>
<tr>
<td style="text-align:center">tb_shop_type</td>
<td style="text-align:center">å•†æˆ·ç±»å‹è¡¨</td>
</tr>
<tr>
<td style="text-align:center">tb_blog</td>
<td style="text-align:center">ç”¨æˆ·æ—¥è®°è¡¨ï¼ˆè¾¾äººæ¢åº—æ—¥è®°)</td>
</tr>
<tr>
<td style="text-align:center">tb_follow</td>
<td style="text-align:center">ç”¨æˆ·å…³æ³¨è¡¨</td>
</tr>
<tr>
<td style="text-align:center">tb_voucher</td>
<td style="text-align:center">ä¼˜æƒ åˆ¸è¡¨</td>
</tr>
<tr>
<td style="text-align:center">tb_voucher_order</td>
<td style="text-align:center">ä¼˜æƒ åˆ¸çš„è®¢å•è¡¨</td>
</tr>
</tbody>
</table>
<h3 id="æœ‰å…³å½“å‰æ¨¡å‹">æœ‰å…³å½“å‰æ¨¡å‹</h3>
<ul>
<li>è¯¥é¡¹ç›®é‡‡ç”¨çš„æ˜¯å‰åç«¯åˆ†ç¦»å¼€å‘æ¨¡å¼</li>
<li>æ‰‹æœºæˆ–è€…appç«¯å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚æˆ‘ä»¬çš„NginxæœåŠ¡å™¨ï¼ŒNginxåŸºäºä¸ƒå±‚æ¨¡å‹èµ°çš„äº‹HTTPåè®®ï¼Œå¯ä»¥å®ç°åŸºäºLuaç›´æ¥ç»•å¼€Tomcatè®¿é—®Redisï¼Œä¹Ÿå¯ä»¥ä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨ï¼Œè½»æ¾æ‰›ä¸‹ä¸Šä¸‡å¹¶å‘ï¼Œ è´Ÿè½½å‡è¡¡åˆ°ä¸‹æ¸¸TomcatæœåŠ¡å™¨ï¼Œæ‰“æ•£æµé‡ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä¸€å°4æ ¸8Gçš„Tomcatï¼Œåœ¨ä¼˜åŒ–å’Œå¤„ç†ç®€å•ä¸šåŠ¡çš„åŠ æŒä¸‹ï¼Œå¤§ä¸äº†å°±å¤„ç†1000å·¦å³çš„å¹¶å‘ï¼Œ ç»è¿‡Nginxçš„è´Ÿè½½å‡è¡¡åˆ†æµåï¼Œåˆ©ç”¨é›†ç¾¤æ”¯æ’‘èµ·æ•´ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶Nginxåœ¨éƒ¨ç½²äº†å‰ç«¯é¡¹ç›®åï¼Œæ›´æ˜¯å¯ä»¥åšåˆ°åŠ¨é™åˆ†ç¦»ï¼Œè¿›ä¸€æ­¥é™ä½TomcatæœåŠ¡çš„å‹åŠ›ï¼Œè¿™äº›åŠŸèƒ½éƒ½å¾—é Nginxèµ·ä½œç”¨ï¼Œæ‰€ä»¥Nginxæ˜¯æ•´ä¸ªé¡¹ç›®ä¸­é‡è¦çš„ä¸€ç¯ã€‚</li>
<li>åœ¨Tomcatæ”¯æ’‘èµ·å¹¶å‘æµé‡åï¼Œæˆ‘ä»¬å¦‚æœè®©Tomcatç›´æ¥å»è®¿é—®Mysqlï¼Œæ ¹æ®ç»éªŒMysqlä¼ä¸šçº§æœåŠ¡å™¨åªè¦ä¸Šç‚¹å¹¶å‘ï¼Œä¸€èˆ¬æ˜¯16æˆ–32 æ ¸å¿ƒcpuï¼Œ32 æˆ–64Gå†…å­˜ï¼Œåƒä¼ä¸šçº§mysqlåŠ ä¸Šå›ºæ€ç¡¬ç›˜èƒ½å¤Ÿæ”¯æ’‘çš„å¹¶å‘ï¼Œå¤§æ¦‚å°±æ˜¯4000èµ·~7000å·¦å³ï¼Œä¸Šä¸‡å¹¶å‘ï¼Œ ç¬é—´å°±ä¼šè®©MysqlæœåŠ¡å™¨çš„cpuï¼Œç¡¬ç›˜å…¨éƒ¨æ‰“æ»¡ï¼Œå®¹æ˜“å´©æºƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šé€‰æ‹©ä½¿ç”¨mysqlé›†ç¾¤ï¼ŒåŒæ—¶ä¸ºäº†è¿›ä¸€æ­¥é™ä½Mysqlçš„å‹åŠ›ï¼ŒåŒæ—¶å¢åŠ è®¿é—®çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåŠ å…¥Redisï¼ŒåŒæ—¶ä½¿ç”¨Redisé›†ç¾¤ä½¿å¾—Rediså¯¹å¤–æä¾›æ›´å¥½çš„æœåŠ¡ã€‚</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6353709216f2c2beb134e44b.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6353709216f2c2beb134e44b.jpg" alt="img"></a></p>
<h3 id="å¯¼å…¥åç«¯é¡¹ç›®">å¯¼å…¥åç«¯é¡¹ç›®</h3>
<ul>
<li>é»‘é©¬å·²ç»æä¾›å¥½äº†åç«¯é¡¹ç›®æºç å‹ç¼©åŒ…ï¼Œæˆ‘ä»¬å°†å…¶è§£å‹ä¹‹åï¼Œæ”¾åˆ°è‡ªå·±çš„workspaceé‡Œ</li>
<li>ç„¶åä¿®æ”¹MySQLå’ŒReidsçš„è¿æ¥è¦ç´ ä¸ºè‡ªå·±çš„ï¼Œéšåå¯åŠ¨é¡¹ç›®</li>
<li>è®¿é—®http://localhost:8081/shop-type/list ï¼Œå¦‚æœå¯ä»¥çœ‹åˆ°JSONæ•°æ®ï¼Œåˆ™è¯´æ˜å¯¼å…¥æˆåŠŸ</li>
</ul>
<h3 id="å¯¼å…¥å‰ç«¯å·¥ç¨‹">å¯¼å…¥å‰ç«¯å·¥ç¨‹</h3>
<ul>
<li>
<p>é»‘é©¬å·²ç»æä¾›å¥½äº†å‰ç«¯é¡¹ç›®æºç å‹ç¼©åŒ…ï¼Œæˆ‘ä»¬å°†å…¶è§£å‹ä¹‹åï¼Œæ”¾åˆ°è‡ªå·±çš„workSpaceé‡Œ</p>
</li>
<li>
<p>ç„¶ååœ¨nginxæ‰€åœ¨ç›®å½•æ‰“å¼€ä¸€ä¸ªcmdçª—å£ï¼Œè¾“å…¥å‘½ä»¤ï¼Œå³å¯å¯åŠ¨é¡¹ç›®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start nginx.exe</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¿é—®http://localhost:8080/ ï¼Œæ‰“å¼€å¼€å‘è€…æ¨¡å¼ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6353775b16f2c2beb140da1d.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6353775b16f2c2beb140da1d.jpg" alt="img"></a></p>
</li>
</ul>
<h2 id="åŸºäºSessionå®ç°ç™»å½•æµç¨‹">åŸºäºSessionå®ç°ç™»å½•æµç¨‹</h2>
<ol>
<li>
<p>å‘é€éªŒè¯ç <br>
ç”¨æˆ·åœ¨æäº¤æ‰‹æœºå·åï¼Œä¼šæ ¡éªŒæ‰‹æœºå·æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•ï¼Œåˆ™è¦æ±‚ç”¨æˆ·é‡æ–°è¾“å…¥æ‰‹æœºå·<br>
å¦‚æœæ‰‹æœºå·åˆæ³•ï¼Œåå°æ­¤æ—¶ç”Ÿæˆå¯¹åº”çš„éªŒè¯ç ï¼ŒåŒæ—¶å°†éªŒè¯ç è¿›è¡Œä¿å­˜ï¼Œç„¶åå†é€šè¿‡çŸ­ä¿¡çš„æ–¹å¼å°†éªŒè¯ç å‘é€ç»™ç”¨æˆ·</p>
</li>
<li>
<p>çŸ­ä¿¡éªŒè¯ç ç™»å½•ã€æ³¨å†Œ<br>
ç”¨æˆ·å°†éªŒè¯ç å’Œæ‰‹æœºå·è¿›è¡Œè¾“å…¥ï¼Œåå°ä»sessionä¸­æ‹¿åˆ°å½“å‰éªŒè¯ç ï¼Œç„¶åå’Œç”¨æˆ·è¾“å…¥çš„éªŒè¯ç è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™æ— æ³•é€šè¿‡æ ¡éªŒï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™åå°æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™ä¸ºç”¨æˆ·åˆ›å»ºè´¦å·ä¿¡æ¯ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ— è®ºæ˜¯å¦å­˜åœ¨ï¼Œéƒ½ä¼šå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°sessionä¸­ï¼Œæ–¹ä¾¿åç»­è·å¾—å½“å‰ç™»å½•ä¿¡æ¯</p>
</li>
<li>
<p>æ ¡éªŒç™»å½•çŠ¶æ€<br>
ç”¨æˆ·åœ¨è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šä»cookieä¸­æºå¸¦JsessionIdåˆ°åå°ï¼Œåå°é€šè¿‡JsessionIdä»sessionä¸­æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰sessionä¿¡æ¯ï¼Œåˆ™è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœæœ‰sessionä¿¡æ¯ï¼Œåˆ™å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶æ”¾è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"><span class="comment">//åŸºäºSessionå®ç°ç™»å½•   æ­¤å¤„æœ‰ä¸ªé€»è¾‘æ¼æ´ï¼šå¦‚æœæˆ‘ä½¿ç”¨æ‰‹æœºå·1å‘é€éªŒè¯ç ï¼Œç„¶åæ”¹æˆæ‰‹æœºå·2ï¼Œè¾“å…¥éªŒè¯ç ï¼Œç„¶åç™»å½•ï¼Œå› ä¸ºsessionçš„keyæ˜¯codeï¼Œè€Œä¸æ˜¯æ‰‹æœºå·ï¼Œå°±å®¹æ˜“ç™»å½•åˆ°åˆ«çš„å·ç </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">//1. æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">        <span class="keyword">if</span>(RegexUtils.isPhoneInvalid(phone))&#123;</span><br><span class="line">            <span class="comment">//2. å¦‚æœä¸ç¬¦åˆ, è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(phone);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.ç¬¦åˆ.ç”ŸæˆéªŒè¯ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.ä¿å­˜éªŒè¯ç åˆ°sessionä¸­</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">        <span class="comment">//5.å‘é€éªŒè¯ç </span></span><br><span class="line">        log.debug(<span class="string">&quot;å‘é€éªŒè¯ç æˆåŠŸ,éªŒè¯ç ä¸º:&#123;&#125;&quot;</span>,code);</span><br><span class="line">        <span class="comment">//è¿”å›ok</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ç§æ–¹æ³•æ˜¯ç”±bugçš„,å¦‚æœå‰ç«¯å‘é€éªŒè¯ç åï¼Œåˆä¿®æ”¹äº†æ‰‹æœºå·ï¼Œcodeè¿˜æ˜¯ä¸€è‡´çš„.</span></span><br><span class="line">    <span class="comment">//åœ¨æ”¶åˆ°éªŒè¯ç çš„æ—¶å€™æŠŠæ‰‹æœºå·æ”¹äº†ï¼Œè€Œä¸”æ‰‹æœºè¿˜å­˜åœ¨ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥ç™»å…¥åˆ«äººçš„è´¦å·äº†</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">       		 <span class="comment">//1. æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">        <span class="keyword">if</span>(RegexUtils.isPhoneInvalid(phone))&#123;</span><br><span class="line">            <span class="comment">//å¦‚æœä¸ç¬¦åˆ,åˆ™è¿”å›é”™è¯¯</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(phone);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">cacheCode</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;code&quot;</span>);<span class="comment">//é­”æ³•å€¼ï¼šä¸šåŠ¡ä»£ç ä¸­ç›´æ¥å‡ºç°çš„å¸¸é‡ã€‚è¿™äº›å¸¸é‡è‡³å°‘è¦æ”¾åˆ°å…¨å±€å˜é‡ä¸­ï¼Œæˆ–è€…æšä¸¾ç±»ä¸­</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(cacheCode == <span class="literal">null</span> | !cacheCode.toString().equals(code))&#123;</span><br><span class="line">            <span class="comment">//3. ä¸ä¸€è‡´,æŠ¥é”™</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//4.åˆ¤æ–­æ˜¯å¦ä¸€è‡´,æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·   select * from tb_user where phone = ?</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();   <span class="comment">//one æŒ‡æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line">        <span class="comment">//5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//6.ä¸å­˜åœ¨,æ³¨å†Œæ–°ç”¨æˆ·å¹¶è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">            user = createUserWithPhone(phone);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­</span></span><br><span class="line">            session.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">createUserWithPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setPhone(phone);</span><br><span class="line">        user.setNickName(USER_NICK_NAME_PREFIX+RandomUtil.randomString(<span class="number">10</span>));</span><br><span class="line">        save(user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™é‡Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è®¾ç½®é˜²å¾¡ç™»å½•å‡­è¯,å› ä¸ºsessionçš„åº•å±‚æ˜¯cookie,æ¯ä¸€sessionéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„sessionçš„ID,å½“è®¿é—®tomcatæ—¶,è¿™ä¸ªIdå°±è‡ªåŠ¨ä¿å­˜åˆ°cookieä¸­ä»¥åè¯·æ±‚éƒ½ä¼šå¸¦ç€è¿™ä¸ªId,æ ¹æ®Idå°±èƒ½æ‰¾åˆ°session, åœ¨æ ¹æ®sessionå°±èƒ½æ‰¾åˆ°ç”¨æˆ·</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½">å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½</h2>
<ul>
<li>
<p>è¾“å…¥æ‰‹æœºå·ï¼Œç‚¹å‡»å‘é€éªŒè¯ç æŒ‰é’®ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/user/code?phone=15832165478">http://localhost:8080/api/user/code?phone=15832165478</a><br>
è¯·æ±‚æ–¹æ³•: POST</p>
</blockquote>
</li>
<li>
<p>çœ‹æ ·å­æ˜¯è°ƒç”¨UserControllerä¸­çš„codeæ–¹æ³•ï¼Œæºå¸¦å‚æ•°æ˜¯<code>phone</code>ï¼Œçœ‹é»‘é©¬æä¾›çš„æºç ä¹Ÿè¯å®äº†æˆ‘çš„çŒœæƒ³</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‘é€æ‰‹æœºéªŒè¯ç </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO å‘é€çŸ­ä¿¡éªŒè¯ç å¹¶ä¿å­˜éªŒè¯ç </span></span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;åŠŸèƒ½æœªå®Œæˆ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯é»‘é©¬è¿™é‡Œå¹¶ä¸ä¼šçœŸçš„ä½¿ç”¨çŸ­ä¿¡æœåŠ¡å‘é€éªŒè¯ç ï¼Œåªæ˜¯éšæœºç”Ÿæˆäº†ä¸€ä¸ªéªŒè¯ç ï¼Œé‚£æˆ‘è¿™é‡Œä¸ºäº†åæœŸé¡¹ç›®èƒ½çœŸçš„éƒ¨ç½²ä¸Šçº¿ï¼Œè¿˜æ˜¯æ‰“ç®—ç”¨é‚®ç®±éªŒè¯</p>
</li>
<li>
<p>ç”±äºé»‘é©¬è¿™é‡Œè²Œä¼¼æ²¡æœ‰è®¾ç½®å‰ç«¯çš„æ‰‹æœºå·æ­£åˆ™åˆ¤æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å»æ•°æ®åº“ä¸­ä¿®æ”¹phoneçš„å­—æ®µç±»å‹ï¼Œå°†varchar(11)æ”¹ä¸ºvarchar(100)</p>
</li>
<li>
<p>å¯¼å…¥é‚®ç®±éªŒè¯éœ€è¦çš„mavenåæ ‡</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.activation/activation --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.mail/mail --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.mail<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-email<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç„¶åç¼–å†™ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºå‘é€é‚®ä»¶éªŒè¯ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.mail.Authenticator;</span><br><span class="line"><span class="keyword">import</span> javax.mail.MessagingException;</span><br><span class="line"><span class="keyword">import</span> javax.mail.PasswordAuthentication;</span><br><span class="line"><span class="keyword">import</span> javax.mail.Session;</span><br><span class="line"><span class="keyword">import</span> javax.mail.Transport;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.InternetAddress;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage.RecipientType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MessagingException &#123;</span><br><span class="line">        <span class="comment">//å¯ä»¥åœ¨è¿™é‡Œç›´æ¥æµ‹è¯•æ–¹æ³•ï¼Œå¡«è‡ªå·±çš„é‚®ç®±å³å¯</span></span><br><span class="line">        sendTestMail(<span class="string">&quot;1586385296@qq.com&quot;</span>, <span class="keyword">new</span> <span class="title class_">MailUtils</span>().achieveCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendTestMail</span><span class="params">(String email, String code)</span> <span class="keyword">throws</span> MessagingException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºProperties ç±»ç”¨äºè®°å½•é‚®ç®±çš„ä¸€äº›å±æ€§</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºSMTPå‘é€é‚®ä»¶ï¼Œå¿…é¡»è¿›è¡Œèº«ä»½éªŒè¯</span></span><br><span class="line">        props.put(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="comment">//æ­¤å¤„å¡«å†™SMTPæœåŠ¡å™¨</span></span><br><span class="line">        props.put(<span class="string">&quot;mail.smtp.host&quot;</span>, <span class="string">&quot;smtp.qq.com&quot;</span>);</span><br><span class="line">        <span class="comment">//ç«¯å£å·ï¼ŒQQé‚®ç®±ç«¯å£587</span></span><br><span class="line">        props.put(<span class="string">&quot;mail.smtp.port&quot;</span>, <span class="string">&quot;587&quot;</span>);</span><br><span class="line">        <span class="comment">// æ­¤å¤„å¡«å†™ï¼Œå†™ä¿¡äººçš„è´¦å·</span></span><br><span class="line">        props.put(<span class="string">&quot;mail.user&quot;</span>, <span class="string">&quot;1586385296@qq.com&quot;</span>);</span><br><span class="line">        <span class="comment">// æ­¤å¤„å¡«å†™16ä½STMPå£ä»¤</span></span><br><span class="line">        props.put(<span class="string">&quot;mail.password&quot;</span>, <span class="string">&quot;tXXXXXXXXXfgjb&quot;</span>);</span><br><span class="line">        <span class="comment">// æ„å»ºæˆæƒä¿¡æ¯ï¼Œç”¨äºè¿›è¡ŒSMTPè¿›è¡Œèº«ä»½éªŒè¯</span></span><br><span class="line">        <span class="type">Authenticator</span> <span class="variable">authenticator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Authenticator</span>() &#123;</span><br><span class="line">            <span class="keyword">protected</span> PasswordAuthentication <span class="title function_">getPasswordAuthentication</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// ç”¨æˆ·åã€å¯†ç </span></span><br><span class="line">                <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> props.getProperty(<span class="string">&quot;mail.user&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> props.getProperty(<span class="string">&quot;mail.password&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PasswordAuthentication</span>(userName, password);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ç¯å¢ƒå±æ€§å’Œæˆæƒä¿¡æ¯ï¼Œåˆ›å»ºé‚®ä»¶ä¼šè¯</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">mailSession</span> <span class="operator">=</span> Session.getInstance(props, authenticator);</span><br><span class="line">        <span class="comment">// åˆ›å»ºé‚®ä»¶æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(mailSession);</span><br><span class="line">        <span class="comment">// è®¾ç½®å‘ä»¶äºº</span></span><br><span class="line">        <span class="type">InternetAddress</span> <span class="variable">form</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(props.getProperty(<span class="string">&quot;mail.user&quot;</span>));</span><br><span class="line">        message.setFrom(form);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ”¶ä»¶äººçš„é‚®ç®±</span></span><br><span class="line">        <span class="type">InternetAddress</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(email);</span><br><span class="line">        message.setRecipient(RecipientType.TO, to);</span><br><span class="line">        <span class="comment">// è®¾ç½®é‚®ä»¶æ ‡é¢˜</span></span><br><span class="line">        message.setSubject(<span class="string">&quot;Kyle&#x27;s Blog é‚®ä»¶æµ‹è¯•&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®é‚®ä»¶çš„å†…å®¹ä½“</span></span><br><span class="line">        message.setContent(<span class="string">&quot;å°Šæ•¬çš„ç”¨æˆ·:ä½ å¥½!\næ³¨å†ŒéªŒè¯ç ä¸º:&quot;</span> + code + <span class="string">&quot;(æœ‰æ•ˆæœŸä¸ºä¸€åˆ†é’Ÿ,è¯·å‹¿å‘ŠçŸ¥ä»–äºº)&quot;</span>, <span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// æœ€åå½“ç„¶å°±æ˜¯å‘é€é‚®ä»¶å•¦</span></span><br><span class="line">        Transport.send(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">achieveCode</span><span class="params">()</span> &#123;  <span class="comment">//ç”±äºæ•°å­— 1 ã€ 0 å’Œå­—æ¯ O ã€l æœ‰æ—¶åˆ†ä¸æ¸…æ¥šï¼Œæ‰€ä»¥ï¼Œæ²¡æœ‰æ•°å­— 1 ã€ 0</span></span><br><span class="line">        String[] beforeShuffle = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;F&quot;</span>,</span><br><span class="line">                <span class="string">&quot;G&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;L&quot;</span>, <span class="string">&quot;M&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;O&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;R&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;U&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;W&quot;</span>, <span class="string">&quot;X&quot;</span>, <span class="string">&quot;Y&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;a&quot;</span>,</span><br><span class="line">                <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;g&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;m&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;v&quot;</span>,</span><br><span class="line">                <span class="string">&quot;w&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;z&quot;</span>&#125;;</span><br><span class="line">        List&lt;String&gt; list = Arrays.asList(beforeShuffle);<span class="comment">//å°†æ•°ç»„è½¬æ¢ä¸ºé›†åˆ</span></span><br><span class="line">        Collections.shuffle(list);  <span class="comment">//æ‰“ä¹±é›†åˆé¡ºåº</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">            sb.append(s); <span class="comment">//å°†é›†åˆè½¬åŒ–ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.substring(<span class="number">3</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹sendCodeæ–¹æ³•ï¼Œé€»è¾‘å¦‚ä¸‹</p>
<ul>
<li>
<p>éªŒè¯æ‰‹æœºå·/é‚®ç®±æ ¼å¼</p>
<ul>
<li>
<p>ä¸æ­£ç¡®åˆ™è¿”å›é”™è¯¯ä¿¡æ¯</p>
</li>
<li>
<p>æ­£ç¡®åˆ™å‘é€éªŒè¯ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å‘é€æ‰‹æœºéªŒè¯ç </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone, HttpSession session)</span> <span class="keyword">throws</span> MessagingException &#123;</span><br><span class="line">    <span class="comment">// TODO å‘é€çŸ­ä¿¡éªŒè¯ç å¹¶ä¿å­˜éªŒè¯ç </span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isEmailInvalid(phone)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> MailUtils.achieveCode();</span><br><span class="line">    session.setAttribute(phone, code);</span><br><span class="line">    log.info(<span class="string">&quot;å‘é€ç™»å½•éªŒè¯ç ï¼š&#123;&#125;&quot;</span>, code);</span><br><span class="line">    MailUtils.sendTestMail(phone, code);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç„¶åè¾“å…¥é‚®ç®±ï¼Œå‘é€éªŒè¯ç ï¼Œçœ‹çœ‹èƒ½å¦æ¥æ”¶åˆ°éªŒè¯ç </p>
</li>
<li>
<p>æµ‹è¯•æ²¡æœ‰é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­æ¥ç¼–å†™ç™»å½•åŠŸèƒ½ï¼Œç‚¹å‡»ç™»å½•æŒ‰é’®ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/user/login">http://localhost:8080/api/user/login</a><br>
è¯·æ±‚æ–¹æ³•: POST</p>
</blockquote>
</li>
<li>
<p>çœ‹æ ·å­æ˜¯UserControllerä¸­çš„loginæ–¹æ³•ï¼Œæºå¸¦çš„å‚æ•°ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é‚®ç®±å’ŒéªŒè¯ç </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>phone<span class="punctuation">:</span> <span class="string">&quot;1586385296@qq.com&quot;</span><span class="punctuation">,</span> code<span class="punctuation">:</span> <span class="string">&quot;iMPKc&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é»‘é©¬æä¾›çš„ä»£ç å¦‚ä¸‹ï¼Œçœ‹æ ·å­æ˜¯æŠŠé‚®ç®±å’ŒéªŒè¯ç å°è£…åˆ°äº†LoginFormDtoä¸­</p>
<ul>
<li>login</li>
<li>LoginFormDTO</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç™»å½•åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginForm ç™»å½•å‚æ•°ï¼ŒåŒ…å«æ‰‹æœºå·ã€éªŒè¯ç ï¼›æˆ–è€…æ‰‹æœºå·ã€å¯†ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginFormDTO loginForm, HttpSession session)</span>&#123;</span><br><span class="line">    <span class="comment">// TODO å®ç°ç™»å½•åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;åŠŸèƒ½æœªå®Œæˆ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹loginæ–¹æ³•ï¼Œé€»è¾‘å¦‚ä¸‹</p>
<ul>
<li>æ ¡éªŒæ‰‹æœºå·/é‚®ç®±
<ul>
<li>ä¸æ­£ç¡®åˆ™è¿”å›é”™è¯¯ä¿¡æ¯</li>
<li>æ­£ç¡®åˆ™ç»§ç»­æ ¡éªŒéªŒè¯ç 
<ul>
<li>ä¸ä¸€è‡´åˆ™æŠ¥é”™</li>
<li>ä¸€è‡´åˆ™å…ˆæ ¹æ®æ‰‹æœºå·/é‚®ç®±æŸ¥è¯¢ç”¨æˆ·
<ul>
<li>ç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»º</li>
<li>å­˜åœ¨åˆ™ç»§ç»­æ‰§è¡Œç¨‹åº</li>
</ul>
</li>
<li>ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>login</p>
</li>
<li>
<p>createUserWithPhone</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ç™»å½•åŠŸèƒ½</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> loginForm ç™»å½•å‚æ•°ï¼ŒåŒ…å«æ‰‹æœºå·ã€éªŒè¯ç ï¼›æˆ–è€…æ‰‹æœºå·ã€å¯†ç </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO å®ç°ç™»å½•åŠŸèƒ½</span></span><br><span class="line">    <span class="comment">//è·å–ç™»å½•è´¦å·</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">    <span class="comment">//è·å–ç™»å½•éªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line">    <span class="comment">//è·å–sessionä¸­çš„éªŒè¯ç </span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">cacheCode</span> <span class="operator">=</span> session.getAttribute(phone);</span><br><span class="line">	<span class="comment">//é­”æ³•å€¼ï¼šä¸šåŠ¡ä»£ç ä¸­ç›´æ¥å‡ºç°çš„å¸¸é‡ã€‚è¿™äº›å¸¸é‡è‡³å°‘è¦æ”¾åˆ°å…¨å±€å˜é‡ä¸­ï¼Œæˆ–è€…æšä¸¾ç±»ä¸­</span></span><br><span class="line">    <span class="comment">//1. æ ¡éªŒé‚®ç®±</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isEmailInvalid(phone)) &#123;</span><br><span class="line">        <span class="comment">//2. ä¸ç¬¦åˆæ ¼å¼åˆ™æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">    log.info(<span class="string">&quot;code:&#123;&#125;,cacheCode&#123;&#125;&quot;</span>, code, cacheCode);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">null</span> || !cacheCode.toString().equals(code)) &#123;</span><br><span class="line">        <span class="comment">//4. ä¸ä¸€è‡´åˆ™æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç ä¸ä¸€è‡´ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5. æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(User::getPhone, phone);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getOne(queryWrapper);</span><br><span class="line">    <span class="comment">//6. å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºçš„é€»è¾‘å°è£…æˆäº†ä¸€ä¸ªæ–¹æ³•</span></span><br><span class="line">        user = createUserWithPhone(phone);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½">å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½</h2>
<ul>
<li>
<p>è¿™éƒ¨åˆ†éœ€è¦ç”¨åˆ°æ‹¦æˆªå™¨çš„çŸ¥è¯†ï¼Œæˆ‘åœ¨å‰é¢çš„SSMæ•´åˆç¯‡åšè¿‡è¯¦ç»†ä»‹ç»</p>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6335135c16f2c2beb100182d.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6335135c16f2c2beb100182d.jpg" alt="img"></a></p>
<p>SSMæ•´åˆ</p>
<p><a target="_blank" rel="noopener" href="https://cyborg2077.github.io/2022/09/10/SSMIntegration/">https://cyborg2077.github.io/2022/09/10/SSMIntegration/</a></p>
</li>
<li>
<p>åˆ›å»ºä¸€ä¸ªLoginInterceptorç±»ï¼Œå®ç°HandlerInterceptoræ¥å£ï¼Œé‡å†™å…¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå‰ç½®æ‹¦æˆªå™¨å’Œå®Œæˆå¤„ç†æ–¹æ³•ï¼Œå‰ç½®æ‹¦æˆªå™¨ä¸»è¦ç”¨äºæˆ‘ä»¬ç™»é™†ä¹‹å‰çš„æƒé™æ ¡éªŒï¼Œå®Œæˆå¤„ç†æ–¹æ³•æ˜¯ç”¨äºå¤„ç†ç™»å½•åçš„ä¿¡æ¯ï¼Œé¿å…å†…å­˜æ³„éœ²</p>
</li>
<li>
<p>LoginInterceptor</p>
</li>
<li>
<p>UserHolder</p>
</li>
<li>
<p>MvcConfig</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1. è·å–session</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="comment">//2. è·å–sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">//3. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//4. ä¸å­˜åœ¨ï¼Œåˆ™æ‹¦æˆª</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5. å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocalï¼ŒUserHolderæ˜¯æä¾›å¥½äº†çš„å·¥å…·ç±»</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//6. æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å› ä¸ºThreadLocalåº•å±‚æ˜¯ThreadLocalMapï¼Œå½“æœŸçº¿ç¨‹Threadlocalä½œä¸ºkey(å¼±å¼•ç”¨)ï¼Œuserä½œä¸ºvalue(å¼ºå¼•ç”¨)ç„¶å</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>é¡ºä¾¿å†å†™ä¸€ä¸‹meæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/me&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">me</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// TODO è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(user);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œä¸€ç›´é‡å¤ç™»é™†å¯èƒ½æ˜¯å› ä¸ºè·¨åŸŸcookieæ— æ³•æºå¸¦çš„åŸå› ï¼Œé…ç½®ä¸€ä¸‹cookieçš„same-siteå°±è¡Œäº†</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯">éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</h2>
<ul>
<li>
<p>æˆ‘ä»¬é€šè¿‡æµè§ˆå™¨è§‚å¯Ÿåˆ°æ­¤æ—¶ç”¨æˆ·çš„å…¨éƒ¨ä¿¡æ¯éƒ½åœ¨ï¼Œè¿™æ ·æä¸ºä¸é è°±ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“åœ¨è¿”å›ç”¨æˆ·ä¿¡æ¯ä¹‹å‰ï¼Œå°†ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯è¿›è¡Œéšè—ï¼Œé‡‡ç”¨çš„æ ¸å¿ƒæ€è·¯å°±æ˜¯ä¹¦å†™ä¸€ä¸ªUserDtoå¯¹è±¡ï¼Œè¿™ä¸ªUserDtoå¯¹è±¡å°±æ²¡æœ‰æ•æ„Ÿä¿¡æ¯äº†ï¼Œæˆ‘ä»¬åœ¨è¿”å›å‰ï¼Œå°†æœ‰ç”¨æˆ·æ•æ„Ÿä¿¡æ¯çš„Userå¯¹è±¡è½¬åŒ–æˆæ²¡æœ‰æ•æ„Ÿä¿¡æ¯çš„UserDtoå¯¹è±¡ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿé¿å…è¿™ä¸ªå°´å°¬çš„é—®é¢˜äº†</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1010</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span><span class="string">&quot;1586385296@qq.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nickName&quot;</span><span class="punctuation">:</span><span class="string">&quot;user_i1b3ir09&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-10-22T14:20:33&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;updateTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-10-22T14:20:33&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>UserDtoç±»å¦‚ä¸‹ï¼Œå°†Userå¯¹è±¡ä¸­çš„å±æ€§æ‹·è´ç»™UserDtoï¼Œå°±å¯ä»¥é¿å…æš´éœ²ç”¨æˆ·çš„éšè—ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹UserHolderï¼Œå°†å…¶Userç±»å‹éƒ½æ¢ä¸ºUserDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;UserDTO&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(UserDTO user)</span>&#123;</span><br><span class="line">        tl.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserDTO <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeUser</span><span class="params">()</span>&#123;</span><br><span class="line">        tl.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹loginæ–¹æ³•</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   @PostMapping(&quot;/login&quot;)</span><br><span class="line">    public Result login(@RequestBody LoginFormDTO loginForm, HttpSession session) &#123;</span><br><span class="line">        // TODO å®ç°ç™»å½•åŠŸèƒ½</span><br><span class="line">        //è·å–ç™»å½•è´¦å·</span><br><span class="line">        String phone = loginForm.getPhone();</span><br><span class="line">        //è·å–ç™»å½•éªŒè¯ç </span><br><span class="line">        String code = loginForm.getCode();</span><br><span class="line">        //è·å–sessionä¸­çš„éªŒè¯ç </span><br><span class="line">        Object cacheCode = session.getAttribute(phone);</span><br><span class="line"></span><br><span class="line">        //1. æ ¡éªŒé‚®ç®±</span><br><span class="line">        if (RegexUtils.isEmailInvalid(phone)) &#123;</span><br><span class="line">            //2. ä¸ç¬¦åˆæ ¼å¼åˆ™æŠ¥é”™</span><br><span class="line">            return Result.fail(&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼ï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //3. æ ¡éªŒéªŒè¯ç </span><br><span class="line">        log.info(&quot;code:&#123;&#125;,cacheCode&#123;&#125;&quot;, code, cacheCode);</span><br><span class="line">        if (code == null || !cacheCode.toString().equals(code)) &#123;</span><br><span class="line">            //4. ä¸ä¸€è‡´åˆ™æŠ¥é”™</span><br><span class="line">            return Result.fail(&quot;éªŒè¯ç ä¸ä¸€è‡´ï¼ï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //5. æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(User::getPhone, phone);</span><br><span class="line">        User user = userService.getOne(queryWrapper);</span><br><span class="line">        //6. å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span><br><span class="line">        if (user == null) &#123;</span><br><span class="line">            user = createUserWithPhone(phone);</span><br><span class="line">        &#125;</span><br><span class="line">        //7. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­</span><br><span class="line"><span class="deletion">-       session.setAttribute(&quot;user&quot;, user);</span></span><br><span class="line"><span class="addition">+       UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);</span></span><br><span class="line"><span class="addition">+       session.setAttribute(&quot;user&quot;, userDTO);</span></span><br><span class="line">        return Result.ok();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹æ‹¦æˆªå™¨</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;</span><br><span class="line">        //1. è·å–session</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        //2. è·å–sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯</span><br><span class="line"><span class="deletion">-       User user = (User) session.getAttribute(&quot;user&quot;);</span></span><br><span class="line"><span class="addition">+       UserDTO user = (UserDTO) session.getAttribute(&quot;user&quot;);</span></span><br><span class="line">        //3. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br><span class="line">        if (user == null) &#123;</span><br><span class="line">            //4. ä¸å­˜åœ¨ï¼Œåˆ™æ‹¦æˆª</span><br><span class="line">            response.setStatus(401);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        //5. å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocalï¼ŒUserHolderæ˜¯æä¾›å¥½äº†çš„å·¥å…·ç±»</span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        //6. æ”¾è¡Œ</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡å¯æœåŠ¡å™¨ï¼Œç™»å½•åæŸ¥çœ‹æ­¤æ—¶çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ•æ„Ÿä¿¡æ¯å·²ç»ä¸å­˜åœ¨äº†</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1016</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nickName&quot;</span><span class="punctuation">:</span><span class="string">&quot;user_zkhf7cfv&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="sessionå…±äº«é—®é¢˜">sessionå…±äº«é—®é¢˜</h2>
<ul>
<li>æ¯ä¸ªtomcatä¸­éƒ½æœ‰ä¸€ä»½å±äºè‡ªå·±çš„session,å‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€å°tomcatï¼Œå¹¶ä¸”æŠŠè‡ªå·±çš„ä¿¡æ¯å­˜æ”¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨çš„sessionä¸­ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è¿™ä¸ªç”¨æˆ·è®¿é—®åˆ°äº†ç¬¬äºŒå°tomcatï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒå°æœåŠ¡å™¨ä¸Šï¼Œè‚¯å®šæ²¡æœ‰ç¬¬ä¸€å°æœåŠ¡å™¨å­˜æ”¾çš„sessionï¼Œæ‰€ä»¥æ­¤æ—¶ æ•´ä¸ªç™»å½•æ‹¦æˆªåŠŸèƒ½å°±ä¼šå‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬èƒ½å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæ—©æœŸçš„æ–¹æ¡ˆæ˜¯sessionæ‹·è´ï¼Œå°±æ˜¯è¯´è™½ç„¶æ¯ä¸ªtomcatä¸Šéƒ½æœ‰ä¸åŒçš„sessionï¼Œä½†æ˜¯æ¯å½“ä»»æ„ä¸€å°æœåŠ¡å™¨çš„sessionä¿®æ”¹æ—¶ï¼Œéƒ½ä¼šåŒæ­¥ç»™å…¶ä»–çš„TomcatæœåŠ¡å™¨çš„sessionï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°sessionçš„å…±äº«äº†</li>
<li>ä½†æ˜¯è¿™ç§æ–¹æ¡ˆå…·æœ‰ä¸¤ä¸ªå¤§é—®é¢˜
<ol>
<li>æ¯å°æœåŠ¡å™¨ä¸­éƒ½æœ‰å®Œæ•´çš„ä¸€ä»½sessionæ•°æ®ï¼ŒæœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚</li>
<li>sessionæ‹·è´æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å»¶è¿Ÿ</li>
</ol>
</li>
<li>æ‰€ä»¥æˆ‘ä»¬åé¢éƒ½æ˜¯åŸºäºRedisæ¥å®Œæˆï¼Œæˆ‘ä»¬æŠŠsessionæ¢æˆRedisï¼ŒRedisæ•°æ®æœ¬èº«å°±æ˜¯å…±äº«çš„ï¼Œå°±å¯ä»¥é¿å…sessionå…±äº«çš„é—®é¢˜äº†</li>
</ul>
<h2 id="Redisæ›¿ä»£sessionçš„ä¸šåŠ¡æµç¨‹">Redisæ›¿ä»£sessionçš„ä¸šåŠ¡æµç¨‹</h2>
<h3 id="è®¾è®¡keyç»“æ„">è®¾è®¡keyç»“æ„</h3>
<ul>
<li>é¦–å…ˆæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹è¯¥ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„æ¥å­˜å‚¨æ•°æ®</li>
<li>ç”±äºå­˜å…¥çš„æ•°æ®æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Stringæˆ–è€…Hash
<ul>
<li>å¦‚æœä½¿ç”¨Stringï¼Œä»¥JSONå­—ç¬¦ä¸²æ¥ä¿å­˜æ•°æ®ï¼Œä¼šé¢å¤–å ç”¨éƒ¨åˆ†ç©ºé—´</li>
<li>å¦‚æœä½¿ç”¨Hashï¼Œåˆ™å®ƒçš„valueä¸­åªä¼šå­˜å‚¨æ•°æ®æœ¬èº«</li>
</ul>
</li>
<li>å¦‚æœä¸æ˜¯ç‰¹åˆ«åœ¨æ„å†…å­˜ï¼Œç›´æ¥ä½¿ç”¨Stringå°±å¥½äº†</li>
</ul>
<h3 id="è®¾è®¡keyçš„å…·ä½“ç»†èŠ‚">è®¾è®¡keyçš„å…·ä½“ç»†èŠ‚</h3>
<ul>
<li>æˆ‘ä»¬è¿™é‡Œå°±é‡‡ç”¨çš„æ˜¯ç®€å•çš„K-Vé”®å€¼å¯¹æ–¹å¼</li>
<li>ä½†æ˜¯å¯¹äºkeyçš„å¤„ç†ï¼Œä¸èƒ½åƒsessionä¸€æ ·ç”¨phoneæˆ–codeæ¥å½“åškey</li>
<li>å› ä¸ºRedisçš„keyæ˜¯å…±äº«çš„ï¼Œcodeå¯èƒ½ä¼šé‡å¤ï¼Œphoneè¿™ç§æ•æ„Ÿå­—æ®µä¹Ÿä¸é€‚åˆå­˜å‚¨åˆ°Redisä¸­</li>
<li>åœ¨è®¾è®¡keyçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ»¡è¶³ä¸¤ç‚¹
<ol>
<li>keyè¦æœ‰å”¯ä¸€æ€§</li>
<li>keyè¦æ–¹ä¾¿æºå¸¦</li>
</ol>
</li>
<li>æ‰€ä»¥æˆ‘ä»¬åœ¨åå°éšæœºç”Ÿæˆä¸€ä¸ªtokenï¼Œç„¶åè®©å‰ç«¯å¸¦ç€è¿™ä¸ªtokenå°±èƒ½å®Œæˆæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘äº†</li>
<li>Stringä¿æŠ¤ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯, å¯ä»¥ä½¿ç”¨Stringç»“æ„, ä»¥JSONå­—ç¬¦ä¸²æ¥ä¿å­˜, æ¯”è¾ƒç›´è§‚.</li>
<li>Hashç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨, å¯ä»¥é’ˆå¯¹å•ä¸ªå­—æ®µåšCRUD, å¹¶ä¸”å†…å­˜å ç”¨æ›´å°‘; æ¯”è¾ƒæ¨èHashç»“æ„.</li>
</ul>
<h3 id="æ•´ä½“è®¿é—®æµç¨‹">æ•´ä½“è®¿é—®æµç¨‹</h3>
<ul>
<li>å½“æ³¨å†Œå®Œæˆåï¼Œç”¨æˆ·å»ç™»å½•ï¼Œç„¶åæ ¡éªŒç”¨æˆ·æäº¤çš„æ‰‹æœºå·/é‚®ç®±å’ŒéªŒè¯ç æ˜¯å¦ä¸€è‡´
<ul>
<li>å¦‚æœä¸€è‡´ï¼Œåˆ™æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºï¼Œæœ€åå°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°Redisï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªtokenä½œä¸ºRedisçš„key</li>
</ul>
</li>
<li>å½“æˆ‘ä»¬æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•æ—¶ï¼Œå›å»æºå¸¦ç€tokenè¿›è¡Œè®¿é—®ï¼Œä»Redisä¸­è·å–tokenå¯¹åº”çš„valueï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ•°æ®
<ul>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ‹¦æˆª</li>
<li>å¦‚æœå­˜åœ¨ï¼Œåˆ™å°†å…¶ç”¨æˆ·ä¿¡æ¯(userDto)ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶æ”¾è¡Œ</li>
</ul>
</li>
</ul>
<h2 id="åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•">åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</h2>
<ul>
<li>
<p>ç”±äºå‰é¢å·²ç»åˆ†æè¿‡ä¸šåŠ¡é€»è¾‘äº†ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¼€å§‹å†™ä»£ç ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘ä»¬è¦åœ¨UserControllerä¸­æ³¨å…¥</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">StringRedisTemplate</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹sendCodeæ–¹æ³•</p>
<ul>
<li>ä¿®æ”¹sendCodeæ–¹æ³•</li>
<li>RedisConstants</li>
</ul>
<p>è¿™é‡Œçš„keyä½¿ç”¨ç”¨<code>login:code:email</code>çš„å½¢å¼ï¼Œå¹¶è®¾ç½®æœ‰æ•ˆæœŸ2åˆ†é’Ÿï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªå¸¸é‡ç±»æ¥æ›¿æ¢è¿™é‡Œçš„<code>login:code:</code>å’Œ<code>2</code>ï¼Œè®©ä»£ç æ˜¾å¾—æ›´ä¸“ä¸šä¸€ç‚¹</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/code&quot;)</span><br><span class="line">public Result sendCode(@RequestParam(&quot;phone&quot;) String phone, HttpSession session) throws MessagingException &#123;</span><br><span class="line">    // TODO å‘é€çŸ­ä¿¡éªŒè¯ç å¹¶ä¿å­˜éªŒè¯ç </span><br><span class="line">    if (RegexUtils.isEmailInvalid(phone)) &#123;</span><br><span class="line">        return Result.fail(&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    String code = MailUtils.achieveCode();</span><br><span class="line"><span class="deletion">-   session.setAttribute(phone, code);</span></span><br><span class="line"><span class="deletion">-   stringRedisTemplate.opsForValue().set(&quot;login:code:&quot; + phone, code, 2, TimeUnit.MINUTES);</span></span><br><span class="line"><span class="addition">+   stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY + phone, code, LOGIN_CODE_TTL, TimeUnit.MINUTES);</span></span><br><span class="line">    log.info(&quot;å‘é€ç™»å½•éªŒè¯ç ï¼š&#123;&#125;&quot;, code);</span><br><span class="line">//        MailUtils.sendTestMail(phone, code);</span><br><span class="line">    return Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹loginæ–¹æ³•</p>
<ul>
<li>DIFF</li>
<li>ä¿®æ”¹åä»£ç </li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">    @PostMapping(&quot;/login&quot;)</span><br><span class="line">    public Result login(@RequestBody LoginFormDTO loginForm, HttpSession session) &#123;</span><br><span class="line">        // TODO å®ç°ç™»å½•åŠŸèƒ½</span><br><span class="line">        //è·å–ç™»å½•è´¦å·</span><br><span class="line">        String phone = loginForm.getPhone();</span><br><span class="line">        //è·å–ç™»å½•éªŒè¯ç </span><br><span class="line">        String code = loginForm.getCode();</span><br><span class="line"><span class="deletion">-       //è·å–sessionä¸­çš„éªŒè¯ç </span></span><br><span class="line"><span class="deletion">-       Object cacheCode = session.getAttribute(phone);</span></span><br><span class="line"><span class="addition">+       //è·å–redisä¸­çš„éªŒè¯ç </span></span><br><span class="line"><span class="addition">+       String sessionCode = stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + userCode);</span></span><br><span class="line">        //1. æ ¡éªŒé‚®ç®±</span><br><span class="line">        if (RegexUtils.isEmailInvalid(phone)) &#123;</span><br><span class="line">            //2. ä¸ç¬¦åˆæ ¼å¼åˆ™æŠ¥é”™</span><br><span class="line">            return Result.fail(&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼ï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //3. æ ¡éªŒéªŒè¯ç </span><br><span class="line">        log.info(&quot;code:&#123;&#125;,cacheCode&#123;&#125;&quot;, code, cacheCode);</span><br><span class="line">        if (code == null || !cacheCode.toString().equals(code)) &#123;</span><br><span class="line">            //4. ä¸ä¸€è‡´åˆ™æŠ¥é”™</span><br><span class="line">            return Result.fail(&quot;éªŒè¯ç ä¸ä¸€è‡´ï¼ï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //5. æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(User::getPhone, phone);</span><br><span class="line">        User user = userService.getOne(queryWrapper);</span><br><span class="line">        //6. å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span><br><span class="line">        if (user == null) &#123;</span><br><span class="line">            user = createUserWithPhone(phone);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="deletion">-       //7. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­</span></span><br><span class="line"><span class="addition">+       //7. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Redisä¸­</span></span><br><span class="line"><span class="addition">+       //7.1 éšæœºç”Ÿæˆtokenï¼Œä½œä¸ºç™»å½•ä»¤ç‰Œ</span></span><br><span class="line"><span class="addition">+       String token = UUID.randomUUID().toString();</span></span><br><span class="line"><span class="addition">+       //7.2 å°†UserDtoå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨</span></span><br><span class="line"><span class="addition">+       UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);</span></span><br><span class="line"><span class="addition">+       HashMap&lt;String, String &gt; userMap = new HashMap&lt;&gt;(); æˆ–</span></span><br><span class="line"><span class="addition">+     	 Map&lt;String, Object&gt; UserMap = BeanUtil.beanToMap(userDTO,new HashMap&lt;&gt;(),CopyOptions.create().setIgnoreNullValue(true).    setFieldValueEditor((fieldName,fieldValue) -&gt; fieldValue.toString()));</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+       userMap.put(&quot;icon&quot;, userDTO.getIcon());</span></span><br><span class="line"><span class="addition">+       userMap.put(&quot;id&quot;, String.valueOf(userDTO.getId()));</span></span><br><span class="line"><span class="addition">+       userMap.put(&quot;nickName&quot;, userDTO.getNickName(    ));</span></span><br><span class="line"><span class="addition">+       //7.3 å­˜å‚¨</span></span><br><span class="line"><span class="addition">+       String tokenKey = LOGIN_USER_KEY + token;</span></span><br><span class="line"><span class="addition">+       stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);</span></span><br><span class="line">        // è¿™é‡Œä¼šæŠ¥é”™, å› ä¸ºstirngRedisTemplate æ‰€éœ€è¦çš„ç±»å‹å¿…é¡»å…¨éƒ¨ä¸ºStringç±»å‹, è€Œæˆ‘ä»¬ä¸­çš„UserMapä¸­æœ‰ä¸€ä¸ªLongç±»å‹çš„Id,</span><br><span class="line"></span><br><span class="line"><span class="addition">+       //7.4 è®¾ç½®tokenæœ‰æ•ˆæœŸä¸º30åˆ†é’Ÿ</span></span><br><span class="line"><span class="addition">+       stringRedisTemplate.expire(tokenKey, 30, TimeUnit.MINUTES);</span></span><br><span class="line"><span class="addition">+       //7.5 ç™»é™†æˆåŠŸåˆ™åˆ é™¤éªŒè¯ç ä¿¡æ¯</span></span><br><span class="line"><span class="addition">+       stringRedisTemplate.delete(LOGIN_CODE_KEY + phone);</span></span><br><span class="line"><span class="deletion">-       session.setAttribute(&quot;user&quot;, userDTO);</span></span><br><span class="line"><span class="addition">+       //8. è¿”å›token</span></span><br><span class="line"><span class="addition">+       return Result.ok(token);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜">è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</h2>
<h3 id="åˆå§‹æ–¹æ¡ˆ">åˆå§‹æ–¹æ¡ˆ</h3>
<ul>
<li>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨æ‹¦æˆªåˆ°çš„è¯·æ±‚ï¼Œæ¥è¯æ˜ç”¨æˆ·æ˜¯å¦åœ¨æ“ä½œï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä»»ä½•æ“ä½œ30åˆ†é’Ÿï¼Œåˆ™tokenä¼šæ¶ˆå¤±ï¼Œç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•</p>
</li>
<li>
<p>é€šè¿‡æŸ¥çœ‹è¯·æ±‚ï¼Œæˆ‘ä»¬å‘ç°æˆ‘ä»¬å­˜çš„tokenåœ¨è¯·æ±‚å¤´é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åœ¨æ‹¦æˆªå™¨é‡Œæ¥åˆ·æ–°tokençš„å­˜æ´»æ—¶é—´</p>
<blockquote>
<p>authorization: 6867061d-a8d0-4e60-b92f-97f7d698a1ca</p>
</blockquote>
</li>
<li>
<p>ä¿®æ”¹æˆ‘ä»¬çš„ç™»é™†æ‹¦æˆªå™¨<code>LoginInterceptor</code>ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//1. è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">    <span class="comment">//2. å¦‚æœtokenæ˜¯ç©ºï¼Œåˆ™æœªç™»å½•ï¼Œæ‹¦æˆª</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">        response.setStatus(<span class="number">401</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.LOGIN_USER_KEY + token;</span><br><span class="line">    <span class="comment">//3. åŸºäºtokenè·å–Redisä¸­çš„ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™æ‹¦æˆª</span></span><br><span class="line">    <span class="keyword">if</span> (userMap.isEmpty()) &#123;</span><br><span class="line">        response.setStatus(<span class="number">401</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5. å°†æŸ¥è¯¢åˆ°çš„Hashæ•°æ®è½¬åŒ–ä¸ºUserDtoå¯¹è±¡</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> <span class="title class_">UserDTO</span>(), <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//6. å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°ThreadLocal</span></span><br><span class="line">    UserHolder.saveUser(userDTO);</span><br><span class="line">    <span class="comment">//7. åˆ·æ–°tokenTTLï¼Œè¿™é‡Œçš„å­˜æ´»æ—¶é—´æ ¹æ®éœ€è¦è‡ªå·±è®¾ç½®ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æˆ‘æ”¹ä¸ºäº†30åˆ†é’Ÿ</span></span><br><span class="line">    stringRedisTemplate.expire(key, RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œä»–ç¡®å®å¯ä»¥ä½¿ç”¨å¯¹åº”è·¯å¾„çš„æ‹¦æˆªï¼ŒåŒæ—¶åˆ·æ–°ç™»å½•tokenä»¤ç‰Œçš„å­˜æ´»æ—¶é—´ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä»–åªæ˜¯æ‹¦æˆªéœ€è¦è¢«æ‹¦æˆªçš„è·¯å¾„ï¼Œå‡è®¾å½“å‰ç”¨æˆ·è®¿é—®äº†ä¸€äº›ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‹¦æˆªå™¨å°±ä¸ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥æ­¤æ—¶ä»¤ç‰Œåˆ·æ–°çš„åŠ¨ä½œå®é™…ä¸Šå°±ä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆä»–æ˜¯å­˜åœ¨é—®é¢˜çš„</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6353edd016f2c2beb1f967f0.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6353edd016f2c2beb1f967f0.jpg" alt="img"></a></p>
<h3 id="ä¼˜åŒ–æ–¹æ¡ˆ">ä¼˜åŒ–æ–¹æ¡ˆ</h3>
<ul>
<li>æ—¢ç„¶ä¹‹å‰çš„æ‹¦æˆªå™¨æ— æ³•å¯¹ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ‹¦æˆªæ‰€æœ‰çš„è·¯å¾„ï¼ŒæŠŠç¬¬äºŒä¸ªæ‹¦æˆªå™¨åšçš„äº‹æƒ…æ”¾å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼ŒåŒæ—¶åˆ·æ–°ä»¤ç‰Œï¼Œå› ä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æœ‰äº†threadLocalçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶ç¬¬äºŒä¸ªæ‹¦æˆªå™¨åªéœ€è¦åˆ¤æ–­æ‹¦æˆªå™¨ä¸­çš„userå¯¹è±¡æ˜¯å¦å­˜åœ¨å³å¯ï¼Œå®Œæˆæ•´ä½“åˆ·æ–°åŠŸèƒ½ã€‚</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6353ef1416f2c2beb1fb5e48.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6353ef1416f2c2beb1fb5e48.jpg" alt="img"></a></p>
<ul>
<li>
<p>æ–°å»ºä¸€ä¸ª</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">RefreshTokenInterceptor</span></span><br></pre></td></tr></table></figure>
<p>ç±»ï¼Œå…¶ä¸šåŠ¡é€»è¾‘ä¸ä¹‹å‰çš„</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">LoginInterceptor</span></span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼ï¼Œå°±ç®—é‡åˆ°ç”¨æˆ·æœªç™»å½•ï¼Œä¹Ÿç»§ç»­æ”¾è¡Œï¼Œäº¤ç»™</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">LoginInterceptor</span></span><br></pre></td></tr></table></figure>
<p>å¤„ç†</p>
<p>ç”±äºè¿™ä¸ªå¯¹è±¡æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åœ¨WebConfigé‡Œåˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ç”¨@AutoWiredè‡ªåŠ¨è£…é…ï¼Œåªèƒ½å£°æ˜ä¸€ä¸ªç§æœ‰çš„ï¼Œåˆ°äº†WebConfigé‡Œå†è‡ªåŠ¨è£…é…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå¹¶ä¸æ˜¯è‡ªåŠ¨è£…é…ï¼Œå› ä¸ºRefreshTokenInterceptoræ˜¯æˆ‘ä»¬æ‰‹åŠ¨åœ¨WebConfigé‡Œnewå‡ºæ¥çš„</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTokenInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1. è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//2. å¦‚æœtokenæ˜¯ç©ºï¼Œç›´æ¥æ”¾è¡Œï¼Œäº¤ç»™LoginInterceptorå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.LOGIN_USER_KEY + token;</span><br><span class="line">        <span class="comment">//3. åŸºäºtokenè·å–Redisä¸­çš„ç”¨æˆ·æ•°æ®</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œä¹Ÿæ”¾è¡Œï¼Œäº¤ç»™LoginInterceptor</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5. å°†æŸ¥è¯¢åˆ°çš„Hashæ•°æ®è½¬åŒ–ä¸ºUserDtoå¯¹è±¡</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> <span class="title class_">UserDTO</span>(), <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//6. å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">//7. åˆ·æ–°tokenTTLï¼Œè¿™é‡Œçš„å­˜æ´»æ—¶é—´æ ¹æ®éœ€è¦è‡ªå·±è®¾ç½®ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æˆ‘æ”¹ä¸ºäº†30åˆ†é’Ÿ</span></span><br><span class="line">        stringRedisTemplate.expire(key, RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹æˆ‘ä»¬ä¹‹å‰çš„</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">LoginInterceptor</span></span><br></pre></td></tr></table></figure>
<p>ç±»ï¼Œåªéœ€è¦åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™æ‹¦æˆªï¼Œå­˜åœ¨åˆ™æ”¾è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (UserHolder.getUser()==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//ä¸å­˜åœ¨åˆ™æ‹¦æˆª</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å­˜åœ¨åˆ™æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">WebConfig</span></span><br></pre></td></tr></table></figure>
<p>é…ç½®ç±»ï¼Œæ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºå¯ä»¥ç”±orderæ¥æŒ‡å®šï¼Œå¦‚æœæœªè®¾ç½®æ‹¦æˆªè·¯å¾„ï¼Œåˆ™é»˜è®¤æ˜¯æ‹¦æˆªæ‰€æœ‰è·¯å¾„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ°äº†è¿™é‡Œæ‰èƒ½è‡ªåŠ¨è£…é…</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                ).order(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//RefreshTokenInterceptoræ˜¯æˆ‘ä»¬æ‰‹åŠ¨newå‡ºæ¥çš„</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).order(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£ä¹ˆè‡³æ­¤ï¼Œå¤§åŠŸå‘Šæˆï¼Œæˆ‘ä»¬é‡å¯æœåŠ¡å™¨ï¼Œç™»å½•ï¼Œç„¶åå»Redisçš„å›¾å½¢åŒ–ç•Œé¢æŸ¥çœ‹tokençš„ttlï¼Œå¦‚æœæ¯æ¬¡åˆ‡æ¢ç•Œé¢ä¹‹åï¼Œttléƒ½ä¼šé‡ç½®ï¼Œé‚£ä¹ˆè¯´æ˜æˆ‘ä»¬çš„ä»£ç æ²¡æœ‰é—®é¢˜</p>
</li>
</ul>
<h1>å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h1>
<h2 id="ä»€ä¹ˆæ˜¯ç¼“å­˜">ä»€ä¹ˆæ˜¯ç¼“å­˜</h2>
<ul>
<li>
<p>ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ</p>
<ul>
<li>ç¼“å­˜å°±åƒè‡ªè¡Œè½¦ã€è¶Šé‡è½¦çš„é¿éœ‡å™¨</li>
</ul>
</li>
<li>
<p>ä¸¾ä¸ªä¾‹å­</p>
<ul>
<li>è¶Šé‡è½¦ã€å±±åœ°è‡ªè¡Œè½¦éƒ½æœ‰<code>é¿éœ‡å™¨</code>ï¼Œé˜²æ­¢è½¦ä½“åŠ é€Ÿä¹‹åå› æƒ¯æ€§ï¼Œåœ¨<code>U</code>å‹åœ°å½¢ä¸Šé£è·ƒç¡¬ç€é™†å¯¼è‡´<code>æŸå</code>ï¼Œåƒä¸ªå¼¹ç°§æ„ä¹‰</li>
</ul>
</li>
<li>
<p>åŒæ ·ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œç³»ç»Ÿä¹Ÿéœ€è¦<code>é¿éœ‡å™¨</code>ï¼Œé˜²æ­¢è¿‡é«˜çš„æ•°æ®é‡çŒ›å†²ç³»ç»Ÿï¼Œå¯¼è‡´å…¶æ“ä½œçº¿ç¨‹æ— æ³•åŠæ—¶å¤„ç†ä¿¡æ¯è€Œç˜«ç—ª</p>
</li>
<li>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯¹ä¼ä¸šæ¥è®²ï¼Œäº§å“å£ç¢‘ã€ç”¨æˆ·è¯„ä»·éƒ½æ˜¯è‡´å‘½çš„ï¼Œæ‰€ä»¥ä¼ä¸šéå¸¸é‡è§†ç¼“å­˜æŠ€æœ¯</p>
</li>
<li>
<pre><code>ç¼“å­˜
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">(Cache)</span>å°±æ˜¯æ•°æ®äº¤æ¢çš„</span><br><span class="line"></span><br></pre></td></tr></table></figure>
ç¼“å†²åŒº
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ï¼Œä¿—ç§°çš„ç¼“å­˜å°±æ˜¯ç¼“å†²åŒºå†…çš„æ•°æ®ï¼Œä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–ï¼Œå­˜å‚¨äºæœ¬åœ°ï¼Œä¾‹å¦‚</span><br><span class="line"></span><br><span class="line">- æœ¬åœ°ç”¨é«˜å¹¶å‘</span><br><span class="line">- ç”¨äºRedisç­‰ç¼“å­˜</span><br><span class="line">- æœ¬åœ°ç¼“å­˜</span><br><span class="line"></span><br><span class="line">```JAVA</span><br><span class="line">Static <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>



</code></pre>
</li>
<li>
<p>ç”±äºå…¶è¢«<code>static</code>ä¿®é¥°ï¼Œæ‰€ä»¥éšç€ç±»çš„åŠ è½½è€ŒåŠ è½½åˆ°å†…å­˜ä¹‹ä¸­ï¼Œä½œä¸ºæœ¬åœ°ç¼“å­˜ï¼Œç”±äºå…¶åˆè¢«<code>final</code>ä¿®é¥°ï¼Œæ‰€ä»¥å…¶å¼•ç”¨ä¹‹é—´çš„å…³ç³»æ˜¯å›ºå®šçš„ï¼Œä¸èƒ½æ”¹å˜ï¼Œå› æ­¤ä¸ç”¨æ‹…å¿ƒå¤åˆ¶å¯¼è‡´ç¼“å­˜å¤±è´¥</p>
</li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜</h3>
<ul>
<li>
<p>è¨€ç®€æ„èµ…ï¼šé€Ÿåº¦å¿«ï¼Œå¥½ç”¨</p>
</li>
<li>
<p>ç¼“å­˜æ•°æ®å­˜å‚¨äºä»£ç ä¸­ï¼Œè€Œä»£ç è¿è¡Œåœ¨å†…å­˜ä¸­ï¼Œå†…å­˜çš„è¯»å†™æ€§èƒ½è¿œé«˜äºç£ç›˜ï¼Œç¼“å­˜å¯ä»¥å¤§å¤§é™ä½ç”¨æˆ·è®¿é—®å¹¶å‘é‡å¸¦æ¥çš„æœåŠ¡å™¨è¯»å†™å‹åŠ›</p>
</li>
<li>
<p>å®é™…å¼€å‘ä¸­ï¼Œä¼ä¸šçš„æ•°æ®é‡ï¼Œå°‘åˆ™å‡ åä¸‡ï¼Œå¤šåˆ™å‡ åƒä¸‡ï¼Œè¿™ä¹ˆå¤§çš„æ•°æ®é‡ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜æ¥ä½œä¸º<code>é¿éœ‡å™¨</code>ç³»ç»Ÿæ˜¯å‡ ä¹æ’‘ä¸ä½çš„ï¼Œæ‰€ä»¥ä¼ä¸šä¼šå¤§é‡è¿ç”¨ç¼“å­˜æŠ€æœ¯</p>
</li>
<li>
<p>ä½†æ˜¯ç¼“å­˜ä¹Ÿä¼šå¢åŠ ä»£ç å¤æ‚åº¦å’Œè¿è¥æˆæœ¬</p>
</li>
<li>
<pre><code>ç¼“å­˜çš„ä½œç”¨
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  1.</span> é™ä½åç«¯è´Ÿè½½</span><br><span class="line"><span class="bullet">  2.</span> æé«˜è¯»å†™æ•ˆç‡ï¼Œé™ä½å“åº”æ—¶é—´</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">```</span></span><br><span class="line"><span class="code">  ç¼“å­˜çš„æˆæœ¬</span></span><br></pre></td></tr></table></figure>

1. æ•°æ®ä¸€è‡´æ€§æˆæœ¬
2. ä»£ç ç»´æŠ¤æˆæœ¬
3. è¿ç»´æˆæœ¬ï¼ˆä¸€èˆ¬é‡‡ç”¨æœåŠ¡å™¨é›†ç¾¤ï¼Œéœ€è¦å¤šåŠ æœºå™¨ï¼Œæœºå™¨å°±æ˜¯é’±ï¼‰

</code></pre>
</li>
</ul>
<h3 id="å¦‚ä½•ä½¿ç”¨ç¼“å­˜">å¦‚ä½•ä½¿ç”¨ç¼“å­˜</h3>
<ul>
<li>å®é™…å¼€å‘ä¸­ï¼Œä¼šæ„ç­‘å¤šçº§ç¼“å­˜æ¥æ—¶ç³»ç»Ÿè¿è¡Œé€Ÿåº¦è¿›ä¸€æ­¥æå‡ï¼Œä¾‹å¦‚ï¼šæœ¬åœ°ç¼“å­˜ä¸Redisä¸­çš„ç¼“å­˜å¹¶å‘ä½¿ç”¨</li>
<li><code>æµè§ˆå™¨ç¼“å­˜ï¼š</code>ä¸»è¦æ˜¯å­˜åœ¨äºæµè§ˆå™¨ç«¯çš„ç¼“å­˜</li>
<li><code>åº”ç”¨å±‚ç¼“å­˜ï¼š</code>å¯ä»¥åˆ†ä¸ºtoncatæœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚ä¹‹å‰æåˆ°çš„mapæˆ–è€…æ˜¯ä½¿ç”¨Redisä½œä¸ºç¼“å­˜</li>
<li><code>æ•°æ®åº“ç¼“å­˜ï¼š</code>åœ¨æ•°æ®åº“ä¸­æœ‰ä¸€ç‰‡ç©ºé—´æ˜¯buffer poolï¼Œå¢æ”¹æŸ¥æ•°æ®éƒ½ä¼šå…ˆåŠ è½½åˆ°mysqlçš„ç¼“å­˜ä¸­</li>
<li><code>CPUç¼“å­˜ï¼š</code>å½“ä»£è®¡ç®—æœºæœ€å¤§çš„é—®é¢˜å°±æ˜¯CPUæ€§èƒ½æå‡äº†ï¼Œä½†æ˜¯å†…å­˜è¯»å†™é€Ÿåº¦æ²¡æœ‰è·Ÿä¸Šï¼Œæ‰€ä»¥ä¸ºäº†é€‚åº”å½“ä¸‹çš„æƒ…å†µï¼Œå¢åŠ äº†CPUçš„L1ï¼ŒL2ï¼ŒL3çº§çš„ç¼“å­˜</li>
</ul>
<h2 id="æ·»åŠ å•†æˆ·ç¼“å­˜">æ·»åŠ å•†æˆ·ç¼“å­˜</h2>
<ul>
<li>
<p>æˆ‘ä»¬å…ˆå¯åŠ¨å‰ç«¯å’Œåç«¯çš„é¡¹ç›®ï¼Œç™»é™†ä¹‹åéšä¾¿è®¿é—®ä¸€ä¸ªå•†æˆ·ï¼ŒæŸ¥çœ‹æµè§ˆå™¨å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/shop/10">http://localhost:8080/api/shop/10</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>ä¸å‡ºæ„å¤–æ˜¯<code>ShopController</code>é‡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸”restFulé£æ ¼çš„</p>
</li>
<li>
<p>åœ¨æˆ‘ä»¬æŸ¥è¯¢å•†æˆ·ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥æ“ä½œä»æ•°æ®åº“ä¸­å»è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œå¤§è‡´é€»è¾‘æ˜¯è¿™æ ·ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“è‚¯å®šæ…¢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ®idæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id å•†é“ºid</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> å•†é“ºè¯¦æƒ…æ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shopService.getById(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸æ•°æ®åº“ä¹‹é—´åŠ ä¸Šä¸€ä¸ªRedisç¼“å­˜ï¼Œå…ˆä»Redisä¸­æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰æŸ¥åˆ°ï¼Œå†å»MySQLä¸­æŸ¥è¯¢ï¼ŒåŒæ—¶æŸ¥è¯¢å®Œæ¯•ä¹‹åï¼Œå°†æŸ¥è¯¢åˆ°çš„æ•°æ®ä¹Ÿå­˜å…¥Redisï¼Œè¿™æ ·å½“ä¸‹ä¸€ä¸ªç”¨æˆ·æ¥è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥ä»Redisä¸­è·å–åˆ°æ•°æ®</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354a19216f2c2beb1b095dd.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354a19216f2c2beb1b095dd.jpg" alt="img"></a></p>
<h3 id="ç¼“å­˜æ¨¡å‹å’Œæ€è·¯">ç¼“å­˜æ¨¡å‹å’Œæ€è·¯</h3>
<ul>
<li>æ ‡å‡†çš„æ“ä½œæ–¹å¼å°±æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥Redisã€‚<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354a1aa16f2c2beb1b0aa83.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354a1aa16f2c2beb1b0aa83.jpg" alt="img"></a></li>
</ul>
<h3 id="ä»£ç å®ç°">ä»£ç å®ç°</h3>
<ul>
<li>
<p>ä»£ç æ€è·¯ï¼šå¦‚æœRedisç¼“å­˜é‡Œæœ‰æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå­˜å…¥Redis</p>
<ul>
<li>Controllerå±‚</li>
<li>Servieå±‚</li>
<li>ServieImplå±‚</li>
</ul>
<p>ä¸šåŠ¡é€»è¾‘æˆ‘ä»¬å†™åˆ°Serviceä¸­ï¼Œéœ€è¦åœ¨Serviceå±‚åˆ›å»ºè¿™ä¸ª<code>queryById</code>æ–¹æ³•ï¼Œç„¶åå»ServiceImplä¸­å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡å¯æœåŠ¡å™¨ï¼Œè®¿é—®å•†æˆ·ä¿¡æ¯ï¼Œè§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—è¾“å‡ºï¼Œåç»­åˆ·æ–°é¡µé¢ï¼Œä¸ä¼šå‡ºç°SQLè¯­å¥æŸ¥è¯¢å•†æˆ·ä¿¡æ¯ï¼Œå»Rediså›¾å½¢åŒ–ç•Œé¢ä¸­æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ç¼“å­˜çš„å•†æˆ·ä¿¡æ¯æ•°æ®</p>
</li>
</ul>
<h3 id="è¶çƒ­æ‰“é“">è¶çƒ­æ‰“é“</h3>
<ul>
<li>
<p>å®Œæˆäº†å•†æˆ·æ•°æ®ç¼“å­˜ä¹‹åï¼Œæˆ‘ä»¬å°è¯•åšä¸€ä¸‹å•†æˆ·ç±»å‹æ•°æ®ç¼“å­˜</p>
<ul>
<li>Controllerå±‚</li>
<li>Serviceå±‚</li>
<li>ServiceImplå±‚</li>
</ul>
<p>ä¸šåŠ¡é€»è¾‘ä¾æ—§æ˜¯å†™åœ¨Serviceä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryTypeList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> typeService.queryList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é¦–é¡µåˆ—è¡¨ç¼“å­˜-P37">é¦–é¡µåˆ—è¡¨ç¼“å­˜(P37)</h3>
<p>é¦–é¡µçš„è¿™å—åˆ—è¡¨ä¿¡æ¯æ˜¯ä¸å˜åŠ¨çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å®ƒå­˜å…¥ç¼“å­˜ä¸­ï¼Œé¿å…æ¯æ¬¡è®¿é—®æ—¶éƒ½å»æŸ¥è¯¢æ•°æ®åº“</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d88488e761f74925a19320dd8936cb18.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id=""></h4>
</li>
</ul>
<p>å‰ç«¯å‘é€çš„è¯·æ±‚<br>
è¯·æ±‚URLï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/api/shop-type/list%EF%BC%88GET%EF%BC%89">http://localhost:8080/api/shop-type/listï¼ˆGETï¼‰</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e1c9cdf7dc3043aabce37a802f77f3a2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/4e553786a8054fb89b024efa1160b86e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="Stirngç¼“å­˜ç­–ç•¥å®ç°">Stirngç¼“å­˜ç­–ç•¥å®ç°</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopTypeString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.ä» Redis ä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopTypeJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_TYPE_LIST_KEY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ Redis ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopTypeJson)) &#123;</span><br><span class="line">        <span class="comment">// 2.1.å­˜åœ¨ï¼Œåˆ™è¿”å›</span></span><br><span class="line">        List&lt;ShopType&gt; shopTypes = JSONUtil.toList(shopTypeJson, ShopType.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shopTypes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.2.Redis ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span></span><br><span class="line">    List&lt;ShopType&gt; shopTypes = query().orderByAsc(<span class="string">&quot;sort&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (shopTypes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 3.1.æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™è¿”å› false</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åˆ†ç±»ä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.2.æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œåˆ™å°†æŸ¥è¯¢åˆ°çš„ä¿¡æ¯å­˜å…¥ Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_TYPE_LIST_KEY, JSONUtil.toJsonStr(shopTypes));</span><br><span class="line">    <span class="comment">// 3.3è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shopTypes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Listç¼“å­˜ç­–ç•¥å®ç°">Listç¼“å­˜ç­–ç•¥å®ç°</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopTypeMapper, ShopType&gt; <span class="keyword">implements</span> <span class="title class_">IShopTypeService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopType</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.ä» Redis ä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        List&lt;String&gt; shopTypeJsonList = stringRedisTemplate.opsForList().range(CACHE_SHOP_TYPE_LIST_KEY, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ Redis ä¸­æ˜¯å¦æœ‰è¯¥ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (shopTypeJsonList != <span class="literal">null</span> &amp;&amp; !shopTypeJsonList.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 2.1.è‹¥ Redis ä¸­å­˜åœ¨è¯¥ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">            ArrayList&lt;ShopType&gt; typeList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (String str : shopTypeJsonList) &#123;</span><br><span class="line">                typeList.add(JSONUtil.toBean(str, ShopType.class));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„streamæµçš„æ–¹å¼ï¼Œå…¶å®å¤§å·®ä¸å·®ï¼Œéƒ½æ˜¯éå†ï¼Œæ¯ä¸ªæ•°æ®éƒ½è½¬æ¢ç±»å‹åå†æ“ä½œ</span></span><br><span class="line"><span class="comment">//            List typeList = shopTypeJsonList.stream().map((shopTypeJson)-&gt;&#123;</span></span><br><span class="line"><span class="comment">//                ShopType shopType = JSONUtil.toBean(shopTypeJson, ShopType.class);</span></span><br><span class="line"><span class="comment">//                return shopType;</span></span><br><span class="line"><span class="comment">//            &#125;).collect(Collectors.toList());</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(typeList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2.Redis ä¸­è‹¥ä¸å­˜åœ¨è¯¥æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span></span><br><span class="line">        List&lt;ShopType&gt; typeList = query().orderByAsc(<span class="string">&quot;sort&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (typeList == <span class="literal">null</span> || typeList.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 3.1.æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™è¿”å› false</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åˆ†ç±»ä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.2æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œåˆ™å°†æŸ¥è¯¢åˆ°çš„ä¿¡æ¯å­˜å…¥ Redis</span></span><br><span class="line">        <span class="keyword">for</span> (ShopType shopType : typeList) &#123;</span><br><span class="line">            stringRedisTemplate.opsForList().rightPushAll(CACHE_SHOP_TYPE_LIST_KEY, JSONUtil.toJsonStr(shopType));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸‹é¢æ˜¯streamæµçš„æ–¹å¼</span></span><br><span class="line"><span class="comment">//        List shopTypeJson = typeList.stream().map((shopType)-&gt; &#123;</span></span><br><span class="line"><span class="comment">//            String jsonStr = JSONUtil.toJsonStr(shopType);</span></span><br><span class="line"><span class="comment">//            return jsonStr;</span></span><br><span class="line"><span class="comment">//        &#125;).collect(Collectors.toList());</span></span><br><span class="line"><span class="comment">//        stringRedisTemplate.opsForList().rightPushAll(CACHE_SHOP_TYPE_LIST_KEY,shopTypeJson);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.3è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(typeList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥</h2>
<ul>
<li>ç¼“å­˜æ›´æ–°æ˜¯Redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ•°æ®å®è´µï¼Œå½“æˆ‘ä»¬æƒ³Redisæ’å…¥å¤ªå¤šæ•°æ®ï¼Œæ­¤æ—¶å°±å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­æ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥Redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æŠŠå®ƒæˆä¸ºæ·˜æ±°æ›´åˆé€‚</li>
<li><code>å†…å­˜æ·˜æ±°</code>ï¼šRedisè‡ªåŠ¨è¿›è¡Œï¼Œå½“Rediså†…å­˜å¤§é“æˆ‘ä»¬è®¾å®šçš„<code>max-memery</code>æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ·˜æ±°æœºåˆ¶ï¼Œæ·˜æ±°æ‰ä¸€äº›ä¸é‡è¦çš„æ•°æ®ï¼ˆå¯ä»¥è‡ªå·±è®¾ç½®ç­–ç•¥æ–¹å¼ï¼‰</li>
<li><code>è¶…æ—¶å‰”é™¤</code>ï¼šå½“æˆ‘ä»¬ç»™Redisè®¾ç½®äº†è¿‡æœŸæ—¶é—´TTLä¹‹åï¼ŒRedisä¼šå°†è¶…æ—¶çš„æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ç¼“å­˜</li>
<li><code>ä¸»åŠ¨æ›´æ–°</code>ï¼šæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æŠŠç¼“å­˜åˆ é™¤æ‰ï¼Œé€šå¸¸ç”¨äºè§£å†³ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´é—®é¢˜</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">å†…å­˜æ·˜æ±°</th>
<th style="text-align:center">è¶…æ—¶å‰”é™¤</th>
<th style="text-align:center">ä¸»åŠ¨æ›´æ–°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">è¯´æ˜</td>
<td style="text-align:center">ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œ åˆ©ç”¨Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œ å½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td style="text-align:center">ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œ åˆ°æœŸåè‡ªåŠ¨åˆ é™¤ç¼“å­˜ã€‚ ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td style="text-align:center">ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œ åœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œ æ›´æ–°ç¼“å­˜ã€‚</td>
</tr>
<tr>
<td style="text-align:center">ä¸€è‡´æ€§</td>
<td style="text-align:center">å·®</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">å¥½</td>
</tr>
<tr>
<td style="text-align:center">ç»´æŠ¤æˆæœ¬</td>
<td style="text-align:center">æ— </td>
<td style="text-align:center">ä½</td>
<td style="text-align:center">é«˜</td>
</tr>
</tbody>
</table>
<ul>
<li>ä¸šåŠ¡åœºæ™¯
<ul>
<li>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜ï¼ˆå› ä¸ºè¿™ä¸ªå¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½ä¸éœ€è¦æ›´æ–°ï¼‰</li>
<li>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</li>
</ul>
</li>
</ul>
<h3 id="æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆ">æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆ</h3>
<ul>
<li>ç”±äºæˆ‘ä»¬çš„ç¼“å­˜æ•°æ®æºæ¥è‡ªæ•°æ®åº“ï¼Œè€Œæ•°æ®åº“çš„æ•°æ®æ˜¯ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼Œå› æ­¤ï¼Œå¦‚æœå½“æ•°æ®åº“ä¸­æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œè€Œç¼“å­˜å´æ²¡æœ‰åŒæ­¥ï¼Œæ­¤æ—¶å°±ä¼šæœ‰ä¸€è‡´æ€§é—®é¢˜å­˜åœ¨ï¼Œå…¶åæœæ˜¯
<ul>
<li>ç”¨æˆ·ä½¿ç”¨ç¼“å­˜ä¸­çš„è¿‡æ—¶æ•°æ®ï¼Œå°±ä¼šäº§ç”Ÿç±»ä¼¼å¤šçº¿ç¨‹æ•°æ®å®‰å…¨é—®é¢˜ï¼Œä»è€Œå½±å“ä¸šåŠ¡ï¼Œäº§å“å£ç¢‘ç­‰</li>
</ul>
</li>
<li>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼
<ol>
<li>Cache Aside Pattern äººå·¥ç¼–ç æ–¹å¼ï¼šç¼“å­˜è°ƒç”¨è€…åœ¨æ›´æ–°å®Œæ•°æ®åº“ä¹‹åå†å»æ›´æ–°ç¼“å­˜ï¼Œä¹Ÿç§°ä¹‹ä¸ºåŒå†™æ–¹æ¡ˆ</li>
<li>Read/Write Through Patternï¼šç¼“å­˜ä¸æ•°æ®åº“æ•´åˆä¸ºä¸€ä¸ªæœåŠ¡ï¼Œç”±æœåŠ¡æ¥ç»´æŠ¤ä¸€è‡´æ€§ã€‚è°ƒç”¨è€…è°ƒç”¨è¯¥æœåŠ¡ï¼Œæ— éœ€å…³å¿ƒç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚ä½†æ˜¯ç»´æŠ¤è¿™æ ·ä¸€ä¸ªæœåŠ¡å¾ˆå¤æ‚ï¼Œå¸‚é¢ä¸Šä¹Ÿä¸å®¹æ˜“æ‰¾åˆ°è¿™æ ·çš„ä¸€ä¸ªç°æˆçš„æœåŠ¡ï¼Œå¼€å‘æˆæœ¬é«˜</li>
<li>Write Behind Caching Patternï¼šè°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹å»å¼‚æ­¥å¤„ç†æ•°æ®åº“ï¼Œæœ€ç»ˆå®ç°ä¸€è‡´æ€§ã€‚ä½†æ˜¯ç»´æŠ¤è¿™æ ·çš„ä¸€ä¸ªå¼‚æ­¥çš„ä»»åŠ¡å¾ˆå¤æ‚ï¼Œéœ€è¦å®æ—¶ç›‘æ§ç¼“å­˜ä¸­çš„æ•°æ®æ›´æ–°ï¼Œå…¶ä»–çº¿ç¨‹å»å¼‚æ­¥æ›´æ–°æ•°æ®åº“ä¹Ÿå¯èƒ½ä¸å¤ªåŠæ—¶ï¼Œè€Œä¸”ç¼“å­˜æœåŠ¡å™¨å¦‚æœå®•æœºï¼Œé‚£ä¹ˆç¼“å­˜çš„æ•°æ®ä¹Ÿå°±ä¸¢å¤±äº†</li>
</ol>
</li>
</ul>
<h3 id="æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ">æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ</h3>
<ul>
<li>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨ä¼ä¸šçš„å®é™…åº”ç”¨ä¸­ï¼Œè¿˜æ˜¯æ–¹æ¡ˆä¸€æœ€å¯é ï¼Œä½†æ˜¯æ–¹æ¡ˆä¸€çš„è°ƒç”¨è€…è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</li>
<li>å¦‚æœé‡‡ç”¨æ–¹æ¡ˆä¸€ï¼Œå‡è®¾æˆ‘ä»¬æ¯æ¬¡æ“ä½œå®Œæ•°æ®åº“ä¹‹åï¼Œéƒ½å»æ›´æ–°ä¸€ä¸‹ç¼“å­˜ï¼Œä½†æ˜¯å¦‚æœä¸­é—´å¹¶æ²¡æœ‰äººæŸ¥è¯¢æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªæ›´æ–°åŠ¨ä½œåªæœ‰æœ€åä¸€æ¬¡æ˜¯æœ‰æ•ˆçš„ï¼Œä¸­é—´çš„æ›´æ–°åŠ¨ä½œæ„ä¹‰ä¸å¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠç¼“å­˜ç›´æ¥åˆ é™¤ï¼Œç­‰åˆ°æœ‰äººå†æ¬¡æŸ¥è¯¢æ—¶ï¼Œå†å°†ç¼“å­˜ä¸­çš„æ•°æ®åŠ è½½å‡ºæ¥</li>
<li>å¯¹æ¯”åˆ é™¤ç¼“å­˜ä¸æ›´æ–°ç¼“å­˜
<ul>
<li><code>æ›´æ–°ç¼“å­˜</code>ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½éœ€è¦æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤š</li>
<li><code>åˆ é™¤ç¼“å­˜</code>ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼Œå†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜</li>
</ul>
</li>
<li>å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œåŒæ—¶æˆåŠŸ/åŒæ—¶å¤±è´¥
<ul>
<li><code>å•ä½“ç³»ç»Ÿï¼š</code>å°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡</li>
<li><code>åˆ†å¸ƒå¼ç³»ç»Ÿï¼š</code>åˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li>
</ul>
</li>
<li>å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿæˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹è¿™ä¸¤ç§æ–¹å¼çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</li>
<li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“<br>
åˆ é™¤ç¼“å­˜çš„æ“ä½œå¾ˆå¿«ï¼Œä½†æ˜¯æ›´æ–°æ•°æ®åº“çš„æ“ä½œç›¸å¯¹è¾ƒæ…¢ï¼Œå¦‚æœæ­¤æ—¶æœ‰ä¸€ä¸ªçº¿ç¨‹2åˆšå¥½è¿›æ¥æŸ¥è¯¢ç¼“å­˜ï¼Œç”±äºæˆ‘ä»¬åˆšåˆšæ‰åˆ é™¤ç¼“å­˜ï¼Œæ‰€ä»¥çº¿ç¨‹2éœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œä½†æ˜¯æˆ‘ä»¬æ›´æ–°æ•°æ®åº“çš„æ“ä½œè¿˜æœªå®Œæˆï¼Œæ‰€ä»¥çº¿ç¨‹2æŸ¥è¯¢åˆ°çš„æ•°æ®æ˜¯è„æ•°æ®ï¼Œå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354be3e16f2c2beb1d11bd0.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354be3e16f2c2beb1d11bd0.jpg" alt="img"></a></li>
<li>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜<br>
çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜çš„æ—¶å€™ï¼Œç¼“å­˜TTLåˆšå¥½å¤±æ•ˆï¼Œéœ€è¦æŸ¥è¯¢æ•°æ®åº“å¹¶å†™å…¥ç¼“å­˜ï¼Œè¿™ä¸ªæ“ä½œè€—æ—¶ç›¸å¯¹è¾ƒçŸ­ï¼ˆç›¸æ¯”è¾ƒäºä¸Šå›¾æ¥è¯´ï¼‰ï¼Œä½†æ˜¯å°±åœ¨è¿™ä¹ˆçŸ­çš„æ—¶é—´å†…ï¼Œçº¿ç¨‹2è¿›æ¥äº†ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œåˆ é™¤ç¼“å­˜ï¼Œä½†æ˜¯çº¿ç¨‹1è™½ç„¶æŸ¥è¯¢å®Œäº†æ•°æ®ï¼ˆæ›´æ–°å‰çš„æ—§æ•°æ®ï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠå†™å…¥ç¼“å­˜ï¼Œæ‰€ä»¥çº¿ç¨‹2çš„æ›´æ–°æ•°æ®åº“ä¸åˆ é™¤ç¼“å­˜ï¼Œå¹¶æ²¡æœ‰å½±å“åˆ°çº¿ç¨‹1çš„æŸ¥è¯¢æ—§æ•°æ®ï¼Œå†™å…¥ç¼“å­˜ï¼Œé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354be5316f2c2beb1d130c0.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354be5316f2c2beb1d130c0.jpg" alt="img"></a></li>
<li>è™½ç„¶è¿™äºŒè€…éƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´ï¼Œåè€…å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ¦‚ç‡ç›¸å¯¹è¾ƒä½ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆé‡‡ç”¨åè€…<code>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</code>çš„æ–¹æ¡ˆ</li>
</ul>
<h2 id="å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´">å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´</h2>
<ul>
<li>
<p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹</p>
<ul>
<li>ä¿®æ”¹ShopControllerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä»¥ä¸‹è¦æ±‚</li>
</ul>
<ol>
<li>æ ¹æ®idæŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®TTL</li>
<li>æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</li>
</ol>
</li>
<li>
<p>ä¿®æ”¹ShopServiceçš„queryByIdæ–¹æ³•ï¼Œå†™å…¥ç¼“å­˜æ—¶è®¾ç½®ä¸€ä¸‹TTL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯æˆ–è€…è¿”å›ç©ºéƒ½å¯ä»¥ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr,CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹updateæ–¹æ³•</p>
<ul>
<li>ä¹‹å‰çš„updateæ–¹æ³•</li>
<li>ä¿®æ”¹åçš„updateæ–¹æ³•</li>
<li>Serviceå±‚</li>
<li>ServiceImplå±‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ›´æ–°å•†é“ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> shop å•†é“ºæ•°æ®</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> æ— </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(<span class="meta">@RequestBody</span> Shop shop)</span> &#123;</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®åº“</span></span><br><span class="line">    shopService.updateById(shop);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹å®Œæ¯•ä¹‹åæˆ‘ä»¬é‡å¯æœåŠ¡å™¨è¿›è¡Œæµ‹è¯•ï¼Œé¦–å…ˆéšä¾¿æŒ‘ä¸€ä¸ªé¡ºçœ¼çš„æ•°æ®ï¼Œæˆ‘è¿™é‡Œå°±æ˜¯æ‹¿é¤å…æ•°æ®åšæµ‹è¯•ï¼Œï¼Œæˆ‘ä»¬å…ˆè®¿é—®è¯¥é¤å…ï¼Œå°†è¯¥é¤å…çš„æ•°æ®ç¼“å­˜åˆ°Redisä¸­ï¼Œä¹‹åä½¿ç”¨POSTMANå‘é€PUTè¯·æ±‚ï¼Œè¯·æ±‚è·¯å¾„http://localhost:8080/api/shop/ ï¼Œæºå¸¦JSONæ•°æ®å¦‚ä¸‹</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¤§å…³&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;openHours&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10:00-22:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sold&quot;</span><span class="punctuation">:</span> <span class="number">4215</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é‡‘åè·¯é”¦æ˜Œæ–‡åè‹‘29å·&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;comments&quot;</span><span class="punctuation">:</span> <span class="number">3035</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avgPrice&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">37</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;476èŒ¶é¤å…&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typeId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¹‹åå†Rediså›¾å½¢åŒ–é¡µé¢åˆ·æ–°æ•°æ®ï¼Œå‘ç°è¯¥é¤å…çš„æ•°æ®ç¡®å®ä¸åœ¨Redisä¸­äº†ï¼Œä¹‹åæˆ‘ä»¬åˆ·æ–°ç½‘é¡µï¼Œé¤å…åä¼šè¢«æ”¹ä¸º<code>476èŒ¶é¤å…</code>ï¼Œç„¶åæˆ‘ä»¬å†å»Redisä¸­åˆ·æ–°ï¼Œå‘ç°æ–°æ•°æ®å·²ç»è¢«ç¼“å­˜äº†</p>
</li>
<li>
<p>é‚£ä¹ˆç°åœ¨åŠŸèƒ½å°±å®ç°å®Œæ¯•äº†ï¼Œåªæœ‰å½“æˆ‘ä»¬åˆ·æ–°é¡µé¢çš„æ—¶å€™ï¼Œæ‰ä¼šé‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†æ•°æ®ç¼“å­˜åˆ°Redisï¼Œä¸­é€”æ— è®ºä¿®æ”¹å¤šå°‘æ¬¡ï¼Œåªè¦ä¸åˆ·æ–°é¡µé¢è®¿é—®ï¼ŒRedisä¸­éƒ½ä¸ä¼šæ›´æ–°æ•°æ®</p>
</li>
</ul>
<h2 id="ç¼“å­˜ç©¿é€é—®é¢˜çš„è§£å†³æ€è·¯">ç¼“å­˜ç©¿é€é—®é¢˜çš„è§£å†³æ€è·¯</h2>
<ul>
<li><code>ç¼“å­˜ç©¿é€</code>ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œéƒ½ä¸ä¼šç”Ÿæ•ˆï¼ˆåªæœ‰æ•°æ®åº“æŸ¥åˆ°äº†ï¼Œæ‰ä¼šè®©redisç¼“å­˜ï¼Œä½†ç°åœ¨çš„é—®é¢˜æ˜¯æŸ¥ä¸åˆ°ï¼‰ï¼Œä¼šé¢‘ç¹çš„å»è®¿é—®æ•°æ®åº“ã€‚</li>
<li>å¸¸è§çš„ç»“å±€æ–¹æ¡ˆæœ‰ä¸¤ç§
<ol>
<li>ç¼“å­˜ç©ºå¯¹è±¡
<ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼šé¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œå¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li>
</ul>
</li>
<li>å¸ƒéš†è¿‡æ»¤
<ul>
<li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨å•¥å“¦ï¼Œæ²¡æœ‰å¤šä½™çš„key</li>
<li>ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œå¯èƒ½å­˜åœ¨è¯¯åˆ¤</li>
</ul>
</li>
</ol>
</li>
<li><code>ç¼“å­˜ç©ºå¯¹è±¡</code>æ€è·¯åˆ†æï¼šå½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œä¼šå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“é‡Œä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®å°±ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ã€‚ä½†æ˜¯æ•°æ®åº“èƒ½æ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œæ‰€ä»¥å¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶éƒ½æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›è¯·æ±‚å°±ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“é‡Œä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªè¿™ä¸ªæ•°æ®å­˜åœ¨redisä¸­å»ï¼ˆè¿™å°±æ˜¯ä¸ºå•¥è¯´ä¼šæœ‰<code>é¢å¤–çš„å†…å­˜æ¶ˆè€—</code>ï¼‰ï¼Œè¿™æ ·ä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œredisç¼“å­˜ä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®ï¼Œä¸ç”¨å»æŸ¥æ•°æ®åº“ã€‚å¯èƒ½é€ æˆçš„<code>çŸ­æœŸä¸ä¸€è‡´</code>æ˜¯æŒ‡åœ¨ç©ºå¯¹è±¡çš„å­˜æ´»æœŸé—´ï¼Œæˆ‘ä»¬æ›´æ–°äº†æ•°æ®åº“ï¼ŒæŠŠè¿™ä¸ªç©ºå¯¹è±¡å˜æˆäº†æ­£å¸¸çš„å¯ä»¥è®¿é—®çš„æ•°æ®ï¼Œä½†ç”±äºç©ºå¯¹è±¡çš„TTLè¿˜æ²¡è¿‡ï¼Œæ‰€ä»¥å½“ç”¨æˆ·æ¥æŸ¥è¯¢çš„æ—¶å€™ï¼ŒæŸ¥è¯¢åˆ°çš„è¿˜æ˜¯ç©ºå¯¹è±¡ï¼Œç­‰TTLè¿‡äº†ä¹‹åï¼Œæ‰èƒ½è®¿é—®åˆ°æ­£ç¡®çš„æ•°æ®ï¼Œä¸è¿‡è¿™ç§æƒ…å†µå¾ˆå°‘è§ç½¢äº†</li>
<li><code>å¸ƒéš†è¿‡æ»¤</code>æ€è·¯åˆ†æï¼šå¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œæ ¹æ®å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“é‡Œä¸€å®šä¼šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°æ•°æ®ä¹‹åï¼Œå†å°†å…¶æ”¾åˆ°redisä¸­ã€‚å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚è¿™ç§æ€æƒ³çš„ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œä½†å­˜åœ¨è¯¯åˆ¤ï¼Œè¯¯åˆ¤çš„åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œéƒ½å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</li>
</ul>
<h2 id="ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜">ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜</h2>
<ul>
<li>
<p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹</p>
</li>
<li>
<p>åœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ªæ•°æ®åœ¨MySQLä¸­ä¸å­˜åœ¨ï¼Œå°±ç›´æ¥è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯äº†ï¼Œä½†æ˜¯è¿™æ ·å­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯æˆ–è€…è¿”å›ç©ºéƒ½å¯ä»¥ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr,CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç°åœ¨çš„é€»è¾‘æ˜¯ï¼šå¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œå°†è¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„TTLï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ã€‚å½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œå…ˆå»Redisä¸­åˆ¤æ–­valueæ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¯´æ˜æ˜¯åˆšåˆšæˆ‘ä»¬å­˜çš„ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæŸ¥è¯¢åˆ°çš„æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¯´æ˜æ˜¯æˆ‘ä»¬ç¼“å­˜çš„ç©ºæ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (shopjson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå­—ç¬¦ä¸²å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œçš„å¸¸é‡å€¼æ˜¯2åˆ†é’Ÿ</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å°ç»“ï¼š</p>
<ul>
<li>ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
<ul>
<li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œåœ¨æ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œä¼šç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</li>
</ul>
</li>
<li>ç¼“å­˜äº§æŠ•çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ
<ul>
<li>ç¼“å­˜nullå€¼</li>
<li>å¸ƒéš†è¿‡æ»¤</li>
<li>å¢å¼ºidå¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹ï¼ˆå¯ä»¥é‡‡ç”¨é›ªèŠ±ç®—æ³•ï¼‰</li>
<li>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li>
<li>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li>
<li>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</li>
</ul>
</li>
</ul>
<h2 id="ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯">ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯</h2>
<ul>
<li>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶é—´æ®µï¼Œå¤§é‡ç¼“å­˜çš„keyåŒæ—¶å¤±æ•ˆï¼Œæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›</li>
<li>è§£å†³æ–¹æ¡ˆ
<ul>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼Œè®©å…¶åœ¨ä¸åŒæ—¶é—´æ®µåˆ†æ‰¹å¤±æ•ˆ</li>
<li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§ï¼ˆä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå“¨å…µ(<code>Sentinel</code>)å®ä¾‹ç»„æˆçš„ç³»ç»Ÿï¼Œå¯¹redisèŠ‚ç‚¹è¿›è¡Œç›‘æ§ï¼Œåœ¨ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œèƒ½å°†ä»èŠ‚ç‚¹ä¸­çš„ä¸€ä¸ªå‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿›è¡Œæ•…éšœè½¬ä¹‰ï¼Œä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ ï¼‰</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆæµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼›è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯ï¼›è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜ï¼›å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰ï¼›å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcatï¼›è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜ï¼›å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯">ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯</h2>
<ul>
<li>ç¼“å­˜å‡»ç©¿ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«<code>é«˜å¹¶å‘è®¿é—®</code>å¹¶ä¸”<code>ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚</code>çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆæ— æ•°è¯·æ±‚è®¿é—®å°±ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»</li>
<li>ä¸¾ä¸ªä¸å¤ªæ°å½“çš„ä¾‹å­ï¼šä¸€ä»¶ç§’æ€ä¸­çš„å•†å“çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œå¤§å®¶éƒ½åœ¨ç–¯ç‹‚æŠ¢è´­ï¼Œé‚£ä¹ˆè¿™ä¸ªç¬é—´å°±ä¼šæœ‰æ— æ•°çš„è¯·æ±‚è®¿é—®å»ç›´æ¥æŠµè¾¾æ•°æ®åº“ï¼Œä»è€Œé€ æˆç¼“å­˜å‡»ç©¿</li>
<li>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§
<ol>
<li>äº’æ–¥é”</li>
<li>é€»è¾‘è¿‡æœŸ</li>
</ol>
</li>
<li><code>é€»è¾‘åˆ†æ</code>ï¼šå‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åæœªå‘½ä¸­ï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œé‡å»ºç¼“å­˜æ•°æ®ï¼Œå®Œæˆè¿™äº›ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿå°±èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ã€‚ä½†æ˜¯åœ¨çº¿ç¨‹1è¿˜æœªæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œåˆè¿›æ¥äº†çº¿ç¨‹2ã€3ã€4åŒæ—¶æ¥è®¿é—®å½“å‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåœ¨åŒä¸€æ—¶åˆ»è®¿é—®æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLè¯­å¥æŸ¥è¯¢ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354f77716f2c2beb1225032.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354f77716f2c2beb1225032.jpg" alt="img"></a></li>
<li><code>è§£å†³æ–¹æ¡ˆä¸€</code>ï¼šäº’æ–¥é”</li>
<li>åˆ©ç”¨é”çš„äº’æ–¥æ€§ï¼Œå‡è®¾çº¿ç¨‹è¿‡æ¥ï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„è®¿é—®æ•°æ®åº“ï¼Œä»è€Œé¿å…å¯¹æ•°æ®åº“é¢‘ç¹è®¿é—®äº§ç”Ÿè¿‡å¤§å‹åŠ›ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå°†æŸ¥è¯¢çš„æ€§èƒ½ä»å¹¶è¡Œå˜æˆäº†ä¸²è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨tryLockæ–¹æ³•+double checkæ¥è§£å†³è¿™ä¸ªé—®é¢˜</li>
<li>çº¿ç¨‹1åœ¨æ“ä½œçš„æ—¶å€™ï¼Œæ‹¿ç€é”æŠŠæˆ¿é—¨é”ä¸Šäº†ï¼Œé‚£ä¹ˆçº¿ç¨‹2ã€3ã€4å°±ä¸èƒ½éƒ½è¿›æ¥æ“ä½œæ•°æ®åº“ï¼Œåªæœ‰1æ“ä½œå®Œäº†ï¼ŒæŠŠæˆ¿é—¨æ‰“å¼€äº†ï¼Œæ­¤æ—¶ç¼“å­˜æ•°æ®ä¹Ÿé‡å»ºå¥½äº†ï¼Œçº¿ç¨‹2ã€3ã€4ç›´æ¥ä»redisä¸­å°±å¯ä»¥æŸ¥è¯¢åˆ°æ•°æ®ã€‚</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354f76816f2c2beb1223b47.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354f76816f2c2beb1223b47.jpg" alt="img"></a></p>
<ul>
<li><code>è§£å†³æ–¹æ¡ˆäºŒ</code>ï¼šé€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</li>
<li>æ–¹æ¡ˆåˆ†æï¼šæˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šå‡ºç°ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨äºæˆ‘ä»¬å¯¹keyè®¾ç½®äº†TTLï¼Œå¦‚æœæˆ‘ä»¬ä¸è®¾ç½®TTLï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä½†æ˜¯ä¸è®¾ç½®TTLï¼Œæ•°æ®åˆä¼šä¸€ç›´å ç”¨æˆ‘ä»¬çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</li>
<li>æˆ‘ä»¬ä¹‹å‰æ˜¯TTLè®¾ç½®åœ¨redisçš„valueä¸­ï¼Œæ³¨æ„ï¼šè¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºRedisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†ã€‚å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å½“å‰æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡ï¼Œè·å¾—äº†é”çš„è¿›ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹å»è¿›è¡Œä¹‹å‰çš„é‡å»ºç¼“å­˜æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè€…é€»è¾‘ä¹‹åï¼Œæ‰ä¼šé‡Šæ”¾é”ï¼Œè€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹2æ‹¿ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼ˆä½†åªèƒ½è¿”å›æ—§æ•°æ®ï¼Œç‰ºç‰²äº†æ•°æ®ä¸€è‡´æ€§ï¼Œæ¢å–æ€§èƒ½ä¸Šçš„æé«˜ï¼‰ï¼Œåªæœ‰ç­‰å¾…çº¿ç¨‹2é‡å»ºç¼“å­˜æ•°æ®ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½è¿”å›æ­£ç¡®çš„æ•°æ®</li>
<li>è¿™ç§æ–¹æ¡ˆå·§å¦™åœ¨äºï¼Œå¼‚æ­¥æ„å»ºç¼“å­˜æ•°æ®ï¼Œç¼ºç‚¹æ˜¯åœ¨é‡å»ºå®Œç¼“å­˜æ•°æ®ä¹‹å‰ï¼Œè¿”å›çš„éƒ½æ˜¯è„æ•°æ®<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354f97716f2c2beb124e950.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354f97716f2c2beb124e950.jpg" alt="img"></a></li>
</ul>
<h2 id="å¯¹æ¯”äº’æ–¥é”ä¸é€»è¾‘åˆ é™¤">å¯¹æ¯”äº’æ–¥é”ä¸é€»è¾‘åˆ é™¤</h2>
<ul>
<li><code>äº’æ–¥é”æ–¹æ¡ˆ</code>ï¼šç”±äºä¿è¯äº†äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ•°æ®ä¸€è‡´ï¼Œä¸”å®ç°ç®€å•ï¼Œåªæ˜¯åŠ äº†ä¸€æŠŠé”è€Œå·²ï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–çš„äº‹æƒ…éœ€è¦æ“å¿ƒï¼Œæ‰€ä»¥æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œç¼ºç‚¹åœ¨äºæœ‰é”çš„æƒ…å†µï¼Œå°±å¯èƒ½æ­»é”ï¼Œæ‰€ä»¥åªèƒ½ä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½ä¼šå—åˆ°å½±å“</li>
<li><code>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</code>ï¼šçº¿ç¨‹è¯»å–è¿‡ç¨‹ä¸­ä¸éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å¥½ï¼Œæœ‰ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æŒæœ‰é”å»è¿›è¡Œé‡æ„ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„æ•°æ®å®Œæˆä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½è¿”å›è„æ•°æ®ï¼Œä¸”å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">è§£å†³æ–¹æ¡ˆ</th>
<th style="text-align:center">ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">äº’æ–¥é”</td>
<td style="text-align:center">æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€— ä¿è¯ä¸€è‡´æ€§ å®ç°ç®€å•</td>
<td style="text-align:center">çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“ å¯èƒ½æœ‰æ­»é”é£é™©</td>
</tr>
<tr>
<td style="text-align:center">é€»è¾‘è¿‡æœŸ</td>
<td style="text-align:center">çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td>
<td style="text-align:center">ä¸ä¿è¯ä¸€è‡´æ€§ æœ‰é¢å¤–å†…å­˜æ¶ˆè€— å®ç°å¤æ‚</td>
</tr>
</tbody>
</table>
<h2 id="åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜">åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h2>
<ul>
<li>
<p><code>æ ¸å¿ƒæ€è·¯</code>ï¼šç›¸è¾ƒäºåŸæ¥ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®åç›´æ¥æŸ¥è¯¢æ•°æ®åº“è€Œè¨€ï¼Œç°åœ¨çš„æ–¹æ¡ˆæ˜¯ï¼Œè¿›è¡ŒæŸ¥è¯¢ä¹‹åï¼Œå¦‚æœæ²¡æœ‰ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è¿›è¡Œäº’æ–¥é”çš„è·å–ï¼Œè·å–äº’æ–¥é”ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦è·å–åˆ°äº†é”ï¼Œå¦‚æœæ²¡è·å–åˆ°ï¼Œåˆ™ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œè¿‡ä¸€ä¼šå„¿å†å»å°è¯•ï¼ŒçŸ¥é“è·å–åˆ°é”ä¸ºæ­¢ï¼Œæ‰èƒ½è¿›è¡ŒæŸ¥è¯¢</p>
</li>
<li>
<p>å¦‚æœè·å–åˆ°äº†é”çš„çº¿ç¨‹ï¼Œåˆ™è¿›è¡ŒæŸ¥è¯¢ï¼Œå°†æŸ¥è¯¢åˆ°çš„æ•°æ®å†™å…¥Redisï¼Œå†é‡Šæ”¾é”ï¼Œè¿”å›æ•°æ®ï¼Œåˆ©ç”¨äº’æ–¥é”å°±èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œæ•°æ®åº“çš„é€»è¾‘ï¼Œé˜²æ­¢ç¼“å­˜å‡»ç©¿<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6354fb8116f2c2beb127ac8b.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6354fb8116f2c2beb127ac8b.jpg" alt="img"></a></p>
</li>
<li>
<p><code>æ“ä½œé”çš„ä»£ç </code></p>
</li>
<li>
<p>æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œå¦‚æœredisæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œå¦‚æœå·²ç»å­˜åœ¨è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥å¤±è´¥ï¼Œè¿”å›0ã€‚åœ¨StringRedisTemplateä¸­è¿”å›true/falseï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿”å›å€¼æ¥åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸè·å–åˆ°äº†é”</p>
<ul>
<li>tryLock</li>
<li>unlock</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//é¿å…è¿”å›å€¼ä¸ºnullï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†BooleanUtilå·¥å…·ç±»</span></span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç„¶åè¿™é‡Œå…ˆæŠŠæˆ‘ä»¬ä¹‹å‰å†™çš„ç¼“å­˜ç©¿é€ä»£ç ä¿®æ”¹ä¸€ä¸‹ï¼Œæå–æˆä¸€ä¸ªç‹¬ç«‹çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithPassThrough</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopjson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¹‹åç¼–å†™æˆ‘ä»¬çš„äº’æ–¥é”ä»£ç ï¼Œå…¶å®ä¸ç¼“å­˜ç©¿é€ä»£ç ç±»ä¼¼ï¼Œåªéœ€è¦åœ¨ä¸Šé¢ç¨åŠ ä¿®æ”¹å³å¯</p>
<ul>
<li>DIFF</li>
<li>ä¿®æ”¹åä»£ç </li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line"><span class="deletion">-   public Shop queryWithPassThrough(Long id) &#123;</span></span><br><span class="line"><span class="addition">+   public Shop queryWithMutex(Long id) &#123;</span></span><br><span class="line">        //å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span><br><span class="line">        String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">        //å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span><br><span class="line">        if (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">            Shop shop = JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">            return shop;</span><br><span class="line">        &#125;</span><br><span class="line">        if (shopjson != null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        //å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span><br><span class="line"><span class="addition">+       //ä»è¿™é‡Œï¼Œç”¨try/catch/finallyåŒ…è£¹</span></span><br><span class="line"><span class="addition">+       //è·å–äº’æ–¥é”</span></span><br><span class="line"><span class="addition">+       boolean flag = tryLock(LOCK_SHOP_KEY + id);</span></span><br><span class="line"><span class="addition">+       //åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line"><span class="addition">+       if (!flag) &#123;</span></span><br><span class="line"><span class="addition">+           //å¤±è´¥ï¼Œåˆ™ä¼‘çœ å¹¶é‡è¯•</span></span><br><span class="line"><span class="addition">+           Thread.sleep(50);</span></span><br><span class="line"><span class="addition">+           return queryWithMutex(id);</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line">        Shop shop = getById(id);</span><br><span class="line">        //æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span><br><span class="line">        if (shop == null) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, &quot;&quot;, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        //æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span><br><span class="line">        String jsonStr = JSONUtil.toJsonStr(shop);</span><br><span class="line">        //å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line"><span class="addition">+       //try/catch/finallyåŒ…è£¹åˆ°è¿™é‡Œï¼Œç„¶åæŠŠé‡Šæ”¾é”çš„æ“ä½œæ”¾åˆ°finallyé‡Œ</span></span><br><span class="line"><span class="addition">+       //é‡Šæ”¾äº’æ–¥é”</span></span><br><span class="line"><span class="addition">+       unlock(LOCK_SHOP_KEY + id);</span></span><br><span class="line">        //æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span><br><span class="line">        return shop;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœ€ç»ˆä¿®æ”¹<code>queryById</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> queryWithMutex(id);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨Jmeterè¿›è¡Œæµ‹è¯•</p>
<ul>
<li>
<p>æˆ‘ä»¬å…ˆæ¥æ¨¡æ‹Ÿä¸€ä¸‹ç¼“å­˜å‡»ç©¿çš„æƒ…æ™¯ï¼Œç¼“å­˜å‡»ç©¿æ˜¯æŒ‡åœ¨æŸæ—¶åˆ»ï¼Œä¸€ä¸ªçƒ­ç‚¹æ•°æ®çš„TTLåˆ°æœŸäº†ï¼Œæ­¤æ—¶ç”¨æˆ·ä¸èƒ½ä»Redisä¸­è·å–çƒ­ç‚¹å•†å“æ•°æ®ï¼Œç„¶åå°±éƒ½å¾—å»æ•°æ®åº“é‡ŒæŸ¥è¯¢ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚</p>
</li>
<li>
<p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆå°†Redisä¸­çš„çƒ­ç‚¹å•†å“æ•°æ®åˆ é™¤ï¼Œæ¨¡æ‹ŸTTLåˆ°æœŸï¼Œç„¶åç”¨Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œå¼€100ä¸ªçº¿ç¨‹æ¥è®¿é—®è¿™ä¸ªæ²¡æœ‰ç¼“å­˜çš„çƒ­ç‚¹æ•°æ®</p>
<ul>
<li>
<p>å¦‚æœåå°æ—¥å¿—åªè¾“å‡ºäº†ä¸€æ¡SQLè¯­å¥ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„äº’æ–¥é”æ˜¯ç”Ÿæ•ˆçš„ï¼Œæ²¡æœ‰é€ æˆå¤§é‡ç”¨æˆ·éƒ½å»æŸ¥è¯¢æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLè¯­å¥</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line"><span class="meta">: ==&gt;  Preparing:</span> SELECT id,name,type_id,images,area,address,x,y,avg_price,sold,comments,score,open_hours,create_time,update_time FROM tb_shop WHERE id=?</span><br><span class="line"><span class="meta">: ==&gt; Parameters:</span> 2(Long)</span><br><span class="line"><span class="meta">: &lt;==      Total:</span> 1</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¦‚æœæ—¥å¿—è¾“å‡ºäº†å¥½å¤šSQLè¯­å¥ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„ä»£ç æœ‰é—®é¢˜</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6356424916f2c2beb1a493ea.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6356424916f2c2beb1a493ea.jpg" alt="img"></a></p>
<h2 id="åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜">åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼šæ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
</li>
<li>
<p>æ€è·¯åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­</p>
<ul>
<li>å¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“</li>
<li>å¦‚æœå‘½ä¸­ï¼Œåˆ™å°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³
<ul>
<li>å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®</li>
<li>å¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åï¼Œç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåå†é‡Šæ”¾äº’æ–¥é”<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6355073c16f2c2beb1375808.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6355073c16f2c2beb1375808.jpg" alt="img"></a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>å°è£…æ•°æ®ï¼šå› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹åŸæ¥çš„å®ä½“ç±»ï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªç±»åŒ…å«åŸæœ‰çš„æ•°æ®å’Œè¿‡æœŸæ—¶é—´</p>
</li>
<li>
<p><code>æ­¥éª¤ä¸€</code></p>
</li>
<li>
<p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ–°å»ºä¸€ä¸ªå®ä½“ç±»ï¼ŒåŒ…å«åŸæœ‰æ•°æ®(ç”¨ä¸‡èƒ½çš„Object)å’Œè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å¯¹åŸæœ‰çš„ä»£ç æ²¡æœ‰ä¾µå…¥æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>æ­¥éª¤äºŒ</code></p>
</li>
<li>
<p>åœ¨ShopServiceImplä¸­æ–°å¢æ–¹æ³•ï¼Œè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œçœ‹çœ‹èƒ½å¦å†™å…¥æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveShop2Redis</span><span class="params">(Long id, Long expirSeconds)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expirSeconds));</span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç¼–å†™æµ‹è¯•æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HmDianPingApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShopServiceImpl shopService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        shopService.saveShop2Redis(<span class="number">1L</span>,<span class="number">1000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¿è¡Œæµ‹è¯•æ–¹æ³•ï¼Œå»Rediså›¾å½¢åŒ–é¡µé¢çœ‹åˆ°å­˜å…¥çš„valueï¼Œç¡®å®åŒ…å«äº†dataå’ŒexpireTime1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¤§å…³&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;openHours&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10:00-22:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sold&quot;</span><span class="punctuation">:</span> <span class="number">4215</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://qcloud.dpfile.com/pc/jiclIsCKmOI2arxKN1Uf0Hx3PucIJH8q0QSz-Z8llzcN56-_QiKuOvyio1OOxsRtFoXqu0G3iT2T27qat3WhLVEuLYk00OmSS1IdNpm8K8sG4JN9RIm2mTKcbLtc2o2vfCF2ubeXzk49OsGrXt_KYDCngOyCwZK-s3fqawWswzk.jpg,https://qcloud.dpfile.com/pc/IOf6VX3qaBgFXFVgp75w-KKJmWZjFc8GXDU8g9bQC6YGCpAmG00QbfT4vCCBj7njuzFvxlbkWx5uwqY2qcjixFEuLYk00OmSS1IdNpm8K8sG4JN9RIm2mTKcbLtc2o2vmIU_8ZGOT1OjpJmLxG6urQ.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é‡‘åè·¯é”¦æ˜Œæ–‡åè‹‘29å·&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;comments&quot;</span><span class="punctuation">:</span> <span class="number">3035</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avgPrice&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;updateTime&quot;</span><span class="punctuation">:</span> <span class="number">1666502007000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">37</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span> <span class="number">1640167839000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;476èŒ¶é¤å…&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">120.149192</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">30.316078</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;typeId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expireTime&quot;</span><span class="punctuation">:</span> <span class="number">1666519036559</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>æ­¥éª¤ä¸‰</code>ï¼šæ­£å¼ä»£ç <br>
æ­£å¼ä»£ç æˆ‘ä»¬å°±ç›´æ¥ç…§ç€æµç¨‹å›¾å†™å°±å¥½äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œéœ€è¦å£°æ˜ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå› ä¸ºä¸‹é¢æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªç°æˆæ¥å®Œæˆé‡æ„ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="comment">//3.1 å°†dataè½¬ä¸ºShopå¯¹è±¡</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">shopJson</span> <span class="operator">=</span> (JSONObject) redisData.getData();</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">    <span class="comment">//3.2 è·å–è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isBefore(time)) &#123;</span><br><span class="line">        <span class="comment">//5. æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(LOCK_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.saveShop2Redis(id, LOCK_SHOP_TTL);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(LOCK_SHOP_KEY + id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨Jmeterè¿›è¡Œæµ‹è¯•</p>
<ul>
<li>
<p>å…ˆæ¥å¤ç°ä¸€éåœºæ™¯ï¼Œå½“æŸä¸ªç”¨æˆ·å»Redisä¸­è®¿é—®ç¼“å­˜çš„æ•°æ®æ—¶ï¼Œå‘ç°è¯¥æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œäºæ˜¯æ–°å¼€ä¸€ä¸ªçº¿ç¨‹å»é‡æ„ç¼“å­˜æ•°æ®ï¼Œä½†åœ¨é‡æ„å®Œæˆä¹‹å‰ï¼Œç”¨æˆ·å¾—åˆ°çš„æ•°æ®éƒ½æ˜¯è„æ•°æ®ï¼Œé‡æ„å®Œæˆä¹‹åï¼Œæ‰æ˜¯æ–°æ•°æ®</p>
</li>
<li>
<p>é‚£æˆ‘ä»¬å…ˆä½¿ç”¨</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">saveShop2Redis</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•ï¼Œå‘redisä¸­æ·»åŠ ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ•°æ®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ä¸º2ç§’ï¼Œè¿™æ ·å¾ˆå¿«å°±è¿‡æœŸäº†ï¼Œ</p>
<ul>
<li>saveShop2Redis</li>
<li>Test</li>
</ul>
<p><code>JAVApublic void saveShop2Redis(Long id, Long expirSeconds) &#123;    Shop shop = getById(id);    RedisData redisData = new RedisData();    redisData.setData(shop);    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expirSeconds));    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));&#125; </code></p>
</li>
<li>
<p>ä¹‹åå»æ•°æ®åº“æŠŠè¿™ä¸ªæ•°æ®ä¿®æ”¹ä¸€ä¸‹ï¼Œè¿™æ ·é€»è¾‘è¿‡æœŸå‰å’Œé€»è¾‘è¿‡æœŸåçš„æ•°æ®å°±ä¸ä¸€è‡´ï¼Œå½“ç”¨æˆ·æ¥è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦èŠ±æ—¶é—´æ¥è¿›è¡Œé‡æ„ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„å®Œæˆä¹‹å‰ï¼Œéƒ½åªèƒ½è·å¾—è„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¿®æ”¹å‰çš„æ•°æ®ï¼‰ï¼Œåªæœ‰å½“é‡æ„å®Œæ¯•ä¹‹åï¼Œæ‰èƒ½è·å¾—æ–°æ•°æ®ï¼ˆæˆ‘ä»¬ä¿®æ”¹åçš„æ•°æ®ï¼‰</p>
</li>
<li>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼ŒåŒæ ·æ˜¯å¼€äº†100ä¸ªçº¿ç¨‹å»è®¿é—®é€»è¾‘è¿‡æœŸæ•°æ®ï¼Œå‰é¢çš„ç”¨æˆ·åªèƒ½çœ‹åˆ°è„æ•°æ®ï¼Œåé¢çš„ç”¨æˆ·çœ‹åˆ°çš„æ‰æ˜¯æ–°æ•°æ®<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6356558116f2c2beb1d8a832.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6356558116f2c2beb1d8a832.jpg" alt="img"></a></p>
</li>
</ul>
</li>
</ul>
<h2 id="å°è£…Rediså·¥å…·ç±»">å°è£…Rediså·¥å…·ç±»</h2>
<ul>
<li>
<p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œéœ€æ»¡è¶³ä¸‹åˆ—è¦æ±‚</p>
<ul>
<li>
<p>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶å­˜å‚¨åˆ°Stringç±»å‹çš„Keyä¸­ï¼Œå¹¶å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶å­˜å‚¨åœ¨Stringç±»å‹çš„Keyä¸­ï¼Œå¹¶å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//ç”±äºéœ€è¦è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨åˆ°RedisData</span></span><br><span class="line">    RedisData&lt;Object&gt; redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//redisDataçš„dataå°±æ˜¯ä¼ è¿›æ¥çš„valueå¯¹è±¡</span></span><br><span class="line">    redisData.setData(value);</span><br><span class="line">    <span class="comment">//é€»è¾‘è¿‡æœŸæ—¶é—´å°±æ˜¯å½“å‰æ—¶é—´åŠ ä¸Šä¼ è¿›æ¥çš„å‚æ•°æ—¶é—´ï¼Œç”¨TimeUnitå¯ä»¥å°†æ—¶é—´è½¬ä¸ºç§’ï¼Œéšåä¸å½“å‰æ—¶é—´ç›¸åŠ </span></span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">    <span class="comment">//ç”±äºæ˜¯é€»è¾‘è¿‡æœŸï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåªå­˜ä¸€ä¸‹keyå’Œvalueå°±å¥½äº†ï¼ŒåŒæ—¶æ³¨æ„valueæ˜¯ridisDataç±»å‹</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</p>
<ul>
<li>åŸæ–¹æ³•</li>
<li>æ”¹ä¸ºé€šç”¨æ–¹æ³•</li>
<li>ä½¿ç”¨æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithPassThrough</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopjson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">//5. æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">tmp</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                <span class="built_in">this</span>.setWithLogicExpire(key, tmp, time, timeUnit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–¹æ³•5ï¼šæ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">        &#125;</span><br><span class="line">        r = dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, timeUnit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.util.BooleanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.RedisData;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.hmdp.utils.RedisConstants.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        RedisData&lt;Object&gt; redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>&lt;&gt;();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºRç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥ï¼ŒæŸ¥è¯¢é€»è¾‘ç”¨æˆ‘ä»¬å‚æ•°ä¸­æ³¨å…¥çš„å‡½æ•°</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(r);</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, jsonStr, time, timeUnit);</span><br><span class="line">        <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">//5. æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">        <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">            <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">R</span> <span class="variable">tmp</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                    <span class="built_in">this</span>.setWithLogicExpire(key, tmp, time, timeUnit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    unlock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            r = dbFallback.apply(id);</span><br><span class="line">            <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">            <span class="built_in">this</span>.set(key, r, time, timeUnit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unlock(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1>ä¼˜æƒ åˆ¸ç§’æ€</h1>
<h2 id="Rediså®ç°å…¨å±€å”¯ä¸€ID">Rediså®ç°å…¨å±€å”¯ä¸€ID</h2>
<ul>
<li>
<p>åœ¨å„ç±»è´­ç‰©Appä¸­ï¼Œéƒ½ä¼šé‡åˆ°å•†å®¶å‘æ”¾çš„ä¼˜æƒ åˆ¸</p>
</li>
<li>
<p>å½“ç”¨æˆ·æŠ¢è´­å•†å“æ—¶ï¼Œç”Ÿæˆçš„è®¢å•ä¼šä¿å­˜åˆ°</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tb_voucher_order</span></span><br></pre></td></tr></table></figure>
<p>è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜</p>
<ol>
<li>idè§„å¾‹æ€§å¤ªæ˜æ˜¾</li>
<li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li>
</ol>
</li>
<li>
<p>å¦‚æœæˆ‘ä»¬çš„è®¢å•idæœ‰å¤ªæ˜æ˜¾çš„è§„å¾‹ï¼Œé‚£ä¹ˆå¯¹äºç”¨æˆ·æˆ–è€…ç«äº‰å¯¹æ‰‹ï¼Œå°±å¾ˆå®¹æ˜“çŒœæµ‹å‡ºæˆ‘ä»¬çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å•†åŸä¸€å¤©ä¹‹å†…èƒ½å–å‡ºå¤šå°‘å•ï¼Œè¿™æ˜æ˜¾ä¸åˆé€‚</p>
</li>
<li>
<p>éšç€æˆ‘ä»¬å•†åŸçš„è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼ŒMySQLçš„å•è¡¨å®¹é‡ä¸å®œè¶…è¿‡500Wï¼Œæ•°æ®é‡è¿‡å¤§ä¹‹åï¼Œæˆ‘ä»¬å°±è¦è¿›è¡Œæ‹†åº“æ‹†è¡¨ï¼Œæ‹†åˆ†è¡¨äº†ä¹‹åï¼Œä»–ä»¬ä»é€»è¾‘ä¸Šè®²ï¼Œæ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„idä¸èƒ½é‡å¤ï¼Œäºæ˜¯ä¹æˆ‘ä»¬å°±è¦ä¿è¯idçš„å”¯ä¸€æ€§</p>
</li>
<li>
<p>é‚£ä¹ˆè¿™å°±å¼•å‡ºæˆ‘ä»¬çš„</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å…¨å±€IDç”Ÿæˆå™¨</span><br></pre></td></tr></table></figure>
<p>äº†</p>
<ul>
<li>å…¨å±€IDç”Ÿæˆå™¨æ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸€ä¸‹ç‰¹æ€§
<ul>
<li>å”¯ä¸€æ€§</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>é€’å¢æ€§</li>
<li>å®‰å…¨æ€§</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶ä»–ä¿¡æ¯</p>
</li>
<li>
<p>IDç»„æˆéƒ¨åˆ†</p>
<ul>
<li>ç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</li>
<li>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´ï¼ˆ2^31ç§’çº¦ç­‰äº69å¹´ï¼‰</li>
<li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’ä¼ è¾“2^32ä¸ªä¸åŒID</li>
</ul>
</li>
<li>
<p>é‚£æˆ‘ä»¬å°±æ ¹æ®æˆ‘ä»¬åˆ†æçš„IDç”Ÿæˆç­–ç•¥ï¼Œæ¥ç¼–å†™ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸€ä¸‹èµ·å§‹æ—¶é—´ï¼Œæ—¶é—´æˆ³å°±æ˜¯èµ·å§‹æ—¶é—´ä¸å½“å‰æ—¶é—´çš„ç§’æ•°å·®</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">tmp</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2022</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    System.out.println(tmp.toEpochSecond(ZoneOffset.UTC));</span><br><span class="line">    <span class="comment">//ç»“æœä¸º1640995200L</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="comment">//è®¾ç½®èµ·å§‹æ—¶é—´ï¼Œæˆ‘è¿™é‡Œè®¾å®šçš„æ˜¯2022.01.01 00:00:00</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">//åºåˆ—å·é•¿åº¦</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">COUNT_BIT</span> <span class="operator">=</span> <span class="number">32L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span>&#123;</span><br><span class="line">        <span class="comment">//1. ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> currentSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">//2. ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;inc:&quot;</span>+keyPrefix+<span class="string">&quot;:&quot;</span>+date);</span><br><span class="line">        <span class="comment">//3. æ‹¼æ¥å¹¶è¿”å›ï¼Œç®€å•ä½è¿ç®—</span></span><br><span class="line">        <span class="keyword">return</span> timeStamp &lt;&lt; COUNT_BIT | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//CountDownLatchï¼šè®¡æ•°å™¨ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å…¨å±€å”¯ä¸€IDç”Ÿæˆç­–ç•¥</p>
<ul>
<li>UUID</li>
<li>Redisè‡ªå¢</li>
<li>snowflakeç®—æ³•</li>
<li>æ•°æ®åº“è‡ªå¢</li>
</ul>
<p>Redisè‡ªå¢IDç­–ç•¥</p>
<ul>
<li>æ¯å¤©ä¸€ä¸ªkey, æ–¹ä¾¿ç»Ÿè®¡è®¢å•é‡</li>
<li>IDæ„é€ æ˜¯  æ—¶é—´æˆ³ +  è®¡æ•°å™¨</li>
</ul>
<h2 id="æ·»åŠ ä¼˜æƒ åˆ¸">æ·»åŠ ä¼˜æƒ åˆ¸</h2>
<ul>
<li>æ¯ä¸ªåº—é“ºåº¦å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ï¼Œå¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­</li>
<li>tb_voucherï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">ä¸»é”®</td>
</tr>
<tr>
<td style="text-align:center">shop_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">å•†é“ºid</td>
</tr>
<tr>
<td style="text-align:center">title</td>
<td style="text-align:center">varchar(255)</td>
<td style="text-align:center">utf8mb4_general_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ä»£é‡‘åˆ¸æ ‡é¢˜</td>
</tr>
<tr>
<td style="text-align:center">sub_title</td>
<td style="text-align:center">varchar(255)</td>
<td style="text-align:center">utf8mb4_general_ci</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">å‰¯æ ‡é¢˜</td>
</tr>
<tr>
<td style="text-align:center">rules</td>
<td style="text-align:center">varchar(1024)</td>
<td style="text-align:center">utf8mb4_general_ci</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ä½¿ç”¨è§„åˆ™</td>
</tr>
<tr>
<td style="text-align:center">pay_value</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">æ”¯ä»˜é‡‘é¢ï¼Œå•ä½æ˜¯åˆ†ã€‚ä¾‹å¦‚200ä»£è¡¨2å…ƒ</td>
</tr>
<tr>
<td style="text-align:center">actual_value</td>
<td style="text-align:center">bigint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">æŠµæ‰£é‡‘é¢ï¼Œå•ä½æ˜¯åˆ†ã€‚ä¾‹å¦‚200ä»£è¡¨2å…ƒ</td>
</tr>
<tr>
<td style="text-align:center">type</td>
<td style="text-align:center">tinyint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">0,æ™®é€šåˆ¸ï¼›1,ç§’æ€åˆ¸</td>
</tr>
<tr>
<td style="text-align:center">status</td>
<td style="text-align:center">tinyint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">1</td>
<td style="text-align:center"></td>
<td style="text-align:center">1,ä¸Šæ¶; 2,ä¸‹æ¶; 3,è¿‡æœŸ</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td style="text-align:center">update_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED on update CURRENT_TIMESTAMP</td>
<td style="text-align:center">æ›´æ–°æ—¶é—´</td>
</tr>
</tbody>
</table>
<ul>
<li>tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ã€‚ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">voucher_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">å…³è”çš„ä¼˜æƒ åˆ¸çš„id</td>
</tr>
<tr>
<td style="text-align:center">stock</td>
<td style="text-align:center">int</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">åº“å­˜</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td style="text-align:center">begin_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">ç”Ÿæ•ˆæ—¶é—´</td>
</tr>
<tr>
<td style="text-align:center">end_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">å¤±æ•ˆæ—¶é—´</td>
</tr>
<tr>
<td style="text-align:center">update_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED on update CURRENT_TIMESTAMP</td>
<td style="text-align:center">æ›´æ–°æ—¶é—´</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>å¹³ä»·åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä»»æ„é¢†å–</p>
</li>
<li>
<p>è€Œä»£é‡‘åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¤§ï¼Œæ‰€ä»¥åƒç¬¬äºŒç§åˆ¸ï¼Œå°±å¾—é™åˆ¶æ•°é‡ï¼Œä»è¡¨ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºï¼Œç‰¹ä»·åˆ¸é™¤äº†å…·æœ‰ä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å…·æœ‰åº“å­˜ï¼ŒæŠ¢è´­æ—¶é—´ï¼Œç»“æŸæ—¶é—´ç­‰ç­‰å­—æ®µ</p>
</li>
<li>
<p>æ·»åŠ ä¼˜æƒ åˆ¸çš„ä»£ç å·²ç»æä¾›å¥½äº†</p>
<ul>
<li>æ–°å¢æ™®é€šåˆ¸</li>
<li>æ–°å¢ç§’æ€åˆ¸</li>
<li>æ–°å¢ç§’æ€åˆ¸ä¸šåŠ¡é€»è¾‘</li>
</ul>
<p>æ–°å¢æ™®é€šåˆ¸ï¼Œä¹Ÿå°±åªæ˜¯å°†æ™®é€šåˆ¸çš„ä¿¡æ¯ä¿å­˜åˆ°è¡¨ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å¢æ™®é€šåˆ¸</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> voucher ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.save(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç”±äºè¿™é‡Œå¹¶æ²¡æœ‰åå°ç®¡ç†é¡µé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”¨POSTMANæ¨¡æ‹Ÿå‘é€è¯·æ±‚æ¥æ–°å¢ç§’æ€åˆ¸ï¼Œè¯·æ±‚è·¯å¾„</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8081</span><span class="regexp">/voucher/</span>seckill</span><br></pre></td></tr></table></figure>
<p>ï¼Œ è¯·æ±‚æ–¹å¼POSTï¼ŒJSONæ•°æ®å¦‚ä¸‹ï¼Œæ³¨æ„ä¼˜æƒ åˆ¸çš„æˆªæ­¢æ—¥æœŸè®¾ç½®ï¼Œè‹¥ä¼˜æƒ åˆ¸è¿‡æœŸï¼Œåˆ™ä¸ä¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shopId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;100å…ƒä»£é‡‘åˆ¸&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subTitle&quot;</span><span class="punctuation">:</span><span class="string">&quot;å‘¨ä¸€è‡³å‘¨äº”å¯ç”¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="string">&quot;å…¨åœºé€šç”¨\\næ— éœ€é¢„çº¦\\nå¯æ— é™å åŠ &quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payValue&quot;</span><span class="punctuation">:</span><span class="number">8000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actualValue&quot;</span><span class="punctuation">:</span><span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beginTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-01-01T00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-10-31T23:59:59&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ•ˆæœå¦‚ä¸‹<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6358bbb316f2c2beb1b7967c.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6358bbb316f2c2beb1b7967c.jpg" alt="img"></a></p>
</li>
</ul>
<h2 id="å®ç°ç§’æ€ä¸‹å•">å®ç°ç§’æ€ä¸‹å•</h2>
<ul>
<li>
<p>æˆ‘ä»¬ç‚¹å‡»</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">é™æ—¶æŠ¢è´­</span><br></pre></td></tr></table></figure>
<p>ï¼Œç„¶åæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">è¯·æ±‚ç½‘å€: http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/api/</span>voucher-order<span class="regexp">/seckill/</span><span class="number">13</span></span><br><span class="line">è¯·æ±‚æ–¹æ³•: POST</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çœ‹æ ·å­æ˜¯</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">VoucherOrderController</span></span><br></pre></td></tr></table></figure>
<p>é‡Œçš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/voucher-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;seckill/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long voucherId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åŠŸèƒ½æœªå®Œæˆ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£æˆ‘ä»¬ç°åœ¨æ¥åˆ†æä¸€ä¸‹æ€ä¹ˆæŠ¢ä¼˜æƒ åˆ¸</p>
<ul>
<li>é¦–å…ˆæäº¤ä¼˜æƒ åˆ¸idï¼Œç„¶åæŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</li>
<li>ä¹‹ååˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹
<ul>
<li>å¼€å§‹äº†ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æœ‰å‰©ä½™åº“å­˜
<ul>
<li>æœ‰åº“å­˜ï¼Œé‚£ä¹ˆåˆ å‡ä¸€ä¸ªåº“å­˜
<ul>
<li>ç„¶ååˆ›å»ºè®¢å•</li>
</ul>
</li>
<li>æ— åº“å­˜ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</li>
</ul>
</li>
<li>æ²¡å¼€å§‹ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å¯¹åº”çš„æµç¨‹å›¾å¦‚ä¸‹<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6358c21a16f2c2beb1bfd43a.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6358c21a16f2c2beb1bfd43a.jpg" alt="img"></a></p>
</li>
<li>
<p>é‚£ç°åœ¨æˆ‘ä»¬å°±æ ¹æ®æˆ‘ä»¬åˆšåˆšçš„åˆ†æå’Œæµç¨‹å›¾ï¼Œæ¥ç¼–å†™å¯¹åº”çš„ä»£ç </p>
<ul>
<li>VoucherOrderController</li>
<li>IVoucherOrderService</li>
<li>VoucherOrderServiceImpl</li>
</ul>
<p>å…·ä½“çš„ä¸šåŠ¡é€»è¾‘æˆ‘ä»¬è¿˜æ˜¯æ”¾åˆ°Serviceå±‚é‡Œå†™ï¼Œåœ¨Serviceå±‚åˆ›å»ºseckillVoucheræ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/voucher-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService voucherOrderService;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/seckill/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long voucherId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> voucherOrderService.seckillVoucher(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨  VoucherOrderServiceImpl  ç±»ä¸­å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  æœåŠ¡å®ç°ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> è™å“¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-12-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//1. æŸ¥è¯¢ä¼˜æƒ ä»·</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//2. åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ´»åŠ¨å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ´»åŠ¨å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6. åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">//6.1 è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextTime(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">//6.2 ç”¨æˆ·id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">//6.3 ä»£é‡‘å·id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//7. è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="è¶…å–é—®é¢˜">è¶…å–é—®é¢˜</h2>
<ul>
<li>
<p>æˆ‘ä»¬ä¹‹å‰çš„ä»£ç å…¶å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå½“é‡åˆ°é«˜å¹¶å‘åœºæ™¯æ—¶ï¼Œä¼šå‡ºç°è¶…å–ç°è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Jmeterå¼€200ä¸ªçº¿ç¨‹æ¥æ¨¡æ‹ŸæŠ¢ä¼˜æƒ åˆ¸çš„åœºæ™¯ï¼ŒURLä¸º localhost:8081/voucher-order/seckill/13ï¼Œè¯·æ±‚æ–¹å¼ä¸ºPOST</p>
<p>æ³¨æ„ä½¿ç”¨Jmeterè¿›è¡Œå‹æµ‹æ—¶ï¼Œéœ€è¦æºå¸¦æˆ‘ä»¬ç™»å½•çš„token<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635a168316f2c2beb193f83d.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635a168316f2c2beb193f83d.jpg" alt="img"></a></p>
</li>
<li>
<p>æµ‹è¯•å®Œæ¯•ä¹‹åï¼ŒæŸ¥çœ‹æ•°æ®åº“ä¸­çš„è®¢å•è¡¨ï¼Œæˆ‘ä»¬æ˜æ˜åªè®¾ç½®äº†100å¼ ä¼˜æƒ åˆ¸ï¼Œå´æœ‰166æ¡æ•°æ®ï¼Œå»ä¼˜æƒ åˆ¸è¡¨æŸ¥çœ‹ï¼Œåº“å­˜ä¸º-66ï¼Œè¶…å–äº†66å¼ <br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635a16d316f2c2beb19443a7.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635a16d316f2c2beb19443a7.jpg" alt="img"></a></p>
</li>
<li>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå…ˆæ¥çœ‹çœ‹æˆ‘ä»¬çš„ä»£ç ä¸­æ˜¯æ€ä¹ˆå†™çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (seckillVoucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update().setSql(<span class="string">&quot;stock = stock - 1&quot;</span>).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line"><span class="keyword">if</span> (!success) &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å‡è®¾ç°åœ¨åªå‰©ä¸‹ä¸€å¼ ä¼˜æƒ åˆ¸ï¼Œçº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­åº“å­˜æ•°å¤§äº1ï¼Œä½†è¿˜æ²¡æ¥å¾—åŠå»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶åº“çº¿ç¨‹2ä¹Ÿè¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°åº“å­˜æ•°ä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šè¿›è¡Œæ‰£å‡åº“å­˜æ“ä½œï¼Œæœ€ç»ˆç›¸å½“äºæ˜¯å¤šä¸ªçº¿ç¨‹éƒ½è¿›è¡Œäº†æ‰£å‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šå‡ºç°è¶…å–é—®é¢˜</p>
</li>
<li>
<p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ</p>
<ol>
<li>æ‚²è§‚é”
<ul>
<li>æ‚²è§‚é”è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ</li>
<li>ä¾‹å¦‚Synchronizedã€Lockç­‰ï¼Œéƒ½æ˜¯æ‚²è§‚é”</li>
</ul>
</li>
<li>ä¹è§‚é”
<ul>
<li>ä¹è§‚é”è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å†å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹
<ul>
<li>å¦‚æœæ²¡æœ‰ä¿®æ”¹ï¼Œåˆ™è®¤ä¸ºè‡ªå·±æ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰å¯ä»¥æ›´æ–°æ•°æ®</li>
<li>å¦‚æœå·²ç»è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–è€…å¼‚å¸¸</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>æ‚²è§‚é”ï¼šæ‚²è§‚é”å¯ä»¥å®ç°å¯¹äºæ•°æ®çš„ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯”å¦‚synï¼Œå’Œlockéƒ½æ˜¯æ‚²è§‚é”çš„ä»£è¡¨ï¼ŒåŒæ—¶ï¼Œæ‚²è§‚é”ä¸­åˆå¯ä»¥å†ç»†åˆ†ä¸ºå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥é”ï¼Œç­‰ç­‰</p>
</li>
<li>
<p>ä¹è§‚é”ï¼šä¹è§‚é”ä¼šæœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®ä¼šå¯¹ç‰ˆæœ¬å·+1ï¼Œå†æäº¤å›æ•°æ®æ—¶ï¼Œä¼šå»æ ¡éªŒæ˜¯å¦æ¯”ä¹‹å‰çš„ç‰ˆæœ¬å¤§1 ï¼Œå¦‚æœå¤§1 ï¼Œåˆ™è¿›è¡Œæ“ä½œæˆåŠŸï¼Œè¿™å¥—æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘åœ¨äºï¼Œå¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œç‰ˆæœ¬å·åªæ¯”åŸæ¥å¤§1 ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰äººå¯¹ä»–è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œä»–çš„æ“ä½œå°±æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å¤§1ï¼Œåˆ™æ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œå½“ç„¶ä¹è§‚é”è¿˜æœ‰ä¸€äº›å˜ç§çš„å¤„ç†æ–¹å¼æ¯”å¦‚CAS</p>
</li>
<li>
<p>ä¹è§‚é”çš„å…¸å‹ä»£è¡¨ï¼šå°±æ˜¯CAS(Compare-And-Swap)ï¼Œåˆ©ç”¨CASè¿›è¡Œæ— é”åŒ–æœºåˆ¶åŠ é”ï¼Œvar5 æ˜¯æ“ä½œå‰è¯»å–çš„å†…å­˜å€¼ï¼Œwhileä¸­çš„var1+var2 æ˜¯é¢„ä¼°å€¼ï¼Œå¦‚æœé¢„ä¼°å€¼ == å†…å­˜å€¼ï¼Œåˆ™ä»£è¡¨ä¸­é—´æ²¡æœ‰è¢«äººä¿®æ”¹è¿‡ï¼Œæ­¤æ—¶å°±å°†æ–°å€¼å»æ›¿æ¢ å†…å­˜å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> var5;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">&#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"><span class="keyword">return</span> var5;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…¶ä¸­do whileæ˜¯ä¸ºäº†æ“ä½œå¤±è´¥æ—¶ï¼Œå†æ¬¡è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œå³æŠŠä¹‹å‰çš„é€»è¾‘å†æ“ä½œä¸€æ¬¡</p>
</li>
</ul>
<hr>
<ul>
<li>
<p>è¯¥é¡¹ç›®ä¸­çš„å…·ä½“è§£å†³æ–¹å¼</p>
</li>
<li>
<p>è¿™é‡Œå¹¶ä¸éœ€è¦çœŸçš„æ¥æŒ‡å®šä¸€ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç‰ˆæœ¬å·</span><br></pre></td></tr></table></figure>
<p>ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stock</span></span><br></pre></td></tr></table></figure>
<p>æ¥å……å½“ç‰ˆæœ¬å·ï¼Œåœ¨æ‰£å‡åº“å­˜æ—¶ï¼Œæ¯”è¾ƒæŸ¥è¯¢åˆ°çš„ä¼˜æƒ åˆ¸åº“å­˜å’Œå®é™…æ•°æ®åº“ä¸­ä¼˜æƒ åˆ¸åº“å­˜æ˜¯å¦ç›¸åŒ</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Result seckillVoucher(Long voucherId) &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">    //1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span><br><span class="line">    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">    //2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span><br><span class="line">    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">        return Result.fail(&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span><br><span class="line">    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">        return Result.fail(&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span><br><span class="line">    if (seckillVoucher.getStock() &lt; 1) &#123;</span><br><span class="line">        return Result.fail(&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //5. æ‰£å‡åº“å­˜</span><br><span class="line">    boolean success = seckillVoucherService.update()</span><br><span class="line">            .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="line">            .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="line"><span class="addition">+           .eq(&quot;stock&quot;,seckillVoucher.getStock())</span></span><br><span class="line">            .update();</span><br><span class="line">    if (!success) &#123;</span><br><span class="line">        return Result.fail(&quot;åº“å­˜ä¸è¶³&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //6. åˆ›å»ºè®¢å•</span><br><span class="line">    VoucherOrder voucherOrder = new VoucherOrder();</span><br><span class="line">    //6.1 è®¾ç½®è®¢å•id</span><br><span class="line">    long orderId = redisIdWorker.nextId(&quot;order&quot;);</span><br><span class="line">    //6.2 è®¾ç½®ç”¨æˆ·id</span><br><span class="line">    Long id = UserHolder.getUser().getId();</span><br><span class="line">    //6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(id);</span><br><span class="line">    //7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    //8. è¿”å›è®¢å•id</span><br><span class="line">    return Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»¥ä¸Šé€»è¾‘çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šåªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šè¿™ç§æ–¹å¼é€šè¿‡æµ‹è¯•å‘ç°ä¼šæœ‰å¾ˆå¤šå¤±è´¥çš„æƒ…å†µï¼Œå¤±è´¥çš„åŸå› åœ¨äºï¼šåœ¨ä½¿ç”¨ä¹è§‚é”è¿‡ç¨‹ä¸­å‡è®¾100ä¸ªçº¿ç¨‹åŒæ—¶éƒ½æ‹¿åˆ°äº†100çš„åº“å­˜ï¼Œç„¶åå¤§å®¶ä¸€èµ·å»è¿›è¡Œæ‰£å‡ï¼Œä½†æ˜¯100ä¸ªäººä¸­åªæœ‰1ä¸ªäººèƒ½æ‰£å‡æˆåŠŸï¼Œå…¶ä»–çš„äººåœ¨å¤„ç†æ—¶ï¼Œä»–ä»¬åœ¨æ‰£å‡æ—¶ï¼Œåº“å­˜å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å…¶ä»–çº¿ç¨‹éƒ½ä¼šå¤±è´¥<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635a30ca16f2c2beb1ba8efd.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635a30ca16f2c2beb1ba8efd.jpg" alt="img"></a></p>
</li>
<li>
<p>é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­å®Œå–„ä»£ç ï¼Œä¿®æ”¹æˆ‘ä»¬çš„é€»è¾‘ï¼Œåœ¨è¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥åªåˆ¤æ–­æ˜¯å¦æœ‰å‰©ä½™ä¼˜æƒ åˆ¸ï¼Œå³åªè¦æ•°æ®åº“ä¸­çš„åº“å­˜å¤§äº0ï¼Œéƒ½èƒ½é¡ºåˆ©å®Œæˆæ‰£å‡åº“å­˜æ“ä½œ</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Result seckillVoucher(Long voucherId) &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">    //1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span><br><span class="line">    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">    //2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span><br><span class="line">    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">        return Result.fail(&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span><br><span class="line">    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">        return Result.fail(&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span><br><span class="line">    if (seckillVoucher.getStock() &lt; 1) &#123;</span><br><span class="line">        return Result.fail(&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //5. æ‰£å‡åº“å­˜</span><br><span class="line">    boolean success = seckillVoucherService.update()</span><br><span class="line">            .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="line">            .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="line"><span class="deletion">-           .eq(&quot;stock&quot;,seckillVoucher.getStock())</span></span><br><span class="line"><span class="addition">+           .gt(&quot;stock&quot;, 0)</span></span><br><span class="line">            .update();</span><br><span class="line">    if (!success) &#123;</span><br><span class="line">        return Result.fail(&quot;åº“å­˜ä¸è¶³&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //6. åˆ›å»ºè®¢å•</span><br><span class="line">    VoucherOrder voucherOrder = new VoucherOrder();</span><br><span class="line">    //6.1 è®¾ç½®è®¢å•id</span><br><span class="line">    long orderId = redisIdWorker.nextId(&quot;order&quot;);</span><br><span class="line">    //6.2 è®¾ç½®ç”¨æˆ·id</span><br><span class="line">    Long id = UserHolder.getUser().getId();</span><br><span class="line">    //6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(id);</span><br><span class="line">    //7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    //8. è¿”å›è®¢å•id</span><br><span class="line">    return Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡å¯æœåŠ¡å™¨ï¼Œç»§ç»­ä½¿ç”¨Jmeterè¿›è¡Œæµ‹è¯•ï¼Œè¿™æ¬¡å°±èƒ½é¡ºåˆ©å°†ä¼˜æƒ åˆ¸åˆšå¥½æŠ¢ç©ºäº†</p>
</li>
</ul>
<h2 id="ä¸€äººä¸€å•">ä¸€äººä¸€å•</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½æŠ¢ä¸€å¼ </p>
</li>
<li>
<p>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæˆ‘ä»¬åœ¨åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ä¹‹åï¼Œæ ¹æ®æˆ‘ä»¬ä¿å­˜çš„è®¢å•æ•°æ®ï¼Œåˆ¤æ–­ç”¨æˆ·è®¢å•æ˜¯å¦å·²å­˜åœ¨</p>
<ul>
<li>å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™ä¸èƒ½ä¸‹å•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç»§ç»­ä¸‹å•ï¼Œè·å–ä¼˜æƒ åˆ¸</li>
</ul>
</li>
<li>
<p>åˆæ­¥ä»£ç </p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public Result seckillVoucher(Long voucherId) &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">        //1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span><br><span class="line">        queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">        SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">        //2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span><br><span class="line">        if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">            return Result.fail(&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span><br><span class="line">        if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">            return Result.fail(&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span><br><span class="line">        if (seckillVoucher.getStock() &lt; 1) &#123;</span><br><span class="line">            return Result.fail(&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="addition">+       // ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line"><span class="addition">+       Long userId = UserHolder.getUser().getId();</span></span><br><span class="line"><span class="addition">+       int count = query().eq(&quot;voucher_id&quot;, voucherId).eq(&quot;user_id&quot;, userId).count();</span></span><br><span class="line"><span class="addition">+       if (count &gt; 0)&#123;</span></span><br><span class="line"><span class="addition">+           return Result.fail(&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;);</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line">        //5. æ‰£å‡åº“å­˜</span><br><span class="line">        boolean success = seckillVoucherService.update()</span><br><span class="line">                .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="line">                .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="line">                .gt(&quot;stock&quot;, 0)</span><br><span class="line">                .update();</span><br><span class="line">        if (!success) &#123;</span><br><span class="line">            return Result.fail(&quot;åº“å­˜ä¸è¶³&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //6. åˆ›å»ºè®¢å•</span><br><span class="line">        VoucherOrder voucherOrder = new VoucherOrder();</span><br><span class="line">        //6.1 è®¾ç½®è®¢å•id</span><br><span class="line">        long orderId = redisIdWorker.nextId(&quot;order&quot;);</span><br><span class="line">        //6.2 è®¾ç½®ç”¨æˆ·id</span><br><span class="line">        Long id = UserHolder.getUser().getId();</span><br><span class="line">        //6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setUserId(id);</span><br><span class="line">        //7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        //8. è¿”å›è®¢å•id</span><br><span class="line">        return Result.ok(orderId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>å­˜åœ¨é—®é¢˜</code>ï¼šè¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¦‚æœè¿™ä¸ªç”¨æˆ·æ•…æ„å¼€å¤šçº¿ç¨‹æŠ¢ä¼˜æƒ åˆ¸ï¼Œé‚£ä¹ˆåœ¨åˆ¤æ–­åº“å­˜å……è¶³ä¹‹åï¼Œæ‰§è¡Œä¸€äººä¸€å•é€»è¾‘ä¹‹å‰ï¼Œåœ¨è¿™ä¸ªåŒºé—´å¦‚æœè¿›æ¥äº†å¤šä¸ªçº¿ç¨‹ï¼Œè¿˜æ˜¯å¯ä»¥æŠ¢å¤šå¼ ä¼˜æƒ åˆ¸çš„ï¼Œé‚£æˆ‘ä»¬è¿™é‡Œä½¿ç”¨æ‚²è§‚é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
</li>
<li>
<p>åˆæ­¥ä»£ç ï¼Œæˆ‘ä»¬æŠŠä¸€äººä¸€å•é€»è¾‘ä¹‹åçš„ä»£ç éƒ½æå–åˆ°ä¸€ä¸ª<code>createVoucherOrder</code>æ–¹æ³•ä¸­ï¼Œç„¶åç»™è¿™ä¸ªæ–¹æ³•åŠ é”</p>
</li>
<li>
<p>ä¸ç®¡å“ªä¸€ä¸ªçº¿ç¨‹ï¼ˆä¾‹å¦‚çº¿ç¨‹Aï¼‰ï¼Œè¿è¡Œåˆ°è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œéƒ½è¦æ£€æŸ¥æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹Bï¼ˆæˆ–è€…Cã€ Dç­‰ï¼‰æ­£åœ¨ç”¨è¿™ä¸ªæ–¹æ³•(æˆ–è€…è¯¥ç±»çš„å…¶ä»–åŒæ­¥æ–¹æ³•)ï¼Œæœ‰çš„è¯è¦ç­‰æ­£åœ¨ä½¿ç”¨synchronizedæ–¹æ³•çš„çº¿ç¨‹Bï¼ˆæˆ–è€…C ã€Dï¼‰è¿è¡Œå®Œè¿™ä¸ªæ–¹æ³•åå†è¿è¡Œæ­¤çº¿ç¨‹Aï¼Œæ²¡æœ‰çš„è¯ï¼Œé”å®šè°ƒç”¨è€…ï¼Œç„¶åç›´æ¥è¿è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            .update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">//6.1 è®¾ç½®è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//6.2 è®¾ç½®ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(id);</span><br><span class="line">    <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//8. è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯è¿™æ ·åŠ é”ï¼Œé”çš„ç»†ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”çš„è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶é”ç²’åº¦æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šè¢«é”ä½ï¼Œç°åœ¨çš„æƒ…å†µå°±æ˜¯æ‰€æœ‰ç”¨æˆ·éƒ½å…¬ç”¨è¿™ä¸€æŠŠé”ï¼Œä¸²è¡Œæ‰§è¡Œï¼Œæ•ˆç‡å¾ˆä½ï¼Œæˆ‘ä»¬ç°åœ¨è¦å®Œæˆçš„ä¸šåŠ¡æ˜¯</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸€äººä¸€å•</span><br></pre></td></tr></table></figure>
<p>ï¼Œæ‰€ä»¥è¿™ä¸ªé”ï¼Œåº”è¯¥åªåŠ åœ¨å•ä¸ªç”¨æˆ·ä¸Šï¼Œç”¨æˆ·æ ‡è¯†å¯ä»¥ç”¨</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">userId</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6. åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">//6.1 è®¾ç½®è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        <span class="comment">//6.2 è®¾ç½®ç”¨æˆ·id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setUserId(id);</span><br><span class="line">        <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//8. è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œåˆ°è¿™é‡Œï¼Œé”å·²ç»è¢«é‡Šæ”¾äº†ï¼Œä½†æ˜¯å¯èƒ½å½“å‰äº‹åŠ¡è¿˜æœªæäº¤ï¼Œå¦‚æœæ­¤æ—¶æœ‰çº¿ç¨‹è¿›æ¥ï¼Œä¸èƒ½ç¡®ä¿äº‹åŠ¡ä¸å‡ºé—®é¢˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç”±äºtoStringçš„æºç æ˜¯new Stringï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åªç”¨</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">user</span>Id.<span class="keyword">to</span>String()</span><br></pre></td></tr></table></figure>
<p>æ‹¿åˆ°çš„ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªç”¨æˆ·ï¼Œéœ€è¦ä½¿ç”¨</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">intern</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>ï¼Œå¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»åŒ…å«äº†ä¸€ä¸ªç­‰äºè¿™ä¸ªstringå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼ˆç”±equalsï¼ˆobjectï¼‰æ–¹æ³•ç¡®å®šï¼‰ï¼Œé‚£ä¹ˆå°†è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œå°†æ­¤Stringå¯¹è±¡æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶è¿”å›å¯¹æ­¤Stringå¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toString</span><span class="params">(<span class="type">long</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == Long.MIN_VALUE)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-9223372036854775808&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> (i &lt; <span class="number">0</span>) ? stringSize(-i) + <span class="number">1</span> : stringSize(i);</span><br><span class="line">    <span class="type">char</span>[] buf = <span class="keyword">new</span> <span class="title class_">char</span>[size];</span><br><span class="line">    getChars(i, size, buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯ä»¥ä¸Šä»£ç è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œé—®é¢˜çš„åŸå› åœ¨äºå½“å‰æ–¹æ³•è¢«Springçš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾äº†ï¼Œè¿™æ ·ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å°†å½“å‰æ–¹æ³•æ•´ä½“åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿äº‹åŠ¡ä¸ä¼šå‡ºç°é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">        <span class="keyword">return</span> createVoucherOrder(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯ä»¥ä¸Šåšæ³•ä¾ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯this.çš„æ–¹å¼è°ƒç”¨çš„ï¼Œäº‹åŠ¡æƒ³è¦ç”Ÿæ•ˆï¼Œè¿˜å¾—åˆ©ç”¨ä»£ç†æ¥ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—åŸå§‹çš„äº‹åŠ¡å¯¹è±¡ï¼Œ æ¥æ“ä½œäº‹åŠ¡ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">AopContext</span>.</span></span>current<span class="constructor">Proxy()</span></span><br></pre></td></tr></table></figure>
<p>æ¥è·å–å½“å‰å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åå†ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œè®°å¾—è¦å»</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">IVoucherOrderService</span></span><br></pre></td></tr></table></figure>
<p>ä¸­åˆ›å»º</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">createVoucherOrder</span></span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"><span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">    <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯è¯¥æ–¹æ³•ä¼šç”¨åˆ°ä¸€ä¸ªä¾èµ–ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥ä¸€ä¸‹</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åŒæ—¶åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="constructor">EnableAspectJAutoProxy(<span class="params">exposeProxy</span> = <span class="params">true</span>)</span></span><br></pre></td></tr></table></figure>
<p>æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;com.hmdp.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HmDianPingApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HmDianPingApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡å¯æœåŠ¡å™¨ï¼Œå†æ¬¡ä½¿ç”¨Jmeteræµ‹è¯•ï¼Œ200ä¸ªçº¿ç¨‹å¹¶å‘ï¼Œä½†æ˜¯åªèƒ½æŠ¢åˆ°ä¸€å¼ ä¼˜æƒ åˆ¸ï¼Œç›®çš„è¾¾æˆ</p>
</li>
</ul>
<h2 id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h2>
<ul>
<li>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†
<ol>
<li>æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082</li>
<li>ç„¶åä¿®æ”¹nginxçš„configç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼ˆé»˜è®¤è½®è¯¢å°±è¡Œï¼‰</li>
</ol>
</li>
<li>å…·ä½“æ“ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨<code>POSTMAN</code>å‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œheaderæºå¸¦åŒä¸€ç”¨æˆ·çš„tokenï¼Œå°è¯•ç”¨åŒä¸€è´¦å·æŠ¢ä¸¤å¼ ä¼˜æƒ åˆ¸ï¼Œå‘ç°æ˜¯å¯è¡Œçš„ã€‚</li>
<li>å¤±è´¥åŸå› åˆ†æï¼šç”±äºæˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªTomcatï¼Œæ¯ä¸ªTomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„Tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œå³çº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ã€‚ä½†æ˜¯å¦‚æœåœ¨Tomcatçš„å†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡è™½ç„¶å†™çš„å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2äº’æ–¥<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635a5e3e16f2c2beb1289579.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635a5e3e16f2c2beb1289579.jpg" alt="img"></a></li>
<li>è¿™å°±æ˜¯é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©é”ä¸å­˜åœ¨äºæ¯ä¸ªjvmçš„å†…éƒ¨ï¼Œè€Œæ˜¯è®©æ‰€æœ‰jvmå…¬ç”¨å¤–éƒ¨çš„ä¸€æŠŠé”ï¼ˆRedisï¼‰</li>
</ul>
<h1>åˆ†å¸ƒå¼é”</h1>
<h2 id="åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”">åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</h2>
<ul>
<li>
<p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šçº¿ç¨‹è¯¾ä»¶å¹¶ä¸”å¯ä»¥äº’æ–¥çš„é”</p>
</li>
<li>
<p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶å…±ç”¨åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635a5e5516f2c2beb1292f05.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635a5e5516f2c2beb1292f05.jpg" alt="img"></a></p>
</li>
<li>
<p>é‚£ä¹ˆåˆ†å¸ƒå¼é”åº”è¯¥æ»¡è¶³ä¸€äº›ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿ</p>
<ol>
<li>
<p>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœã€‚</p>
<p>æ³¨æ„ï¼šè¿™é‡Œè¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€</p>
</li>
<li>
<p>äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ</p>
</li>
<li>
<p>é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§</p>
</li>
<li>
<p>é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€ä»¥å¯¹äºåˆ†å¸ƒå¼é”éœ€è¦ä»–è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½</p>
</li>
<li>
<p>å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</p>
</li>
</ol>
</li>
<li>
<p>å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</p>
<ol>
<li>MySQLï¼šMySQLæœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äºMySQLçš„æ€§èƒ½ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨MySQLä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§</li>
<li>Redisï¼šRedisä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½æ˜¯ç”¨Redisæˆ–è€…Zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨<code>SETNX</code>è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥KeyæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œé‚£ä¹ˆå…¶ä»–äººå°±å›æ’å…¥å¤±è´¥ï¼Œæ— æ³•è·å–åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘å®Œæˆ<code>äº’æ–¥</code>ï¼Œä»è€Œå®ç°åˆ†å¸ƒå¼é”</li>
<li>Zookeeperï¼šZookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ç§å®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œä½†æœ¬æ–‡æ˜¯å­¦Redisçš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">MySQL</th>
<th style="text-align:center">Redis</th>
<th style="text-align:center">Zookeeper</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">äº’æ–¥</td>
<td style="text-align:center">åˆ©ç”¨mysqlæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td>
<td style="text-align:center">åˆ©ç”¨setnxè¿™æ ·çš„äº’æ–¥å‘½ä»¤</td>
<td style="text-align:center">åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td>
</tr>
<tr>
<td style="text-align:center">é«˜å¯ç”¨</td>
<td style="text-align:center">å¥½</td>
<td style="text-align:center">å¥½</td>
<td style="text-align:center">å¥½</td>
</tr>
<tr>
<td style="text-align:center">é«˜æ€§èƒ½</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">å¥½</td>
<td style="text-align:center">ä¸€èˆ¬</td>
</tr>
<tr>
<td style="text-align:center">å®‰å…¨æ€§</td>
<td style="text-align:center">æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td>
<td style="text-align:center">åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td>
<td style="text-align:center">ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td>
</tr>
</tbody>
</table>
<h2 id="Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯">Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯</h2>
<ul>
<li>
<p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•</p>
<ol>
<li>
<p>è·å–é”</p>
<ul>
<li>
<p>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</p>
</li>
<li>
<p>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ é”, NXæ˜¯äº’æ–¥, EXæ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">SET lock thread01 NX EX 10</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>é‡Šæ”¾é”</p>
<ul>
<li>
<p>æ‰‹åŠ¨é‡Šæ”¾</p>
</li>
<li>
<p>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”çš„æ—¶å€™æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡Šæ”¾é”, åˆ é™¤å³å¯</span></span><br><span class="line">DEL lock</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>æ ¸å¿ƒæ€è·¯</p>
<ul>
<li>æˆ‘ä»¬åˆ©ç”¨redisçš„<code>SETNX</code>æ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•æ¥è·å–é”ã€‚ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkeyäº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”ï¼ˆè¿”å›äº†0ï¼‰çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´ä¹‹åé‡è¯•</li>
</ul>
</li>
</ul>
<h2 id="å®ç°åˆ†å¸ƒå¼é”">å®ç°åˆ†å¸ƒå¼é”</h2>
<ul>
<li>
<p>é”çš„åŸºæœ¬æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSec é”æŒæœ‰çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸè‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> trueè¡¨ç¤ºè·å–é”æˆåŠŸï¼Œfalseè¡¨ç¤ºè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªSimpleRedisLockç±»å®ç°æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">//é”çš„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="comment">//å…·ä½“ä¸šåŠ¡åç§°ï¼Œå°†å‰ç¼€å’Œä¸šåŠ¡åæ‹¼æ¥ä¹‹åå½“åšKey</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¸æ˜¯@Autowiredæ³¨å…¥ï¼Œé‡‡ç”¨çš„æ˜¯æ„é€ å™¨æ³¨å…¥ï¼Œåœ¨åˆ›å»ºSimpleRedisLockæ—¶ï¼Œå°†RedisTemplateä½œä¸ºå‚æ•°ä¼ å…¥</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–é”ï¼Œä½¿ç”¨SETNXæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//è‡ªåŠ¨æ‹†ç®±å¯èƒ½ä¼šå‡ºç°nullï¼Œè¿™æ ·å†™æ›´ç¨³å¦¥</span></span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡DELæ¥åˆ é™¤é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹ä¸šåŠ¡ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">SimpleRedisLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">    <span class="comment">// è·å–é”å¯¹è±¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock(<span class="number">120</span>);</span><br><span class="line">    <span class="comment">// åŠ é”å¤±è´¥ï¼Œè¯´æ˜å½“å‰ç”¨æˆ·å¼€äº†å¤šä¸ªçº¿ç¨‹æŠ¢ä¼˜æƒ åˆ¸ï¼Œä½†æ˜¯ç”±äºkeyæ˜¯SETNXçš„ï¼Œæ‰€ä»¥ä¸èƒ½åˆ›å»ºkeyï¼Œå¾—ç­‰keyçš„TTLåˆ°æœŸæˆ–é‡Šæ”¾é”ï¼ˆåˆ é™¤keyï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸æŠ¢å¤šå¼ ä¼˜æƒ åˆ¸&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œè¯·æ±‚å¤´ä¸­æºå¸¦ç™»å½•ç”¨æˆ·çš„tokenï¼Œæœ€ç»ˆåªèƒ½æŠ¢åˆ°ä¸€å¼ ä¼˜æƒ åˆ¸</p>
</li>
</ul>
<h2 id="Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜">Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</h2>
<ul>
<li>
<pre><code>é€»è¾‘è¯´æ˜
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  -</span> æŒæœ‰é”çš„çº¿ç¨‹1åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”TTLåˆ°æœŸï¼Œè‡ªåŠ¨é‡Šæ”¾</span><br><span class="line"><span class="bullet">  -</span> æ­¤æ—¶çº¿ç¨‹2ä¹Ÿæ¥å°è¯•è·å–é”ï¼Œç”±äºçº¿ç¨‹1å·²ç»é‡Šæ”¾äº†é”ï¼Œæ‰€ä»¥çº¿ç¨‹2å¯ä»¥æ‹¿åˆ°</span><br><span class="line"><span class="bullet">  -</span> ä½†æ˜¯ç°åœ¨çº¿ç¨‹1é˜»å¡å®Œäº†ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè¦å¼€å§‹é‡Šæ”¾é”äº†</span><br><span class="line"><span class="bullet">  -</span> é‚£ä¹ˆæ­¤æ—¶å°±ä¼šå°†å±äºçº¿ç¨‹2çš„é”é‡Šæ”¾ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µ</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">```</span></span><br><span class="line"><span class="code">  è§£å†³æ–¹æ¡ˆ</span></span><br></pre></td></tr></table></figure>

- è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œéƒ½åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªé”æ˜¯ä¸æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœä¸å±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤æ“ä½œã€‚
- å‡è®¾è¿˜æ˜¯ä¸Šé¢çš„æƒ…å†µï¼Œçº¿ç¨‹1é˜»å¡ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1é˜»å¡å®Œäº†ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¼€å§‹åˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1å‘ç°è¿™æŠŠé”ä¸æ˜¯è‡ªå·±çš„ï¼Œæ‰€ä»¥ä¸è¿›è¡Œåˆ é™¤é”çš„é€»è¾‘ï¼Œå½“çº¿ç¨‹2æ‰§è¡Œåˆ°åˆ é™¤é”çš„é€»è¾‘æ—¶ï¼Œå¦‚æœTTLè¿˜æœªåˆ°æœŸï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯è‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”
  [![img](https://pic1.imgdb.cn/item/635aa1b016f2c2beb1e68e4f.jpg)](https://pic1.imgdb.cn/item/635aa1b016f2c2beb1e68e4f.jpg)

</code></pre>
</li>
</ul>
<h2 id="è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜">è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°</p>
</li>
<li>
<p>æ»¡è¶³ï¼šåœ¨è·å–é”çš„æ—¶å€™å­˜å…¥çº¿ç¨‹æ ‡è¯†ï¼ˆç”¨UUIDæ ‡è¯†ï¼Œåœ¨ä¸€ä¸ªJVMä¸­ï¼ŒThreadIdä¸€èˆ¬ä¸ä¼šé‡å¤ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ˜¯é›†ç¾¤æ¨¡å¼ï¼Œæœ‰å¤šä¸ªJVMï¼Œå¤šä¸ªJVMä¹‹é—´å¯èƒ½ä¼šå‡ºç°ThreadIdé‡å¤çš„æƒ…å†µï¼‰ï¼Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™å…ˆè·å–é”çš„çº¿ç¨‹æ ‡è¯†ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡è¯†ä¸€è‡´</p>
<ul>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li>
</ul>
</li>
<li>
<p>æ ¸å¿ƒé€»è¾‘ï¼šåœ¨å­˜å…¥é”çš„æ—¶å€™ï¼Œæ”¾å…¥è‡ªå·±çš„çº¿ç¨‹æ ‡è¯†ï¼Œåœ¨åˆ é™¤é”çš„æ—¶å€™ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯ä¸æ˜¯è‡ªå·±å­˜å…¥çš„</p>
<ul>
<li>å¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œåˆ é™¤</li>
<li>å¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤</li>
</ul>
</li>
<li>
<p>å…·ä½“å®ç°ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„æ ‡è¯†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­çš„æ ‡è¯†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ ‡è¯†æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> (threadId.equals(id)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜">åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h2>
<ul>
<li>æ›´ä¸ºæç«¯çš„è¯¯åˆ é€»è¾‘è¯´æ˜</li>
<li>å‡è®¾çº¿ç¨‹1å·²ç»è·å–äº†é”ï¼Œåœ¨åˆ¤æ–­æ ‡è¯†ä¸€è‡´ä¹‹åï¼Œå‡†å¤‡é‡Šæ”¾é”çš„æ—¶å€™ï¼Œåˆå‡ºç°äº†é˜»å¡ï¼ˆä¾‹å¦‚JVMåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰</li>
<li>äºæ˜¯é”çš„TTLåˆ°æœŸäº†ï¼Œè‡ªåŠ¨é‡Šæ”¾äº†</li>
<li>é‚£ä¹ˆç°åœ¨çº¿ç¨‹2è¶è™šè€Œå…¥ï¼Œæ‹¿åˆ°äº†ä¸€æŠŠé”</li>
<li>ä½†æ˜¯çº¿ç¨‹1çš„é€»è¾‘è¿˜æ²¡æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šæ‰§è¡Œåˆ é™¤é”çš„é€»è¾‘</li>
<li>ä½†æ˜¯åœ¨é˜»å¡å‰çº¿ç¨‹1å·²ç»åˆ¤æ–­äº†æ ‡è¯†ä¸€è‡´ï¼Œæ‰€ä»¥ç°åœ¨çº¿ç¨‹1æŠŠçº¿ç¨‹2çš„é”ç»™åˆ äº†</li>
<li>é‚£ä¹ˆå°±ç›¸å½“äºåˆ¤æ–­æ ‡è¯†é‚£è¡Œä»£ç æ²¡æœ‰èµ·åˆ°ä½œç”¨</li>
<li>è¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜</li>
<li>å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œåˆ¤æ–­æ ‡è¯†ï¼Œåˆ é”ï¼Œä¸æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é˜²æ­¢åˆšåˆšçš„æƒ…å†µ</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635c85c916f2c2beb1236040.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635c85c916f2c2beb1236040.jpg" alt="img"></a></p>
<h2 id="Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜">Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h2>
<ul>
<li>
<p>Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚</p>
</li>
<li>
<p>Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¯ä»¥ä¸Šèœé¸Ÿæ•™ç¨‹çœ‹çœ‹ï¼Œé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">https://www.runoob.com/lua/lua-tutorial.html</a></p>
</li>
<li>
<p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Luaå»æ“ä½œRedisï¼Œè€Œä¸”è¿˜èƒ½ä¿è¯å®ƒçš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°<code>æ‹¿é”</code>ï¼Œ<code>åˆ¤æ–­æ ‡è¯†</code>ï¼Œ<code>åˆ é”</code>æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†</p>
</li>
<li>
<p>Redisæä¾›çš„è°ƒç”¨å‡½æ•°è¯­æ³•å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>,<span class="string">&#x27;key&#x27;</span>,<span class="string">&#x27;å…¶ä»–å‚æ•°&#x27;</span>, ...)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¾‹å¦‚æˆ‘ä»¬è¦æ‰§è¡Œ</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">name</span> Kyle</span><br></pre></td></tr></table></figure>
<p>ï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Kyle&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¾‹å¦‚æˆ‘æˆ‘ä»¬è¦æ‰§è¡Œ</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">name</span> David</span><br></pre></td></tr></table></figure>
<p>ï¼Œåœ¨æ‰§è¡Œ</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="type">name</span></span><br></pre></td></tr></table></figure>
<p>ï¼Œåˆ™è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆæ‰§è¡Œset name David</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;David&#x27;</span>)</span><br><span class="line"><span class="comment"># å†æ‰§è¡Œget name</span></span><br><span class="line"><span class="built_in">local</span> name = redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="comment"># è¿”å›</span></span><br><span class="line"><span class="built_in">return</span> name</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨Rediså‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦è°ƒç”¨</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Kyle&#x27;</span>) <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè„šæœ¬ï¼Œè¯­æ³•å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL <span class="string">&quot;return redis.call(&#x27;set&#x27;, &#x27;name&#x27;, &#x27;Kyle&#x27;)&quot;</span> 0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¦‚æœè„šæœ¬ä¸­çš„keyå’Œvalueä¸æƒ³å†™æ­»ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œkeyç±»å‹å‚æ•°ä¼šæ”¾å…¥KEYSæ•°ç»„ï¼Œå…¶ä»–å‚æ•°ä¼šæ”¾å…¥ARGVæ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­å¯ä»¥ä»KEYSå’ŒARGVæ•°ç»„ä¸­è·å–è¿™äº›å‚æ•°</p>
<p>æ³¨æ„ï¼šåœ¨Luaä¸­ï¼Œæ•°ç»„ä¸‹æ ‡ä»1å¼€å§‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL <span class="string">&quot;return redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1])&quot;</span> 1 name Lucy</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£ç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨Luaè„šæœ¬æ¥ä»£æ›¿æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘</p>
</li>
<li>
<p>åŸé€»è¾‘</p>
</li>
<li>
<p>æ”¹å†™ä¸ºLuaè„šæœ¬01</p>
</li>
<li>
<p>æ”¹å†™ä¸ºLuaè„šæœ¬02</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„æ ‡è¯†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­çš„æ ‡è¯†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ ‡è¯†æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> (threadId.equals(id)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”">åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</h2>
<ul>
<li>
<p>åœ¨RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨executeæ–¹æ³•å»æ‰§è¡Œluaè„šæœ¬</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.scriptExecutor.execute(script, keys, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¯¹åº”çš„Javaä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">    UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">    UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.execute(UNLOCK_SCRIPT,</span><br><span class="line">            Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">            ID_PREFIX + Thread.currentThread().getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯ç°åœ¨çš„åˆ†å¸ƒå¼é”è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šé”ä¸ä½</p>
<ul>
<li>é‚£ä»€ä¹ˆæ˜¯é”ä¸ä½å‘¢ï¼Ÿ
<ul>
<li>å¦‚æœé”çš„TTLå¿«åˆ°æœŸçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å®ƒç»­æœŸä¸€ä¸‹ï¼Œæ¯”å¦‚ç»­ä¸ª30sï¼Œå°±å¥½åƒæ˜¯ç½‘å§ä¸Šç½‘ï¼Œå¿«æ²¡ç½‘è´¹äº†çš„æ—¶å€™ï¼Œè®©ç½‘ç®¡å†ç»™ä½ ç»­50å—é’±çš„ï¼Œç„¶åè¯¥ç©ç©ï¼Œç¨‹åºä¹Ÿç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li>
<li>é‚£ä¹ˆç»­æœŸé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Œå¯ä»¥ä¾èµ–äºæˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ redissionäº†</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å°ç»“ï¼šåŸºäºRedisåˆ†å¸ƒå¼é”çš„å®ç°æ€è·¯</p>
<ul>
<li>åˆ©ç”¨SET NX EXè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡è¯†</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”
<ul>
<li>ç‰¹æ€§
<ul>
<li>åˆ©ç”¨SET NXæ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨SET EXä¿è¯æ•…éšœæ—¶ä¾ç„¶èƒ½é‡Šæ”¾é”ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1>åˆ†å¸ƒå¼é”-Redisson</h1>
<ul>
<li>åŸºäºSETNXå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä»¥ä¸‹é—®é¢˜
<ol>
<li>é‡å…¥é—®é¢˜
<ul>
<li>é‡å…¥é—®é¢˜æ˜¯æŒ‡è·å–é”çš„çº¿ç¨‹ï¼Œå¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œä¾‹å¦‚åœ¨HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œå®ƒçš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼ŒåŠ å…¥å®ƒåœ¨ä¸€ä¸ªæ–¹æ³•å†…è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ­¤æ—¶æ˜¯ä¸å¯é‡å…¥çš„ï¼Œé‚£å°±æ­»é”äº†ã€‚æ‰€ä»¥å¯é‡å…¥é”çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„</li>
</ul>
</li>
<li>ä¸å¯é‡è¯•
<ul>
<li>æˆ‘ä»¬ç¼–å†™çš„åˆ†å¸ƒå¼é”åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œå¤±è´¥äº†å°±è¿”å›falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶ã€‚ä½†åˆç†çš„æƒ…å†µåº”è¯¥æ˜¯ï¼šå½“çº¿ç¨‹è·å–é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å–é”</li>
</ul>
</li>
<li>è¶…æ—¶é‡Šæ”¾
<ul>
<li>æˆ‘ä»¬åœ¨åŠ é”çš„æ—¶å€™å¢åŠ äº†TTLï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿(é˜»å¡)æ—¶é—´å¤ªé•¿ï¼Œä¹Ÿä¼šå¯¼è‡´é”çš„é‡Šæ”¾ã€‚è™½ç„¶æˆ‘ä»¬é‡‡ç”¨Luaè„šæœ¬æ¥é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†ç°åœ¨çš„æ–°é—®é¢˜æ˜¯æ²¡é”ä½ï¼Œä¹Ÿæœ‰å®‰å…¨éšæ‚£</li>
</ul>
</li>
<li>ä¸»ä»ä¸€è‡´æ€§
<ul>
<li>å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä¸‡ä¸€åœ¨åŒæ­¥ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†(ä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œè™½ç„¶æ—¶é—´å¾ˆçŸ­ï¼Œä½†è¿˜æ˜¯å‘ç”Ÿäº†)ï¼Œé‚£ä¹ˆåˆä¼šå‡ºç°æ­»é”é—®é¢˜</li>
</ul>
</li>
</ol>
</li>
<li>é‚£ä¹ˆä»€ä¹ˆæ˜¯Redissonå‘¢
<ul>
<li>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼(In-Memory Data Grid)ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°</li>
</ul>
</li>
<li>Redisæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·åŠŸèƒ½
<ol>
<li>å¯é‡å…¥é”(Reentrant Lock)</li>
<li>å…¬å¹³é”(Fair Lock)</li>
<li>è”é”(MultiLock)</li>
<li>çº¢é”(RedLock)</li>
<li>è¯»å†™é”(ReadWriteLock)</li>
<li>ä¿¡å·é‡(Semaphore)</li>
<li>å¯è¿‡æœŸæ€§ä¿¡å·é‡(PermitExpirableSemaphore)</li>
<li>é—­é”(CountDownLatch)</li>
</ol>
</li>
</ul>
<h2 id="Redissonå…¥é—¨">Redissonå…¥é—¨</h2>
<ol>
<li>
<p>å¯¼å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>C:\Users\wuâ€™zhiâ€™han\AppData\Roaming\Unity\Asset Store</p>
</li>
<li>
<p>E:\Unity\Asset Store</p>
</li>
<li>
<p>é…ç½®Redissonå®¢æˆ·ç«¯ï¼Œåœ¨configåŒ…ä¸‹æ–°å»º<code>RedissonConfig</code>ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://101.XXX.XXX.160:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨Redissonçš„åˆ†å¸ƒå¼é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">//è·å–å¯é‡å…¥é”</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>,<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ›¿æ¢æˆ‘ä»¬ä¹‹å‰è‡ªå·±å†™çš„åˆ†å¸ƒå¼é”</p>
<ul>
<li>DIFF</li>
<li>ä¿®æ”¹åçš„ä»£ç </li>
</ul>
<p>è¿™é‡Œè¦æ³¨å…¥ä¸€ä¸‹RedissonClient</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+   @Resource</span></span><br><span class="line"><span class="addition">+   private RedissonClient redissonClient;</span></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Result seckillVoucher(Long voucherId) &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">        //1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span><br><span class="line">        queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">        SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">        //2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span><br><span class="line">        if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">            return Result.fail(&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span><br><span class="line">        if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">            return Result.fail(&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span><br><span class="line">        if (seckillVoucher.getStock() &lt; 1) &#123;</span><br><span class="line">            return Result.fail(&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line"><span class="deletion">-       SimpleRedisLock redisLock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line"><span class="addition">+       RLock redisLock = redissonClient.getLock(&quot;order:&quot; + userId);</span></span><br><span class="line"><span class="deletion">-       boolean isLock = redisLock.tryLock(120);</span></span><br><span class="line"><span class="addition">+       boolean isLock = redisLock.tryLock();</span></span><br><span class="line">        if (!isLock) &#123;</span><br><span class="line">            return Result.fail(&quot;ä¸å…è®¸æŠ¢å¤šå¼ ä¼˜æƒ åˆ¸&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            return proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>ä½¿ç”¨Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä¾æ—§æ˜¯åªèƒ½æŠ¢åˆ°ä¸€å¼ ä¼˜æƒ åˆ¸ï¼Œæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚</li>
</ul>
<h2 id="Redissonå¯é‡å…¥é”åŸç†">Redissonå¯é‡å…¥é”åŸç†</h2>
<ul>
<li>
<p>åœ¨Locké”ä¸­ï¼Œä»–æ˜¯å€ŸåŠ©äºç­‰æ›¾çš„ä¸€ä¸ªvoaltileçš„ä¸€ä¸ªstateå˜é‡æ¥è®°å½•é‡å…¥çš„çŠ¶æ€çš„</p>
<ul>
<li>
<p>å¦‚æœå½“å‰<code>æ²¡æœ‰</code>äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆ<code>state = 0</code></p>
</li>
<li>
<p>å¦‚æœ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æœ‰</span><br></pre></td></tr></table></figure>
<p>äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆ</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">state</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœæŒæœ‰è€…æŠŠé”çš„äººå†æ¬¡æŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstateä¼š<code>+1</code></li>
</ul>
</li>
<li>
<p>å¦‚æœå¯¹äº<code>synchronize</code>è€Œè¨€ï¼Œä»–åœ¨cè¯­è¨€ä»£ç ä¸­ä¼šæœ‰ä¸€ä¸ªcount</p>
</li>
<li>
<p>åŸç†ä¸<code>state</code>ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é‡å…¥ä¸€æ¬¡å°±<code>+1</code>ï¼Œé‡Šæ”¾ä¸€æ¬¡å°±<code>-1</code>ï¼Œç›´è‡³å‡åˆ°0ï¼Œè¡¨ç¤ºè¿™æŠŠé”æ²¡æœ‰è¢«äººæŒæœ‰</p>
</li>
</ul>
</li>
<li>
<p>åœ¨redissonä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒå¯é‡å…¥é”</p>
<ul>
<li>åœ¨åˆ†å¸ƒå¼é”ä¸­ï¼Œå®ƒé‡‡ç”¨hashç»“æ„æ¥å­˜å‚¨é”ï¼Œå…¶ä¸­å¤–å±‚keyè¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œå†…å±‚keyåˆ™è®°å½•å½“å‰è¿™æŠŠé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰</li>
</ul>
</li>
<li>
<p>method1åœ¨æ–¹æ³•å†…éƒ¨è°ƒç”¨method2ï¼Œmethod1å’Œmethod2å‡ºäºåŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆmethod1å·²ç»æ‹¿åˆ°ä¸€æŠŠé”äº†ï¼Œæƒ³è¿›å…¥method2ä¸­æ‹¿å¦å¤–ä¸€æŠŠé”ï¼Œå¿…ç„¶æ˜¯æ‹¿ä¸åˆ°çš„ï¼Œäºæ˜¯å°±å‡ºç°äº†æ­»é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    lock = redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸ&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ1&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œ2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ2&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦é¢å¤–åˆ¤æ–­ï¼Œmethod1å’Œmethod2æ˜¯å¦å¤„äºåŒä¸€çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™å¯ä»¥æ‹¿åˆ°é”ï¼Œä½†æ˜¯stateä¼š<code>+1</code>ï¼Œä¹‹åæ‰§è¡Œmethod2ä¸­çš„æ–¹æ³•ï¼Œé‡Šæ”¾é”ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿåªæ˜¯å°†stateè¿›è¡Œ<code>-1</code>ï¼Œåªæœ‰å‡è‡³0ï¼Œæ‰ä¼šçœŸæ­£é‡Šæ”¾é”</p>
</li>
<li>
<p>ç”±äºæˆ‘ä»¬éœ€è¦é¢å¤–å­˜å‚¨ä¸€ä¸ªstateï¼Œæ‰€ä»¥ç”¨å­—ç¬¦ä¸²å‹<code>SET NX EX</code>æ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦ç”¨åˆ°<code>Hash</code>ç»“æ„ï¼Œä½†æ˜¯<code>Hash</code>ç»“æ„åˆæ²¡æœ‰<code>NX</code>è¿™ç§æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†åŸæœ‰çš„é€»è¾‘æ‹†å¼€ï¼Œè¿›è¡Œæ‰‹åŠ¨åˆ¤æ–­</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635cea4f16f2c2beb1df2620.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635cea4f16f2c2beb1df2620.jpg" alt="img"></a></p>
<ul>
<li>
<p>ä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥æµç¨‹å›¾ä¸­çš„ä¸šåŠ¡é€»è¾‘ä¹Ÿæ˜¯éœ€è¦æˆ‘ä»¬ç”¨Luaæ¥å®ç°çš„</p>
<ul>
<li>
<p>è·å–é”çš„é€»è¾‘</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]; <span class="comment">-- é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>]; <span class="comment">-- çº¿ç¨‹å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>]; <span class="comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"><span class="comment">-- é”ä¸å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è·å–é”å¹¶æ·»åŠ çº¿ç¨‹æ ‡è¯†ï¼Œstateè®¾ä¸º1</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hset&#x27;</span>, key, threadId, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    <span class="comment">-- è®¾ç½®é”æœ‰æ•ˆæœŸ</span></span><br><span class="line">    redis.call(<span class="string">&#x27;expire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- é”å­˜åœ¨ï¼Œåˆ¤æ–­threadIdæ˜¯å¦ä¸ºè‡ªå·±</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, key, threadId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- é”å­˜åœ¨ï¼Œé‡å…¥æ¬¡æ•° +1ï¼Œè¿™é‡Œç”¨çš„æ˜¯hashç»“æ„çš„incrbyå¢é•¿</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, thread, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">-- è®¾ç½®é”çš„æœ‰æ•ˆæœŸ</span></span><br><span class="line">    redis.call(<span class="string">&#x27;expire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; <span class="comment">-- ä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜è·å–é”çš„ä¸æ˜¯è‡ªå·±ï¼Œè·å–é”å¤±è´¥</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡Šæ”¾é”çš„é€»è¾‘</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>];</span><br><span class="line"><span class="comment">-- å¦‚æœé”ä¸æ˜¯è‡ªå·±çš„</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;HEXISTS&#x27;</span>, key, threadId) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">-- ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- é”æ˜¯è‡ªå·±çš„ï¼Œé”è®¡æ•°-1ï¼Œè¿˜æ˜¯ç”¨hincrbyï¼Œä¸è¿‡è‡ªå¢é•¿çš„å€¼ä¸º-1</span></span><br><span class="line"><span class="keyword">local</span> count = redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, threadId, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">-- åˆ¤æ–­é‡å…¥æ¬¡æ•°ä¸ºå¤šå°‘</span></span><br><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- å¤§äº0ï¼Œé‡ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">    redis.call(<span class="string">&#x27;expire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- å¦åˆ™ç›´æ¥é‡Šæ”¾é”</span></span><br><span class="line">    redis.call(<span class="string">&#x27;del&#x27;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>è·å–é”æºç </p>
<p>æŸ¥çœ‹æºç ï¼Œè·Ÿæˆ‘ä»¬çš„å®ç°æ–¹å¼å‡ ä¹ä¸€è‡´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.internalLockLeaseTime = unit.toMillis(leaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.evalWriteAsync(<span class="built_in">this</span>.getName(), LongCodec.INSTANCE, command, <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); return nil; end; if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); return nil; end; return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>, Collections.singletonList(<span class="built_in">this</span>.getName()), <span class="built_in">this</span>.internalLockLeaseTime, <span class="built_in">this</span>.getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡Šæ”¾é”æºç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">unlockInnerAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.evalWriteAsync(<span class="built_in">this</span>.getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[3]) == 0) then return nil;end; local counter = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[3], -1); if (counter &gt; 0) then redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2]); return 0; else redis.call(&#x27;del&#x27;, KEYS[1]); redis.call(&#x27;publish&#x27;, KEYS[2], ARGV[1]); return 1; end; return nil;&quot;</span>, Arrays.asList(<span class="built_in">this</span>.getName(), <span class="built_in">this</span>.getChannelName()), LockPubSub.UNLOCK_MESSAGE, <span class="built_in">this</span>.internalLockLeaseTime, <span class="built_in">this</span>.getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶">Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶</h2>
<ul>
<li>
<p>å‰é¢æˆ‘ä»¬åˆ†æçš„æ˜¯ç©ºå‚çš„tryLockæ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªå¸¦å‚æ•°çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.internalLockLeaseTime = unit.toMillis(leaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.evalWriteAsync(<span class="built_in">this</span>.getName(), LongCodec.INSTANCE, command, <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); return nil; end; if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); return nil; end; return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>, Collections.singletonList(<span class="built_in">this</span>.getName()), <span class="built_in">this</span>.internalLockLeaseTime, <span class="built_in">this</span>.getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æºç åˆ†æ</p>
</li>
<li>
<p>tryAcquireAsync</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (leaseTime != -<span class="number">1L</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šé‡Šæ”¾æ—¶é—´æ—¶é—´ï¼Œåˆ™æŒ‡å®šé»˜è®¤é‡Šæ”¾æ—¶é—´ä¸ºgetLockWatchdogTimeoutï¼Œåº•å±‚æºç æ˜¾ç¤ºæ˜¯30*1000msï¼Œä¹Ÿå°±æ˜¯30ç§’</span></span><br><span class="line">        RFuture&lt;Long&gt; ttlRemainingFuture = <span class="built_in">this</span>.tryLockInnerAsync(waitTime, <span class="built_in">this</span>.commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(), TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">        ttlRemainingFuture.onComplete((ttlRemaining, e) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.scheduleExpirationRenewal(threadId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> ttlRemainingFuture;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>tryLock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> unit.toMillis(waitTime);</span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">ttl</span> <span class="operator">=</span> <span class="built_in">this</span>.tryAcquire(waitTime, leaseTime, unit, threadId);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ttlæ˜¯å¦ä¸ºnull</span></span><br><span class="line">        <span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è®¡ç®—å½“å‰æ—¶é—´ä¸è·å–é”æ—¶é—´çš„å·®å€¼ï¼Œè®©ç­‰å¾…æ—¶é—´å‡å»è¿™ä¸ªå€¼</span></span><br><span class="line">            time -= System.currentTimeMillis() - current;</span><br><span class="line">            <span class="comment">//å¦‚æœæ¶ˆè€—æ—¶é—´å¤ªé•¿äº†ï¼Œç›´æ¥è¿”å›falseï¼Œè·å–é”å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (time &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.acquireFailed(waitTime, unit, threadId);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…æ—¶é—´è¿˜æœ‰å‰©ä½™ï¼Œå†æ¬¡è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">                current = System.currentTimeMillis();</span><br><span class="line">                <span class="comment">//è®¢é˜…åˆ«äººé‡Šæ”¾é”çš„ä¿¡å·</span></span><br><span class="line">                RFuture&lt;RedissonLockEntry&gt; subscribeFuture = <span class="built_in">this</span>.subscribe(threadId);</span><br><span class="line">                <span class="comment">//åœ¨å‰©ä½™æ—¶é—´å†…ï¼Œç­‰å¾…è¿™ä¸ªä¿¡å·</span></span><br><span class="line">                <span class="keyword">if</span> (!subscribeFuture.await(time, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!subscribeFuture.cancel(<span class="literal">false</span>)) &#123;</span><br><span class="line">                        subscribeFuture.onComplete((res, e) -&gt; &#123;</span><br><span class="line">                            <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">//å–æ¶ˆè®¢é˜…</span></span><br><span class="line">                                <span class="built_in">this</span>.unsubscribe(subscribeFuture, threadId);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//å‰©ä½™æ—¶é—´å†…æ²¡ç­‰åˆ°ï¼Œè¿”å›false</span></span><br><span class="line">                    <span class="built_in">this</span>.acquireFailed(waitTime, unit, threadId);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœå‰©ä½™æ—¶é—´å†…ç­‰åˆ°äº†åˆ«äººé‡Šæ”¾é”çš„ä¿¡å·ï¼Œå†æ¬¡è®¡ç®—å½“å‰å‰©ä½™æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line">                        time -= System.currentTimeMillis() - current;</span><br><span class="line">                        <span class="keyword">if</span> (time &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                            <span class="comment">//å¦‚æœå‰©ä½™æ—¶é—´ä¸ºè´Ÿæ•°ï¼Œåˆ™ç›´æ¥è¿”å›false</span></span><br><span class="line">                            <span class="built_in">this</span>.acquireFailed(waitTime, unit, threadId);</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">var20</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                            <span class="keyword">return</span> var20;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">boolean</span> var16;</span><br><span class="line">                            <span class="keyword">do</span> &#123;</span><br><span class="line">                                <span class="comment">//å¦‚æœå‰©ä½™æ—¶é—´ç­‰åˆ°äº†ï¼Œdowhileå¾ªç¯é‡è¯•è·å–é”</span></span><br><span class="line">                                <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                                ttl = <span class="built_in">this</span>.tryAcquire(waitTime, leaseTime, unit, threadId);</span><br><span class="line">                                <span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    var16 = <span class="literal">true</span>;</span><br><span class="line">                                    <span class="keyword">return</span> var16;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                time -= System.currentTimeMillis() - currentTime;</span><br><span class="line">                                <span class="keyword">if</span> (time &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                                    <span class="built_in">this</span>.acquireFailed(waitTime, unit, threadId);</span><br><span class="line">                                    var16 = <span class="literal">false</span>;</span><br><span class="line">                                    <span class="keyword">return</span> var16;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                currentTime = System.currentTimeMillis();</span><br><span class="line">                                <span class="keyword">if</span> (ttl &gt;= <span class="number">0L</span> &amp;&amp; ttl &lt; time) &#123;</span><br><span class="line">                                    ((RedissonLockEntry)subscribeFuture.getNow()).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    ((RedissonLockEntry)subscribeFuture.getNow()).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                time -= System.currentTimeMillis() - currentTime;</span><br><span class="line">                            &#125; <span class="keyword">while</span>(time &gt; <span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">this</span>.acquireFailed(waitTime, unit, threadId);</span><br><span class="line">                            var16 = <span class="literal">false</span>;</span><br><span class="line">                            <span class="keyword">return</span> var16;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.unsubscribe(subscribeFuture, threadId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>scheduleExpirationRenewal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleExpirationRenewal</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpirationEntry</span>();  </span><br><span class="line">    <span class="comment">//ä¸å­˜åœ¨ï¼Œæ‰putï¼Œè¡¨æ˜æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œä¸æ˜¯é‡å…¥</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">oldEntry</span> <span class="operator">=</span> (ExpirationEntry)EXPIRATION_RENEWAL_MAP.putIfAbsent(<span class="built_in">this</span>.getEntryName(), entry);</span><br><span class="line">    <span class="keyword">if</span> (oldEntry != <span class="literal">null</span>) &#123;</span><br><span class="line">        oldEntry.addThreadId(threadId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œåˆ™è·Ÿæ–°æœ‰æ•ˆæœŸ</span></span><br><span class="line">        entry.addThreadId(threadId);</span><br><span class="line">        <span class="built_in">this</span>.renewExpiration();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>renewExpiration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpiration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">ee</span> <span class="operator">=</span> (ExpirationEntry)EXPIRATION_RENEWAL_MAP.get(<span class="built_in">this</span>.getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (ee != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//Timeoutæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡</span></span><br><span class="line">        <span class="type">Timeout</span> <span class="variable">task</span> <span class="operator">=</span> <span class="built_in">this</span>.commandExecutor.getConnectionManager().newTimeout(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Timeout timeout)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">ExpirationEntry</span> <span class="variable">ent</span> <span class="operator">=</span> (ExpirationEntry)RedissonLock.EXPIRATION_RENEWAL_MAP.get(RedissonLock.<span class="built_in">this</span>.getEntryName());</span><br><span class="line">                <span class="keyword">if</span> (ent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">threadId</span> <span class="operator">=</span> ent.getFirstThreadId();</span><br><span class="line">                    <span class="keyword">if</span> (threadId != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//é‡ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">                        RFuture&lt;Boolean&gt; future = RedissonLock.<span class="built_in">this</span>.renewExpirationAsync(threadId);</span><br><span class="line">                        future.onComplete((res, e) -&gt; &#123;</span><br><span class="line">                            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                                RedissonLock.log.error(<span class="string">&quot;Can&#x27;t update lock &quot;</span> + RedissonLock.<span class="built_in">this</span>.getName() + <span class="string">&quot; expiration&quot;</span>, e);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                                    <span class="comment">//ç„¶åè°ƒç”¨è‡ªå·±ï¼Œé€’å½’é‡ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">                                    RedissonLock.<span class="built_in">this</span>.renewExpiration();</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//internalLockLeaseTimeæ˜¯ä¹‹å‰WatchDogé»˜è®¤æœ‰æ•ˆæœŸ30ç§’ï¼Œé‚£è¿™é‡Œå°±æ˜¯ 30 / 3 = 10ç§’ä¹‹åï¼Œæ‰ä¼šæ‰§è¡Œ</span></span><br><span class="line">        &#125;, <span class="built_in">this</span>.internalLockLeaseTime / <span class="number">3L</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        ee.setTimeout(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>renewExpirationAsync<br>
é‡ç‚¹çœ‹luaè„šæœ¬ï¼Œå…ˆåˆ¤æ–­é”æ˜¯ä¸æ˜¯è‡ªå·±çš„ï¼Œç„¶åæ›´æ–°æœ‰æ•ˆæ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">renewExpirationAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.evalWriteAsync(<span class="built_in">this</span>.getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); return 1; end; return 0;&quot;</span>, Collections.singletonList(<span class="built_in">this</span>.getName()), <span class="built_in">this</span>.internalLockLeaseTime, <span class="built_in">this</span>.getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£ä¹ˆä¹‹å‰çš„é‡ç½®æœ‰æ•ˆæœŸçš„è¡Œä¸ºè¯¥æ€ä¹ˆç»ˆæ­¢å‘¢ï¼Ÿå½“ç„¶æ˜¯é‡Šæ”¾é”çš„æ—¶å€™ä¼šç»ˆæ­¢</p>
</li>
<li>
<p>cancelExpirationRenewal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">cancelExpirationRenewal</span><span class="params">(Long threadId)</span> &#123;</span><br><span class="line">    <span class="comment">//å°†ä¹‹å‰çš„çº¿ç¨‹ç»ˆæ­¢æ‰</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">task</span> <span class="operator">=</span> (ExpirationEntry)EXPIRATION_RENEWAL_MAP.get(<span class="built_in">this</span>.getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (threadId != <span class="literal">null</span>) &#123;</span><br><span class="line">            task.removeThreadId(threadId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (threadId == <span class="literal">null</span> || task.hasNoThreads()) &#123;</span><br><span class="line">            <span class="comment">//è·å–ä¹‹å‰çš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">            <span class="type">Timeout</span> <span class="variable">timeout</span> <span class="operator">=</span> task.getTimeout();</span><br><span class="line">            <span class="keyword">if</span> (timeout != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å–æ¶ˆ</span></span><br><span class="line">                timeout.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EXPIRATION_RENEWAL_MAP.remove(<span class="built_in">this</span>.getEntryName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635d046816f2c2beb1293315.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635d046816f2c2beb1293315.jpg" alt="img"></a></p>
<h2 id="Redissoné”çš„MutiLockåŸç†">Redissoné”çš„MutiLockåŸç†</h2>
<ul>
<li>
<p>ä¸ºäº†æé«˜Redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p>
</li>
<li>
<p>æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾ä¸»æœºè¿˜æ²¡æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œä¸»æœºå®•æœºäº†</p>
</li>
<li>
<p>å“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºäº†ï¼Œäºæ˜¯é€‰ä¸¾ä¸€ä¸ªslave(ä»æœº)å˜æˆmaster(ä¸»æœº)ï¼Œè€Œæ­¤æ—¶æ–°çš„master(ä¸»æœº)ä¸Šå¹¶æ²¡æœ‰é”çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹å°±å¯ä»¥è·å–é”ï¼Œåˆä¼šå¼•å‘å®‰å…¨é—®é¢˜</p>
</li>
<li>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚Redissonæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”çš„è¯ï¼Œé‚£æˆ‘ä»¬å°±ä¸ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥å½“åšæ˜¯ä¸»æœºï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å°†åŠ é”çš„é€»è¾‘å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä»èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å–é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§</p>
</li>
<li>
<p>æˆ‘ä»¬å…ˆä½¿ç”¨è™šæ‹Ÿæœºé¢å¤–æ­å»ºä¸¤ä¸ªRedisèŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.137.130:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://92.168.137.131:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://92.168.137.132:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨è”é”ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ³¨å…¥ä¸‰ä¸ªRedissonClientå¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient2;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    lock = redissonClient.getMultiLock(lock1, lock2, lock3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    redissonClient.getMultiLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸ&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ1&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œ2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ2&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æºç åˆ†æ</p>
</li>
<li>
<p>å½“æˆ‘ä»¬æ²¡æœ‰ä¼ å…¥é”å¯¹è±¡æ¥åˆ›å»ºè”é”çš„æ—¶å€™ï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œåä¹‹åˆ™å°†æˆ‘ä»¬ä¼ å…¥çš„å¯å˜å‚æ•°é”å¯¹è±¡å°è£…æˆä¸€ä¸ªé›†åˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RedissonMultiLock</span><span class="params">(RLock... locks)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (locks.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Lock objects are not defined&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locks.addAll(Arrays.asList(locks));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è”é”çš„tryLock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">newLeaseTime</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥äº†é‡Šæ”¾æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (leaseTime != -<span class="number">1L</span>) &#123;</span><br><span class="line">        <span class="comment">//å†åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æœ‰ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="keyword">if</span> (waitTime == -<span class="number">1L</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡ä¼ ç­‰å¾…æ—¶é—´ï¼Œä¸é‡è¯•ï¼Œåˆ™åªè·å¾—ä¸€æ¬¡</span></span><br><span class="line">            newLeaseTime = unit.toMillis(leaseTime);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//æƒ³è¦é‡è¯•ï¼Œè€—æ—¶è¾ƒä¹…ï¼Œä¸‡ä¸€é‡Šæ”¾æ—¶é—´å°äºç­‰å¾…æ—¶é—´ï¼Œåˆ™ä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œå°†ç­‰å¾…æ—¶é—´ä¹˜ä»¥äºŒ</span></span><br><span class="line">            newLeaseTime = unit.toMillis(waitTime) * <span class="number">2L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//å‰©ä½™ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">remainTime</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">if</span> (waitTime != -<span class="number">1L</span>) &#123;</span><br><span class="line">        remainTime = unit.toMillis(waitTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é”ç­‰å¾…æ—¶é—´ï¼Œä¸å‰©ä½™ç­‰å¾…æ—¶é—´ä¸€æ ·    </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">lockWaitTime</span> <span class="operator">=</span> <span class="built_in">this</span>.calcLockWaitTime(remainTime);</span><br><span class="line">    <span class="comment">//é”å¤±è´¥çš„é™åˆ¶ï¼Œæºç è¿”å›æ˜¯çš„0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">failedLocksLimit</span> <span class="operator">=</span> <span class="built_in">this</span>.failedLocksLimit();</span><br><span class="line">    <span class="comment">//å·²ç»è·å–æˆåŠŸçš„é”</span></span><br><span class="line">    List&lt;RLock&gt; acquiredLocks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(<span class="built_in">this</span>.locks.size());</span><br><span class="line">    <span class="comment">//è¿­ä»£å™¨ï¼Œç”¨äºéå†</span></span><br><span class="line">    ListIterator&lt;RLock&gt; iterator = <span class="built_in">this</span>.locks.listIterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> (RLock)iterator.next();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> lockAcquired;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ç­‰å¾…æ—¶é—´å’Œé‡Šæ”¾æ—¶é—´ï¼Œè°ƒç”¨ç©ºå‚çš„tryLock</span></span><br><span class="line">            <span class="keyword">if</span> (waitTime == -<span class="number">1L</span> &amp;&amp; leaseTime == -<span class="number">1L</span>) &#123;</span><br><span class="line">                lockAcquired = lock.tryLock();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å¦åˆ™è°ƒç”¨å¸¦å‚çš„tryLock</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">awaitTime</span> <span class="operator">=</span> Math.min(lockWaitTime, remainTime);</span><br><span class="line">                lockAcquired = lock.tryLock(awaitTime, newLeaseTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RedisResponseTimeoutException var21) &#123;</span><br><span class="line">            <span class="built_in">this</span>.unlockInner(Arrays.asList(lock));</span><br><span class="line">            lockAcquired = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var22) &#123;</span><br><span class="line">            lockAcquired = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­è·å–é”æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (lockAcquired) &#123;</span><br><span class="line">            <span class="comment">//æˆåŠŸåˆ™å°†é”æ”¾å…¥æˆåŠŸé”çš„é›†åˆ</span></span><br><span class="line">            acquiredLocks.add(lock);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœè·å–é”å¤±è´¥</span></span><br><span class="line">            <span class="comment">//åˆ¤æ–­å½“å‰é”çš„æ•°é‡ï¼Œå‡å»æˆåŠŸè·å–é”çš„æ•°é‡ï¼Œå¦‚æœä¸º0ï¼Œåˆ™æ‰€æœ‰é”éƒ½æˆåŠŸè·å–ï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.locks.size() - acquiredLocks.size() == <span class="built_in">this</span>.failedLocksLimit()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦åˆ™å°†æ‹¿åˆ°çš„é”éƒ½é‡Šæ”¾æ‰</span></span><br><span class="line">            <span class="keyword">if</span> (failedLocksLimit == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.unlockInner(acquiredLocks);</span><br><span class="line">                <span class="comment">//å¦‚æœç­‰å¾…æ—¶é—´ä¸º-1ï¼Œåˆ™ä¸æƒ³é‡è¯•ï¼Œç›´æ¥è¿”å›false</span></span><br><span class="line">                <span class="keyword">if</span> (waitTime == -<span class="number">1L</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                failedLocksLimit = <span class="built_in">this</span>.failedLocksLimit();</span><br><span class="line">                <span class="comment">//å°†å·²ç»æ‹¿åˆ°çš„é”éƒ½æ¸…ç©º</span></span><br><span class="line">                acquiredLocks.clear();</span><br><span class="line">                <span class="comment">//å°†è¿­ä»£å™¨å¾€å‰è¿­ä»£ï¼Œç›¸å½“äºé‡ç½®æŒ‡é’ˆï¼Œæ”¾åˆ°ç¬¬ä¸€ä¸ªç„¶åé‡è¯•è·å–é”</span></span><br><span class="line">                <span class="keyword">while</span>(iterator.hasPrevious()) &#123;</span><br><span class="line">                    iterator.previous();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                --failedLocksLimit;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå‰©ä½™æ—¶é—´ä¸ä¸º-1ï¼Œå¾ˆå……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (remainTime != -<span class="number">1L</span>) &#123;</span><br><span class="line">            <span class="comment">//è®¡ç®—ç°åœ¨å‰©ä½™æ—¶é—´</span></span><br><span class="line">            remainTime -= System.currentTimeMillis() - time;</span><br><span class="line">            time = System.currentTimeMillis();</span><br><span class="line">            <span class="comment">//å¦‚æœå‰©ä½™æ—¶é—´ä¸ºè´Ÿæ•°ï¼Œåˆ™è·å–é”è¶…æ—¶äº†</span></span><br><span class="line">            <span class="keyword">if</span> (remainTime &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="comment">//å°†ä¹‹å‰å·²ç»è·å–åˆ°çš„é”é‡Šæ”¾æ‰ï¼Œå¹¶è¿”å›false</span></span><br><span class="line">                <span class="built_in">this</span>.unlockInner(acquiredLocks);</span><br><span class="line">                <span class="comment">//è”é”æˆåŠŸçš„æ¡ä»¶æ˜¯ï¼šæ¯ä¸€æŠŠé”éƒ½å¿…é¡»æˆåŠŸè·å–ï¼Œä¸€æŠŠé”å¤±è´¥ï¼Œåˆ™éƒ½å¤±è´¥</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœè®¾ç½®äº†é”çš„æœ‰æ•ˆæœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (leaseTime != -<span class="number">1L</span>) &#123;</span><br><span class="line">        List&lt;RFuture&lt;Boolean&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(acquiredLocks.size());</span><br><span class="line">        <span class="comment">//è¿­ä»£å™¨ç”¨äºéå†å·²ç»è·å–æˆåŠŸçš„é”</span></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var24</span> <span class="operator">=</span> acquiredLocks.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var24.hasNext()) &#123;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> (RLock)var24.next();</span><br><span class="line">            <span class="comment">//è®¾ç½®æ¯ä¸€æŠŠé”çš„æœ‰æ•ˆæœŸ</span></span><br><span class="line">            RFuture&lt;Boolean&gt; future = ((RedissonLock)rLock).expireAsync(unit.toMillis(leaseTime), TimeUnit.MILLISECONDS);</span><br><span class="line">            futures.add(future);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var24 = futures.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var24.hasNext()) &#123;</span><br><span class="line">            RFuture&lt;Boolean&gt; rFuture = (RFuture)var24.next();</span><br><span class="line">            rFuture.syncUninterruptibly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä½†å¦‚æœæ²¡è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ™ä¼šè§¦å‘WatchDogæœºåˆ¶ï¼Œè‡ªåŠ¨å¸®æˆ‘ä»¬è®¾ç½®æœ‰æ•ˆæœŸï¼Œæ‰€ä»¥å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±è®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="å°ç»“">å°ç»“</h2>
<ol>
<li>ä¸å¯é‡å…¥Redisåˆ†å¸ƒå¼é”
<ul>
<li>åŸç†ï¼šåˆ©ç”¨SETNXçš„äº’æ–¥æ€§ï¼›åˆ©ç”¨EXé¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡è¯†</li>
<li>ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ</li>
</ul>
</li>
<li>å¯é‡å…¥Redisåˆ†å¸ƒå¼é”
<ul>
<li>åŸç†ï¼šåˆ©ç”¨Hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡è¯†ä¸é‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨WatchDogå»¶ç»­é”æ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…</li>
<li>ç¼ºé™·ï¼šRediså®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜</li>
</ul>
</li>
<li>Redissonçš„multiLock
<ul>
<li>åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–é”æˆåŠŸ</li>
</ul>
</li>
</ol>
<h1>ç§’æ€ä¼˜åŒ–</h1>
<h2 id="å¼‚æ­¥ç§’æ€æ€è·¯">å¼‚æ­¥ç§’æ€æ€è·¯</h2>
<ul>
<li>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹</li>
<li>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šå…ˆè¯·æ±‚Nginxï¼ŒNginxåå‘ä»£ç†åˆ°Tomcatï¼Œè€ŒTomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤
<ol>
<li>æŸ¥è¯¢ä¼˜æƒ åˆ¸</li>
<li>åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</li>
<li>æŸ¥è¯¢è®¢å•</li>
<li>æ ¡éªŒæ˜¯å¦ä¸€äººä¸€å•</li>
<li>æ‰£å‡åº“å­˜</li>
<li>åˆ›å»ºè®¢å•</li>
</ol>
</li>
<li>åœ¨è¿™å…­ä¸ªæ­¥éª¤ä¸­ï¼Œæœ‰å¾ˆå¤šæ“ä½œéƒ½æ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œå¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</li>
<li><code>ä¼˜åŒ–æ–¹æ¡ˆï¼š</code>æˆ‘ä»¬å°†è€—æ—¶è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾åˆ°Redisä¸­ï¼Œä¾‹å¦‚ï¼šåº“å­˜æ˜¯å¦å……è¶³ï¼Œæ˜¯å¦ä¸€äººä¸€å•è¿™æ ·çš„æ“ä½œï¼Œåªè¦æ»¡è¶³è¿™ä¸¤æ¡æ“ä½œï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•æˆåŠŸçš„ï¼Œä¸ç”¨ç­‰æ•°æ®çœŸçš„å†™è¿›æ•°æ®åº“ï¼Œæˆ‘ä»¬ç›´æ¥å‘Šè¯‰ç”¨æˆ·ä¸‹å•æˆåŠŸå°±å¥½äº†ã€‚ç„¶ååå°å†å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹å†å»æ…¢æ…¢æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾ˆå¿«çš„å®Œæˆä¸‹å•ä¸šåŠ¡ã€‚<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635dedfc16f2c2beb1c42f52.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635dedfc16f2c2beb1c42f52.jpg" alt="img"></a></li>
<li>ä½†æ˜¯è¿™é‡Œè¿˜å­˜åœ¨ä¸¤ä¸ªéš¾ç‚¹
<ol>
<li>æˆ‘ä»¬æ€ä¹ˆåœ¨Redisä¸­å¿«é€Ÿæ ¡éªŒæ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</li>
<li>æˆ‘ä»¬æ ¡éªŒä¸€äººä¸€å•å’Œå°†ä¸‹å•æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œè¿™æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“ä¸‹å•æ˜¯å¦å®Œæˆã€‚
<ul>
<li>æˆ‘ä»¬éœ€è¦å°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿå°†è¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆ</li>
</ul>
</li>
</ol>
</li>
<li>æˆ‘ä»¬ç°åœ¨æ¥çœ‹æ•´ä½“æ€è·¯ï¼šå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œåªéœ€è¦å–Redisä¸­æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸã€‚å¦‚æœå……è¶³ï¼Œåˆ™åœ¨Redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¯¥ç”¨æˆ·çš„ä¸‹å•æ•°æ®ï¼Œåˆ™å¯ä»¥ä¸‹å•ï¼Œå¹¶å°†userIdå’Œä¼˜æƒ åˆ¸å­˜å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨Luaæ¥æ“ä½œï¼ŒåŒæ—¶ç”±äºæˆ‘ä»¬éœ€è¦åœ¨Redisä¸­æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œéœ€è¦å°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li>
<li>å®Œæˆä»¥ä¸Šé€»è¾‘åˆ¤æ–­æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­å½“å‰Redisä¸­çš„è¿”å›å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œå°†ä¿¡æ¯ä¿å­˜åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œå¼€ä¸€ä¸ªçº¿ç¨‹æ¥å¼‚æ­¥ä¸‹å•ï¼Œå…¶é˜¿å¥´å•å¯ä»¥é€šè¿‡è¿”å›è®¢å•çš„idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸ</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635df17d16f2c2beb1cf02be.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635df17d16f2c2beb1cf02be.jpg" alt="img"></a></p>
<h2 id="Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­">Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼š</p>
<ol>
<li>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li>
<li>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦ç§’æ€æˆåŠŸ</li>
</ol>
</li>
<li>
<pre><code>æ­¥éª¤ä¸€ï¼š
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¿®æ”¹ä¿å­˜ä¼˜æƒ åˆ¸ç›¸å…³ä»£ç </span><br><span class="line"></span><br><span class="line">```JAVA</span><br><span class="line">@Override</span><br><span class="line">@Transactional</span><br><span class="line">public void add<span class="constructor">SeckillVoucher(Voucher <span class="params">voucher</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    SeckillVoucher seckillVoucher = <span class="keyword">new</span> <span class="constructor">SeckillVoucher()</span>;</span><br><span class="line">    seckillVoucher.set<span class="constructor">VoucherId(<span class="params">voucher</span>.<span class="params">getId</span>()</span>);</span><br><span class="line">    seckillVoucher.set<span class="constructor">Stock(<span class="params">voucher</span>.<span class="params">getStock</span>()</span>);</span><br><span class="line">    seckillVoucher.set<span class="constructor">BeginTime(<span class="params">voucher</span>.<span class="params">getBeginTime</span>()</span>);</span><br><span class="line">    seckillVoucher.set<span class="constructor">EndTime(<span class="params">voucher</span>.<span class="params">getEndTime</span>()</span>);</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ°Reidsï¼ŒKeyåä¸­åŒ…å«ä¼˜æƒ åˆ¸IDï¼ŒValueä¸ºä¼˜æƒ åˆ¸çš„å‰©ä½™æ•°é‡</span></span><br><span class="line">    stringRedisTemplate.ops<span class="constructor">ForValue()</span>.set(SECKILL_STOCK_KEY + voucher.get<span class="constructor">Id()</span>, voucher.get<span class="constructor">Stock()</span>.<span class="keyword">to</span><span class="constructor">String()</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>ä½¿ç”¨PostManå‘é€è¯·æ±‚ï¼Œæ·»åŠ ä¼˜æƒ åˆ¸</p>
<p>è¯·æ±‚è·¯å¾„ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/api/voucher/seckill">http://localhost:8080/api/voucher/seckill</a></p>
<p>è¯·æ±‚æ–¹å¼ï¼šPOST</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shopId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;9999å…ƒä»£é‡‘åˆ¸&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subTitle&quot;</span><span class="punctuation">:</span><span class="string">&quot;365*24å°æ—¶å¯ç”¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="string">&quot;å…¨åœºé€šç”¨\\nApexçŒæ€æ— éœ€é¢„çº¦&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payValue&quot;</span><span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actualValue&quot;</span><span class="punctuation">:</span><span class="number">999900</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beginTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-01-01T00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-12-31T23:59:59&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ·»åŠ æˆåŠŸåï¼Œæ•°æ®åº“ä¸­å’ŒRedisä¸­éƒ½èƒ½çœ‹åˆ°ä¼˜æƒ åˆ¸ä¿¡æ¯</p>
</li>
<li>
<pre><code>æ­¥éª¤äºŒï¼š
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ç¼–å†™Luaè„šæœ¬</span><br><span class="line"></span><br><span class="line"><span class="keyword">lua</span>çš„å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>
..
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ï¼Œå­—ç¬¦ä¸²è½¬æ•°å­—æ˜¯</span><br><span class="line"></span><br></pre></td></tr></table></figure>
tonumber()
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```LUA</span><br><span class="line"><span class="comment">-- è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- ä¼˜æƒ åˆ¸key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span> (redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- æ‰£å‡åº“å­˜</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- å°†userIdå­˜å…¥å½“å‰ä¼˜æƒ åˆ¸çš„seté›†åˆ</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>ä¿®æ”¹ä¸šåŠ¡é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//1. æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString());</span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­è¿”å›å€¼ï¼Œå¹¶è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç°åœ¨æˆ‘ä»¬ä½¿ç”¨PostManå‘é€è¯·æ±‚ï¼Œredisä¸­çš„æ•°æ®ä¼šå˜åŠ¨ï¼Œè€Œä¸”ä¸èƒ½é‡å¤ä¸‹å•ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­çš„æ•°æ®å¹¶æ²¡æœ‰å˜åŒ–</p>
</li>
</ul>
<h2 id="åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–">åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</h2>
<ul>
<li>
<p>ä¿®æ”¹ä¸‹å•çš„æ“ä½œï¼Œæˆ‘ä»¬åœ¨ä¸‹å•æ—¶ï¼Œæ˜¯é€šè¿‡Luaè¡¨è¾¾å¼å»åŸå­æ‰§è¡Œåˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœåˆ¤æ–­ç»“æœä¸ä¸º0ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœåˆ¤æ–­ç»“æœä¸º0ï¼Œåˆ™å°†ä¸‹å•çš„é€»è¾‘ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œ</p>
</li>
<li>
<p>éœ€æ±‚</p>
<ol>
<li>å¦‚æœç§’æ€æˆåŠŸï¼Œåˆ™å°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li>
<li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li>
</ol>
</li>
<li>
<pre><code>æ­¥éª¤ä¸€ï¼š
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span><br><span class="line"></span><br><span class="line">é˜»å¡é˜Ÿåˆ—æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å°è¯•ä»é˜»å¡é˜Ÿåˆ—é‡Œè·å–å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ï¼Œæ‰ä¼šè¢«å”¤é†’ï¼Œå¹¶å»è·å–å…ƒç´ </span><br><span class="line"></span><br><span class="line">é˜»å¡é˜Ÿåˆ—çš„åˆ›å»ºéœ€è¦æŒ‡å®šä¸€ä¸ªå¤§å°</span><br><span class="line"></span><br><span class="line">```<span class="type">JAVA</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BlockingQueue</span>&lt;<span class="type">VoucherOrder</span>&gt; orderTasks <span class="operator">=</span> new <span class="type">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> <span class="operator">*</span> <span class="number">1024</span>);</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>é‚£ä¹ˆæŠŠä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString());</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<pre><code>æ­¥éª¤äºŒï¼š
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> å…ˆåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± </span><br><span class="line"></span><br><span class="line">   ```JAVA</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> final ExecutorService SECKILL_ORDER_EXECUTOR = Executors.<span class="keyword">new</span><span class="type">SingleThreadExecutor</span>();</span><br></pre></td></tr></table></figure>

2. åˆ›å»ºçº¿ç¨‹ä»»åŠ¡ï¼Œç§’æ€ä¸šåŠ¡éœ€è¦åœ¨ç±»åˆå§‹åŒ–ä¹‹åï¼Œå°±ç«‹å³æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°

   <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br></pre></td></tr></table></figure>

   æ³¨è§£

   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">//2. åˆ›å»ºè®¢å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è®¢å•å¤„ç†å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

3. ç¼–å†™åˆ›å»ºè®¢å•çš„ä¸šåŠ¡é€»è¾‘

   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">//2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">//3. è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ         </span></span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ</span></span><br><span class="line">        proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

- æŸ¥çœ‹AopContextæºç ï¼Œå®ƒçš„è·å–ä»£ç†å¯¹è±¡ä¹Ÿæ˜¯é€šè¿‡ThreadLocalè¿›è¡Œè·å–çš„ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œæ˜¯å¼‚æ­¥ä¸‹å•ï¼Œå’Œä¸»çº¿ç¨‹ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸èƒ½è·å–æˆåŠŸ

  <figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;<span class="built_in">Object</span>&gt; currentProxy = <span class="keyword">new </span><span class="class title_">NamedThreadLocal</span>(<span class="string">&quot;Current AOP proxy&quot;</span>);</span><br></pre></td></tr></table></figure>

- ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†proxyæ”¾åœ¨æˆå‘˜å˜é‡çš„ä½ç½®ï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹ä¸­è·å–ä»£ç†å¯¹è±¡

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString());</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmdp.dto.Result;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.VoucherOrder;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.mapper.VoucherOrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.ISeckillVoucherService;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.IVoucherOrderService;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.RedisIdWorker;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.UserHolder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AopContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * æœåŠ¡å®ç°ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Kyle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-10-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;seckill.lua&quot;</span>));</span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//1. è·å–ç”¨æˆ·</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="comment">//2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//3. è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ </span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">//2. åˆ›å»ºè®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;è®¢å•å¤„ç†å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(), voucherId.toString(),</span><br><span class="line">                UserHolder.getUser().getId().toString());</span><br><span class="line">        <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        orderTasks.add(voucherOrder);</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">voucherId</span> <span class="operator">=</span> voucherOrder.getVoucherId();</span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                    .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                    .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    .update();</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">            save(voucherOrder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="å°ç»“-2">å°ç»“</h2>
<ul>
<li>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ
<ol>
<li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜å®¹é‡ã€ä¸€äººä¸€å•çš„åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li>
<li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li>
</ol>
</li>
<li>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ
<ol>
<li>å†…å­˜é™åˆ¶é—®é¢˜ï¼š
<ul>
<li>æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„æ˜¯JDKé‡Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒä½¿ç”¨çš„æ˜¯JVMçš„å†…å­˜ï¼Œå¦‚æœåœ¨é«˜å¹¶å‘çš„æ¡ä»¶ä¸‹ï¼Œæ— æ•°çš„è®¢å•éƒ½ä¼šæ”¾åœ¨é˜»å¡é˜Ÿåˆ—é‡Œï¼Œå¯èƒ½å°±ä¼šé€ æˆå†…å­˜æº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ›å»ºé˜»å¡é˜Ÿåˆ—æ—¶ï¼Œè®¾ç½®äº†ä¸€ä¸ªé•¿åº¦ï¼Œä½†æ˜¯å¦‚æœçœŸçš„å­˜æ»¡äº†ï¼Œå†æœ‰æ–°çš„è®¢å•æ¥å¾€é‡Œå¡ï¼Œé‚£å°±å¡ä¸è¿›å»äº†ï¼Œå­˜åœ¨å†…å­˜é™åˆ¶é—®é¢˜</li>
</ul>
</li>
<li>æ•°æ®å®‰å…¨é—®é¢˜ï¼š
<ul>
<li>ç»å…¸æœåŠ¡å™¨å®•æœºäº†ï¼Œç”¨æˆ·æ˜æ˜ä¸‹å•äº†ï¼Œä½†æ˜¯æ•°æ®åº“é‡Œæ²¡çœ‹åˆ°</li>
</ul>
</li>
</ol>
</li>
</ul>
<h1>Redisæ¶ˆæ¯é˜Ÿåˆ—</h1>
<h2 id="è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—">è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</h2>
<ul>
<li>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œæœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²
<ol>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li>
<li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li>
</ol>
</li>
<li>ä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äº<code>è§£è€¦</code>ï¼šä¸¾ä¸ªä¾‹å­ï¼Œå¿«é€’å‘˜(ç”Ÿäº§è€…)æŠŠå¿«é€’æ”¾åˆ°é©¿ç«™/å¿«é€’æŸœé‡Œå»(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœ/é©¿ç«™å»æ‹¿å¿«é€’ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆå¿«é€’å‘˜å¿…é¡»äº²è‡ªä¸Šæ¥¼æŠŠå¿«é€’é€’åˆ°ä½ æ‰‹é‡Œï¼ŒæœåŠ¡å½“ç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€æˆ‘ä¸åœ¨å®¶ï¼Œå¿«é€’å‘˜å°±å¾—ä¸€ç›´ç­‰æˆ‘ï¼Œæµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ã€‚æ‰€ä»¥è§£è€¦è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„</li>
<li>é‚£ä¹ˆåœ¨è¿™ç§åœºæ™¯ä¸‹æˆ‘ä»¬çš„ç§’æ€å°±å˜æˆäº†ï¼šåœ¨æˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨Rediså»è¿›è¡Œæ ¡éªŒä¸‹å•çš„ç»“æœï¼Œç„¶ååœ¨é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶ååœ¨å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦</li>
<li>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€äº›ç°æˆçš„(MQ)æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚kafkaï¼Œrabbitmqç­‰ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰å®‰è£…MQï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨Redisæä¾›çš„MQæ–¹æ¡ˆ(å­¦å®ŒRedisæˆ‘å°±å»å­¦å¾®æœåŠ¡)</li>
</ul>
<h2 id="åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h2>
<ul>
<li>åŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—(Message Queue)ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œè€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—çš„æ•ˆæœ</li>
<li>é˜Ÿåˆ—çš„å…¥å£å’Œå‡ºå£ä¸åœ¨åŒä¸€è¾¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSHç»“åˆRPOPæˆ–è€…RPUSHç»“åˆLPOPæ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼ŒRPOPå’ŒLPOPæ“ä½œä¼šè¿”å›NULLï¼Œè€Œä¸åƒJVMé˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡ï¼Œå¹¶ç­‰å¾…æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœ</li>
<li>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ
<ul>
<li>ä¼˜ç‚¹
<ol>
<li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li>
<li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿éšœ</li>
<li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li>
</ol>
</li>
<li>ç¼ºç‚¹
<ol>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±(ç»å…¸æœåŠ¡å™¨å®•æœº)</li>
<li>åªæ”¯æŒå•æ¶ˆè´¹è€…(ä¸€ä¸ªæ¶ˆè´¹è€…æŠŠæ¶ˆæ¯æ‹¿èµ°äº†ï¼Œå…¶ä»–æ¶ˆè´¹è€…å°±çœ‹ä¸åˆ°è¿™æ¡æ¶ˆæ¯äº†)</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</h2>
<ul>
<li>
<p>PubSub(å‘å¸ƒè®¢é˜…)æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹å’Œå¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯</p>
</li>
<li>
<p><code>SUBSCRIBE channel [channel]</code>ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</p>
</li>
<li>
<p><code>PUBLISH channel msg</code>ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯</p>
</li>
<li>
<p><code>PSUBSCRIBE pattern [pattern]</code>ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</p>
<p>Subscribes the client to the given patterns.<br>
Supported glob-style patterns:</p>
<ul>
<li>h?flo subscribes to hello, hallo and hxllo</li>
<li>h*llo subscribes to hllo and heeeello</li>
<li>h[ae]llo subscribes to hello and hallo, but not hillo</li>
</ul>
<p>Use \ to escape special characters if you want to match them verbatim.</p>
</li>
<li>
<p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹</p>
<ul>
<li>ä¼˜ç‚¹ï¼š
<ol>
<li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ï¼Œå¤šæ¶ˆè´¹</li>
</ol>
</li>
<li>ç¼ºç‚¹ï¼š
<ol>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼ˆå¦‚æœå‘é¢‘é“å‘é€äº†æ¶ˆæ¯ï¼Œå´æ²¡æœ‰äººè®¢é˜…è¯¥é¢‘é“ï¼Œé‚£å‘é€çš„è¿™æ¡æ¶ˆæ¯å°±ä¸¢å¤±äº†ï¼‰</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±ï¼ˆæ¶ˆè´¹è€…æ‹¿åˆ°æ•°æ®çš„æ—¶å€™å¤„ç†çš„å¤ªæ…¢ï¼Œè€Œå‘é€æ¶ˆæ¯å‘çš„å¤ªå¿«ï¼‰</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</h2>
<ul>
<li>
<p>Streamæ˜¯Redis 5.0å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥æ—¶é—´ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—</p>
</li>
<li>
<p>å‘é€æ¶ˆæ¯çš„å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XADD key [NOMKSTREAM] [MAXLEN|MINID [=!~] threshold [LIMIT count]] *|ID field value [field value ...]</span><br></pre></td></tr></table></figure>
<ul>
<li>NOMKSTREAM
<ul>
<li>å¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—ï¼Œé»˜è®¤æ˜¯è‡ªåŠ¨åˆ›å»º</li>
</ul>
</li>
<li>[MAXLEN|MINID [=!~] threshold [LIMIT count]]
<ul>
<li>è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—çš„æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼Œä¸è®¾ç½®åˆ™æ— ä¸Šé™</li>
</ul>
</li>
<li>*|ID
<ul>
<li>æ¶ˆæ¯çš„å”¯ä¸€idï¼Œ*ä»£è¡¨ç”±Redisè‡ªåŠ¨ç”Ÿæˆã€‚æ ¼å¼æ˜¯â€æ—¶é—´æˆ³-é€’å¢æ•°å­—â€ï¼Œä¾‹å¦‚â€114514114514-0â€</li>
</ul>
</li>
<li>field value [field value â€¦]
<ul>
<li>å‘é€åˆ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œç§°ä¸ºEntryã€‚æ ¼å¼å°±æ˜¯å¤šä¸ªkey-valueé”®å€¼å¯¹</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¸¾ä¾‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåä¸ºusersçš„é˜Ÿåˆ—ï¼Œå¹¶å‘å…¶ä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œå†…å®¹æ˜¯&#123;name=jack, age=21&#125;ï¼Œå¹¶ä¸”ä½¿ç”¨Redisè‡ªåŠ¨ç”ŸæˆID</span></span><br><span class="line">XADD <span class="built_in">users</span> * name jack age 21</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREAD</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure>
<ul>
<li>[COUNT count]
<ul>
<li>æ¯æ¬¡è¯»å–æ¶ˆæ¯çš„æœ€å¤§æ•°é‡</li>
</ul>
</li>
<li>[BLOCK milliseconds]
<ul>
<li>å½“æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¯å¦é˜»å¡ï¼Œé˜»å¡æ—¶é•¿</li>
</ul>
</li>
<li>STREAMS key [key â€¦]
<ul>
<li>è¦ä»å“ªä¸ªé˜Ÿåˆ—è¯»å–æ¶ˆæ¯ï¼Œkeyå°±æ˜¯é˜Ÿåˆ—å</li>
</ul>
</li>
<li>ID [ID â€¦]
<ul>
<li>èµ·å§‹IDï¼Œåªè¿”å›å¤§äºè¯¥IDçš„æ¶ˆæ¯
<ul>
<li>0ï¼šè¡¨ç¤ºä»ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li>
<li>$ï¼šè¡¨ç¤ºä»æœ€æ–°çš„æ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¾‹å¦‚ï¼šä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">äº‘æœåŠ¡å™¨:0&gt;XREAD COUNT 1 STREAMS <span class="built_in">users</span> 0</span><br><span class="line">1) 1) <span class="string">&quot;users&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1667119621804-0&quot;</span></span><br><span class="line">         2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">            2) <span class="string">&quot;jack&quot;</span></span><br><span class="line">            3) <span class="string">&quot;age&quot;</span></span><br><span class="line">            4) <span class="string">&quot;21&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¾‹å¦‚ï¼šXREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°æ¶ˆæ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREAD COUNT 2 BLOCK 10000 STREAMS <span class="built_in">users</span> $</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯è°ƒç”¨çš„XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">//å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡2ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.execute(<span class="string">&quot;XREAD COUNT 1 BLOCK 2000 STREAMS users $&quot;</span>);</span><br><span class="line">    <span class="comment">//æ²¡è¯»å–åˆ°ï¼Œè·³è¿‡ä¸‹é¢çš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    handleMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šå…¶å®IDä¸º$æ—¶ï¼Œä»£è¡¨åªèƒ½è¯»å–åˆ°æœ€æ–°æ¶ˆæ¯ï¼Œå¦‚æœå½“æˆ‘ä»¬åœ¨å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¸‹æ¬¡è·å–çš„æ—¶å€™ï¼Œä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°<code>æ¼è¯»æ¶ˆæ¯</code>çš„é—®é¢˜</p>
</li>
<li>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹</p>
<ol>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¼è¯»æ¶ˆæ¯çš„é£é™©</li>
</ol>
</li>
</ul>
<h2 id="åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—â€”æ¶ˆè´¹è€…ç»„">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—â€”æ¶ˆè´¹è€…ç»„</h2>
<ul>
<li>
<p>æ¶ˆè´¹è€…ç»„(Consumer Group)ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹</p>
<ol>
<li>æ¶ˆæ¯åˆ†æµ
<ul>
<li>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†ç•™ç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹è€…ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</li>
</ul>
</li>
<li>æ¶ˆæ¯æ ‡è¯†
<ul>
<li>æ¶ˆè´¹è€…ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡è¯†ï¼Œè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡è¯†ä¹‹åè¯»å–æ¶ˆæ¯ï¼Œç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</li>
</ul>
</li>
<li>æ¶ˆæ¯ç¡®è®¤
<ul>
<li>æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äºpendingçŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ªpending-listï¼Œå½“å¤„ç†å®Œæˆåï¼Œéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-listä¸­ç§»é™¤</li>
</ul>
</li>
</ol>
</li>
<li>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key groupName ID [MKSTREAM]</span><br></pre></td></tr></table></figure>
<ul>
<li>key
<ul>
<li>é˜Ÿåˆ—åç§°</li>
</ul>
</li>
<li>groupName
<ul>
<li>æ¶ˆè´¹è€…ç»„åç§°</li>
</ul>
</li>
<li>ID
<ul>
<li>èµ·å§‹IDæ ‡è¯†ï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0ä»£è¡¨é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li>
</ul>
</li>
<li>MKSTREAM
<ul>
<li>é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å…¶ä»–å¸¸è§å‘½ä»¤</p>
<ul>
<li>
<p>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP DESTORY key groupName</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATECONSUMER key groupName consumerName</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­æŒ‡å®šçš„æ¶ˆè´¹è€…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP DELCONSUMER key groupName consumerName</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>ä»æ¶ˆè´¹è€…ç»„ä¸­è¯»å–æ¶ˆæ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [keys ...] ID [ID ...]</span><br></pre></td></tr></table></figure>
<ul>
<li>group
<ul>
<li>æ¶ˆè´¹è€…ç»„åç§°</li>
</ul>
</li>
<li>consumer
<ul>
<li>æ¶ˆè´¹è€…åï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
</ul>
</li>
<li>count
<ul>
<li>æœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
</ul>
</li>
<li>BLOCK milliseconds
<ul>
<li>å½“å‰æ²¡æœ‰æ¶ˆæ¯æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é—´</li>
</ul>
</li>
<li>NOACK
<ul>
<li>æ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤ï¼ˆä¸€èˆ¬ä¸ç”¨ï¼Œæˆ‘ä»¬éƒ½æ˜¯æ‰‹åŠ¨ç¡®è®¤ï¼‰</li>
</ul>
</li>
<li>STREAMS key
<ul>
<li>æŒ‡å®šé˜Ÿåˆ—åç§°</li>
</ul>
</li>
<li>ID
<ul>
<li>è·å–æ¶ˆæ¯çš„èµ·å§‹ID
<ul>
<li><code>&gt;</code>ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹(pending-listä¸­)</li>
<li>å…¶ä»–ï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€å¤§ç­‰å¾…æ—¶é•¿ä¸º2000ms</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// æ²¡ç›‘å¬åˆ°æ¶ˆæ¯ï¼Œé‡è¯•</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//å¤„ç†æ¶ˆæ¯ï¼Œå®Œæˆåè¦æ‰‹åŠ¨ç¡®è®¤ACKï¼ŒACKä»£ç åœ¨handleMessageä¸­ç¼–å†™</span></span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//0è¡¨ç¤ºä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ï¼Œå¦‚æœå‰é¢éƒ½ACKäº†ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¸ä¼šç›‘å¬åˆ°æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//nullè¡¨ç¤ºæ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆæ¯å‡å·²ç¡®è®¤ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//è¯´æ˜æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œå†æ¬¡å¤„ç†</span></span><br><span class="line">                handleMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                <span class="comment">//å†æ¬¡å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¾ªç¯</span></span><br><span class="line">                log.error(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤çš„ç‰¹ç‚¹</p>
<ol>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">List</th>
<th style="text-align:center">PubSub</th>
<th style="text-align:center">Stream</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ¶ˆæ¯æŒä¹…åŒ–</td>
<td style="text-align:center">æ”¯æŒ</td>
<td style="text-align:center">ä¸æ”¯æŒ</td>
<td style="text-align:center">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:center">é˜»å¡è¯»å–</td>
<td style="text-align:center">æ”¯æŒ</td>
<td style="text-align:center">æ”¯æŒ</td>
<td style="text-align:center">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:center">æ¶ˆæ¯å †ç§¯å¤„ç†</td>
<td style="text-align:center">å—é™äºå†…å­˜ç©ºé—´ï¼Œ å¯ä»¥åˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç†</td>
<td style="text-align:center">å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº</td>
<td style="text-align:center">å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œ å¯ä»¥åˆ©ç”¨æ¶ˆè´¹è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯</td>
</tr>
<tr>
<td style="text-align:center">æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</td>
<td style="text-align:center">ä¸æ”¯æŒ</td>
<td style="text-align:center">ä¸æ”¯æŒ</td>
<td style="text-align:center">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:center">æ¶ˆæ¯å›æº¯</td>
<td style="text-align:center">ä¸æ”¯æŒ</td>
<td style="text-align:center">ä¸æ”¯æŒ</td>
<td style="text-align:center">æ”¯æŒ</td>
</tr>
</tbody>
</table>
<h2 id="Streamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•">Streamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li>
<li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li>
<li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li>
</ol>
</li>
<li>
<pre><code>æ­¥éª¤ä¸€ï¼š
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.<span class="keyword">orders</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line">```<span class="keyword">BASH</span></span><br><span class="line"><span class="keyword"></span>XGROUP CREATE stream.<span class="keyword">orders </span>g1 <span class="number">0</span> MKSTREAM</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<pre><code>æ­¥éª¤äºŒï¼š
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¿®æ”¹Luaè„šæœ¬ï¼Œæ–°å¢orderIdå‚æ•°ï¼Œå¹¶å°†è®¢å•ä¿¡æ¯åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span><br><span class="line"></span><br><span class="line">```LUA</span><br><span class="line"><span class="comment">-- è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- æ–°å¢orderIdï¼Œä½†æ˜¯å˜é‡åç”¨idå°±å¥½ï¼Œå› ä¸ºVoucherOrderå®ä½“ç±»ä¸­çš„orderIdå°±æ˜¯ç”¨idè¡¨ç¤ºçš„</span></span><br><span class="line"><span class="keyword">local</span> id = ARGV[<span class="number">3</span>]</span><br><span class="line"><span class="comment">-- ä¼˜æƒ åˆ¸key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span> (redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- æ‰£å‡åº“å­˜</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- å°†userIdå­˜å…¥å½“å‰ä¼˜æƒ åˆ¸çš„seté›†åˆ</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- å°†ä¸‹å•æ•°æ®ä¿å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span></span><br><span class="line">redis.<span class="keyword">call</span>(&quot;sadd&quot;, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, id)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<pre><code>æ­¥éª¤ä¸‰ï¼š
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¿®æ”¹ç§’æ€é€»è¾‘</span><br><span class="line"></span><br><span class="line">- DIFF</span><br><span class="line">- ä¿®æ”¹åä»£ç </span><br><span class="line"></span><br><span class="line">ç”±äºå°†ä¸‹å•æ•°æ®åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨Luaè„šæœ¬ä¸­å®ç°äº†ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸éœ€è¦å°†ä¸‹å•æ•°æ®åŠ å…¥åˆ°JVMçš„é˜»å¡é˜Ÿåˆ—ä¸­å»äº†ï¼ŒåŒæ—¶Luaè„šæœ¬ä¸­æˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå‚æ•°ï¼Œ</span><br><span class="line"></span><br><span class="line">```DIFF</span><br><span class="line">    @Override</span><br><span class="line">    public Result seckill<span class="constructor">Voucher(Long <span class="params">voucherId</span>)</span> &#123;</span><br><span class="line">+       long orderId = redisIdWorker.next<span class="constructor">Id(<span class="string">&quot;order&quot;</span>)</span>;</span><br><span class="line">        Long result = stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Collections</span>.</span></span>empty<span class="constructor">List()</span>, voucherId.<span class="keyword">to</span><span class="constructor">String()</span>,</span><br><span class="line">+               <span class="module-access"><span class="module"><span class="identifier">UserHolder</span>.</span></span>get<span class="constructor">User()</span>.get<span class="constructor">Id()</span>.<span class="keyword">to</span><span class="constructor">String()</span>, <span class="module-access"><span class="module"><span class="identifier">String</span>.</span></span>value<span class="constructor">Of(<span class="params">orderId</span>)</span>);</span><br><span class="line">        <span class="keyword">if</span> (result.<span class="built_in">int</span><span class="constructor">Value()</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            return <span class="module-access"><span class="module"><span class="identifier">Result</span>.</span></span>fail(result.<span class="built_in">int</span><span class="constructor">Value()</span><span class="operator"> == </span><span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹ å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">-       long orderId = redisIdWorker.next<span class="constructor">Id(<span class="string">&quot;order&quot;</span>)</span>;</span><br><span class="line">-       <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">-       VoucherOrder voucherOrder = <span class="keyword">new</span> <span class="constructor">VoucherOrder()</span>;</span><br><span class="line">-       voucherOrder.set<span class="constructor">VoucherId(<span class="params">voucherId</span>)</span>;</span><br><span class="line">-       voucherOrder.set<span class="constructor">UserId(UserHolder.<span class="params">getUser</span>()</span>.get<span class="constructor">Id()</span>);</span><br><span class="line">-       voucherOrder.set<span class="constructor">Id(<span class="params">orderId</span>)</span>;</span><br><span class="line">-       <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">-       orderTasks.add(voucherOrder);</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        proxy = (IVoucherOrderService) <span class="module-access"><span class="module"><span class="identifier">AopContext</span>.</span></span>current<span class="constructor">Proxy()</span>;</span><br><span class="line">        return <span class="module-access"><span class="module"><span class="identifier">Result</span>.</span></span>ok(orderId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





</code></pre>
</li>
<li>
<p>æ ¹æ®ä¼ªä»£ç æ¥ä¿®æ”¹æˆ‘ä»¬çš„</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">VoucherOrderHandler</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ä¼ªä»£ç </li>
<li>ä¿®æ”¹åçš„ä¸šåŠ¡é€»è¾‘</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€å¤§ç­‰å¾…æ—¶é•¿ä¸º2000ms</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// æ²¡ç›‘å¬åˆ°æ¶ˆæ¯ï¼Œé‡è¯•</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//å¤„ç†æ¶ˆæ¯ï¼Œå®Œæˆåè¦æ‰‹åŠ¨ç¡®è®¤ACK</span></span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//0è¡¨ç¤ºä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ï¼Œå¦‚æœå‰é¢éƒ½ACKäº†ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¸ä¼šç›‘å¬åˆ°æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//nullè¡¨ç¤ºæ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆæ¯å‡å·²ç¡®è®¤ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//è¯´æ˜æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œå†æ¬¡å¤„ç†</span></span><br><span class="line">                handleMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                <span class="comment">//å†æ¬¡å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¾ªç¯</span></span><br><span class="line">                log.error(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1>è¾¾äººæ¢åº—</h1>
<h2 id="å‘å¸ƒæ¢åº—ç¬”è®°">å‘å¸ƒæ¢åº—ç¬”è®°</h2>
<p>è¿™éƒ¨åˆ†ä»£ç å·²ç»æä¾›å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¯¹åº”çš„æ•°æ®è¡¨</p>
<ul>
<li>tb_blog</li>
<li>tb_blog_comments</li>
</ul>
<p>æ¢åº—åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰</p>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">ä¸»é”®</td>
</tr>
<tr>
<td style="text-align:center">shop_id</td>
<td style="text-align:center">bigint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">å•†æˆ·id</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç”¨æˆ·id</td>
</tr>
<tr>
<td style="text-align:center">title</td>
<td style="text-align:center">varchar(255)</td>
<td style="text-align:center">utf8mb4_unicode_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">æ ‡é¢˜</td>
</tr>
<tr>
<td style="text-align:center">images</td>
<td style="text-align:center">varchar(2048)</td>
<td style="text-align:center">utf8mb4_general_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">æ¢åº—çš„ç…§ç‰‡ï¼Œæœ€å¤š9å¼ ï¼Œå¤šå¼ ä»¥â€,â€éš”å¼€</td>
</tr>
<tr>
<td style="text-align:center">content</td>
<td style="text-align:center">varchar(2048)</td>
<td style="text-align:center">utf8mb4_unicode_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">æ¢åº—çš„æ–‡å­—æè¿°</td>
</tr>
<tr>
<td style="text-align:center">liked</td>
<td style="text-align:center">int unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç‚¹èµæ•°é‡</td>
</tr>
<tr>
<td style="text-align:center">comments</td>
<td style="text-align:center">int unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">è¯„è®ºæ•°é‡</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td style="text-align:center">update_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED on update CURRENT_TIMESTAMP</td>
<td style="text-align:center">æ›´æ–°æ—¶é—´</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>å¯¹åº”çš„å®ä½“ç±»ï¼Œæ•°æ®è¡¨ä¸­å¹¶æ²¡æœ‰ç”¨æˆ·å¤´åƒå’Œç”¨æˆ·æ˜µç§°ï¼Œä½†æ˜¯å¯¹åº”çš„å®ä½“ç±»é‡Œå´æœ‰ï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨äº†</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="constructor">TableField(<span class="params">exist</span> = <span class="params">false</span>)</span></span><br></pre></td></tr></table></figure>
<p>ç”¨æ¥è§£å†³å®ä½“ç±»ä¸­æœ‰çš„å±æ€§ä½†æ˜¯æ•°æ®è¡¨ä¸­æ²¡æœ‰çš„å­—æ®µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blog</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å›¾æ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å§“å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦ç‚¹èµè¿‡äº†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isLike;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¢åº—çš„ç…§ç‰‡ï¼Œæœ€å¤š9å¼ ï¼Œå¤šå¼ ä»¥&quot;,&quot;éš”å¼€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¢åº—çš„æ–‡å­—æè¿°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‚¹èµæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer liked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„è®ºæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer comments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ›´æ–°æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ•ˆæœå›¾å¦‚ä¸‹<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635f8f8216f2c2beb1692e5f.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635f8f8216f2c2beb1692e5f.jpg" alt="img"></a></p>
</li>
<li>
<p>å¯¹åº”çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">    blogService.save(blog);</span><br><span class="line">    <span class="comment">// è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¸Šä¼ å›¾ç‰‡çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">uploadImage</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–åŸå§‹æ–‡ä»¶åç§°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> image.getOriginalFilename();</span><br><span class="line">        <span class="comment">// ç”Ÿæˆæ–°æ–‡ä»¶å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> createNewFileName(originalFilename);</span><br><span class="line">        <span class="comment">// ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">        image.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class="line">        <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">        log.debug(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œ&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(fileName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>SystemConstants.IMAGE_UPLOAD_DIR</code> ä¸ºè‡ªå·±å›¾ç‰‡æ‰€åœ¨çš„åœ°å€ï¼Œåœ¨å®é™…å¼€å‘ä¸­å›¾ç‰‡ä¸€èˆ¬ä¼šæ”¾åœ¨nginxä¸Šæˆ–è€…æ˜¯äº‘å­˜å‚¨ä¸Šã€‚</p>
</li>
</ul>
<h2 id="æŸ¥çœ‹æ¢åº—ç¬”è®°">æŸ¥çœ‹æ¢åº—ç¬”è®°</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼šç‚¹å‡»é¦–é¡µçš„æ¢åº—ç¬”è®°ï¼Œä¼šè¿›å…¥è¯¦æƒ…é¡µé¢ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦å®ç°é¡µé¢çš„æŸ¥è¯¢æ¥å£<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/635f908616f2c2beb16ba05d.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/635f908616f2c2beb16ba05d.jpg" alt="img"></a></p>
</li>
<li>
<p>éšä¾¿ç‚¹å‡»ä¸€å¼ å›¾ç‰‡ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/6">http://localhost:8080/api/blog/6</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>çœ‹æ ·å­æ˜¯<code>BlogController</code>ä¸‹çš„æ–¹æ³•ï¼Œè¯·æ±‚æ–¹å¼ä¸ºGETï¼Œé‚£æˆ‘ä»¬ç›´æ¥æ¥ç¼–å†™å¯¹åº”çš„æ–¹æ³•</p>
<ul>
<li>Controllerå±‚</li>
<li>ServiceImpl</li>
</ul>
<p>ä¸šåŠ¡é€»è¾‘æˆ‘ä»¬è¦å†™åœ¨Serviceå±‚ï¼ŒControllerå±‚åªè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æˆ‘ä»¬é¡ºæ‰‹å°†<code>queryHotBlog</code>ä¹Ÿä¿®æ”¹ä¸€ä¸‹ï¼ŒåŸå§‹ä»£ç å°†ä¸šåŠ¡é€»è¾‘å†™åˆ°äº†Controllerä¸­ï¼Œä¿®æ”¹åçš„å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<ul>
<li>BlogController</li>
<li>BlogServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        blog.setUserId(user.getId());</span><br><span class="line">        <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">        blogService.save(blog);</span><br><span class="line">        <span class="comment">// è¿”å›id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ç‚¹èµæ•°é‡</span></span><br><span class="line">        blogService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/of/me&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryMyBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, user.getId()).page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hot&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryHotBlog(current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ç‚¹èµåŠŸèƒ½">ç‚¹èµåŠŸèƒ½</h2>
<ul>
<li>
<p>ç‚¹å‡»ç‚¹èµæŒ‰é’®ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/like/4">http://localhost:8080/api/blog/like/4</a><br>
è¯·æ±‚æ–¹æ³•: PUT</p>
</blockquote>
</li>
<li>
<p>çœ‹æ ·å­æ˜¯BlogControllerä¸­çš„likeæ–¹æ³•ï¼Œæºç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿®æ”¹ç‚¹èµæ•°é‡</span></span><br><span class="line">    blogService.update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é—®é¢˜åˆ†æï¼šè¿™ç§æ–¹å¼ä¼šå¯¼è‡´ä¸€ä¸ªç”¨æˆ·æ— é™ç‚¹èµï¼Œæ˜æ˜¾æ˜¯ä¸åˆç†çš„</p>
</li>
<li>
<p>é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨çš„é€»è¾‘ï¼Œå‘èµ·è¯·æ±‚åªæ˜¯ç»™æ•°æ®åº“+1ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜</p>
</li>
<li>
<p>éœ€æ±‚</p>
<ol>
<li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½å¯¹åŒä¸€ç¯‡ç¬”è®°ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li>
<li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li>
</ol>
</li>
<li>
<p>å®ç°æ­¥éª¤</p>
<ol>
<li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisä¸­çš„seté›†åˆæ¥åˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµåˆ™ç‚¹èµæ•°<code>+1</code>ï¼Œå·²ç‚¹èµåˆ™ç‚¹èµæ•°<code>-1</code></li>
<li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢çš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
<li>ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
</ol>
</li>
<li>
<p>å…·ä½“å®ç°</p>
<ul>
<li>Controllerå±‚</li>
<li>BlogServiceImpl</li>
</ul>
<p>ä¸šåŠ¡é€»è¾‘å¸è½½Serviceå±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.likeBlog(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œé¡µé¢ä¸Šè¿˜ä¸èƒ½ç«‹å³æ˜¾ç¤ºç‚¹èµå®Œæ¯•çš„åæœï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹æŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­Blogæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµè¿‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">    Page&lt;Blog&gt; page = query()</span><br><span class="line">            .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">            .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">    <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">    List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    records.forEach(blog -&gt; &#123;</span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">//è¿½åŠ åˆ¤æ–­blogæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµï¼Œé€»è¾‘å°è£…åˆ°isBlogLikedæ–¹æ³•ä¸­</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;è¯„ä»·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    queryBlogUser(blog);</span><br><span class="line">    <span class="comment">//è¿½åŠ åˆ¤æ–­blogæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµï¼Œé€»è¾‘å°è£…åˆ°isBlogLikedæ–¹æ³•ä¸­</span></span><br><span class="line">    isBlogLiked(blog);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="comment">//3. å¦‚æœç‚¹èµäº†ï¼Œåˆ™å°†isLikeè®¾ç½®ä¸ºtrue</span></span><br><span class="line">    blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ç‚¹èµæ’è¡Œæ¦œ">ç‚¹èµæ’è¡Œæ¦œ</h2>
<ul>
<li>å½“æˆ‘ä»¬ç‚¹å‡»æ¢åº—ç¬”è®°è¯¦æƒ…é¡µé¢æ—¶ï¼Œåº”è¯¥æŒ‰ç‚¹èµé¡ºåºå±•ç¤ºç‚¹èµç”¨æˆ·ï¼Œæ¯”å¦‚æ˜¾ç¤ºæœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œï¼Œå°±è·ŸQQç©ºé—´å‘çš„è¯´è¯´ä¸€æ ·ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å“ªäº›äººç‚¹äº†èµ</li>
<li>ä¹‹å‰çš„ç‚¹èµæ˜¯æ”¾åˆ°Seté›†åˆä¸­ï¼Œä½†æ˜¯Seté›†åˆåˆä¸èƒ½æ’åºï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹ç”¨SortedSet(Zset)</li>
<li>é‚£æˆ‘ä»¬è¿™é‡Œé¡ºä¾¿å°±æ¥å¯¹æ¯”ä¸€ä¸‹è¿™äº›é›†åˆçš„åŒºåˆ«</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">List</th>
<th style="text-align:center">Set</th>
<th style="text-align:center">SortedSet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ’åºæ–¹å¼</td>
<td style="text-align:center">æŒ‰æ·»åŠ é¡ºåºæ’åº</td>
<td style="text-align:center">æ— æ³•æ’åº</td>
<td style="text-align:center">æ ¹æ®scoreå€¼æ’åº</td>
</tr>
<tr>
<td style="text-align:center">å”¯ä¸€æ€§</td>
<td style="text-align:center">ä¸å”¯ä¸€</td>
<td style="text-align:center">å”¯ä¸€</td>
<td style="text-align:center">å”¯ä¸€</td>
</tr>
<tr>
<td style="text-align:center">æŸ¥æ‰¾æ–¹å¼</td>
<td style="text-align:center">æŒ‰ç´¢å¼•æŸ¥æ‰¾æˆ–é¦–å°¾æŸ¥æ‰¾</td>
<td style="text-align:center">æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td>
<td style="text-align:center">æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>ä¿®æ”¹BlogServiceImpl</p>
<p>ç”±äºZSetæ²¡æœ‰isMemberæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œåªèƒ½é€šè¿‡æŸ¥è¯¢scoreæ¥åˆ¤æ–­é›†åˆä¸­æ˜¯å¦æœ‰è¯¥å…ƒç´ ï¼Œå¦‚æœæœ‰è¯¥å…ƒç´ ï¼Œåˆ™è¿”å›å€¼æ˜¯å¯¹åº”çš„scoreï¼Œå¦‚æœæ²¡æœ‰è¯¥å…ƒç´ ï¼Œåˆ™è¿”å›å€¼ä¸ºnull</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. å¦‚æœå½“å‰ç”¨æˆ·æœªç‚¹èµï¼Œåˆ™ç‚¹èµæ•° +1ï¼ŒåŒæ—¶å°†ç”¨æˆ·åŠ å…¥seté›†åˆ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–score</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">    <span class="comment">//ä¸ºnullï¼Œåˆ™è¡¨ç¤ºé›†åˆä¸­æ²¡æœ‰è¯¥ç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ç‚¹èµæ•° +1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//å°†ç”¨æˆ·åŠ å…¥seté›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. å¦‚æœå½“å‰ç”¨æˆ·å·²ç‚¹èµï¼Œåˆ™å–æ¶ˆç‚¹èµï¼Œå°†ç”¨æˆ·ä»seté›†åˆä¸­ç§»é™¤</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ç‚¹èµæ•° -1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="comment">//ä»seté›†åˆç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åŒæ—¶ä¿®æ”¹isBlogLikedæ–¹æ³•ï¼Œåœ¨åŸæœ‰é€»è¾‘ä¸Šï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œç™»å½•çŠ¶æ€ä¸‹æ‰ä¼šç»§ç»­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹èµ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="comment">//å½“ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œå°±ä¸åˆ¤æ–­äº†ï¼Œç›´æ¥returnç»“æŸé€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (userDTO == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userDTO.getId().toString());</span><br><span class="line">    blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£æˆ‘ä»¬ç»§ç»­æ¥å®Œå–„æ˜¾ç¤ºç‚¹èµåˆ—è¡¨åŠŸèƒ½ï¼ŒæŸ¥çœ‹æµè§ˆå™¨è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ç›®å‰åº”è¯¥æ˜¯404çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å†™ï¼Œä»–éœ€è¦ä¸€ä¸ªlistè¿”å›å€¼ï¼Œæ˜¾ç¤ºtop5ç‚¹èµçš„ç”¨æˆ·</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/likes/4">http://localhost:8080/api/blog/likes/4</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>åœ¨Controllerå±‚ä¸­ç¼–å†™å¯¹åº”çš„æ–¹æ³•ï¼Œç‚¹èµæŸ¥è¯¢åˆ—è¡¨ï¼Œå…·ä½“é€»è¾‘å†™åˆ°BlogServiceImplä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogLikes(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…·ä½“é€»è¾‘å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">//zrange key 0 4  æŸ¥è¯¢zsetä¸­å‰5ä¸ªå…ƒç´ </span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯ç©ºçš„(å¯èƒ½æ²¡äººç‚¹èµ)ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºé›†åˆ</span></span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//å°†idsä½¿ç”¨`,`æ‹¼æ¥ï¼ŒSQLè¯­å¥æŸ¥è¯¢å‡ºæ¥çš„ç»“æœå¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„æ–¹å¼è¿›è¡Œæ’</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨order by fieldæ¥æŒ‡å®šæ’åºæ–¹å¼ï¼ŒæœŸæœ›çš„æ’åºæ–¹å¼å°±æ˜¯æŒ‰ç…§æŸ¥è¯¢å‡ºæ¥çš„idè¿›è¡Œæ’åº</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">//select * from tb_user where id in (ids[0], ids[1] ...) order by field(id, ids[0], ids[1] ...)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query().in(<span class="string">&quot;id&quot;</span>, ids)</span><br><span class="line">            .last(<span class="string">&quot;order by field(id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>)</span><br><span class="line">            .list().stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡å¯æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹æ•ˆæœ<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/636328b216f2c2beb10e3c08.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/636328b216f2c2beb10e3c08.jpg" alt="img"></a></p>
</li>
</ul>
<h1>å¥½å‹å…³æ³¨</h1>
<h2 id="å…³æ³¨å’Œå–æ¶ˆå…³æ³¨">å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h2>
<ul>
<li>
<p>å½“æˆ‘ä»¬è¿›å…¥åˆ°ç¬”è®°è¯¦æƒ…é¡µé¢æ—¶ï¼Œä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†ç¬”è®°åšä¸»</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/or/not/2">http://localhost:8080/api/follow/or/not/2</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>å½“æˆ‘ä»¬ç‚¹å‡»å…³æ³¨æŒ‰é’®æ—¶ï¼Œä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå®ç°å…³æ³¨/å–å…³</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/2/true">http://localhost:8080/api/follow/2/true</a><br>
è¯·æ±‚æ–¹æ³•: PUT</p>
</blockquote>
</li>
<li>
<p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤º</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">ä¸»é”®</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç”¨æˆ·id</td>
</tr>
<tr>
<td style="text-align:center">follow_user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">å…³è”çš„ç”¨æˆ·id</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">åˆ›å»ºæ—¶é—´</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>å¯¹åº”çš„å®ä½“ç±»å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Follow</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³è”çš„ç”¨æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long followUserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£æˆ‘ä»¬ç°åœ¨æ¥Controllerå±‚ä¸­ç¼–å†™å¯¹åº”çš„ä¸¤ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IFollowService followService;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†è¯¥åšä¸»</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> followService.isFollow(followUserId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å®ç°å–å…³/å…³æ³¨</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFellow)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> followService.follow(followUserId,isFellow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…·ä½“çš„ä¸šåŠ¡é€»è¾‘æˆ‘ä»¬è¿˜æ˜¯æ”¾åœ¨FellowServiceImplä¸­æ¥ç¼–å†™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰ç™»å½•çš„userId</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†è¯¥ç¬”è®°çš„åšä¸»</span></span><br><span class="line">        queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">        <span class="comment">//åªæŸ¥è¯¢ä¸€ä¸ªcountå°±è¡Œäº†</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFellow)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰ç”¨æˆ·id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å…³æ³¨</span></span><br><span class="line">        <span class="keyword">if</span> (isFellow) &#123;</span><br><span class="line">            <span class="comment">//å…³æ³¨ï¼Œåˆ™å°†ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            save(follow);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å–å…³ï¼Œåˆ™å°†æ•°æ®ä»æ•°æ®åº“ä¸­ç§»é™¤</span></span><br><span class="line">            LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">            remove(queryWrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æµ‹è¯•æ•ˆæœå¦‚ä¸‹<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/63633ca816f2c2beb12b772e.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/63633ca816f2c2beb12b772e.jpg" alt="img"></a></p>
</li>
</ul>
<h2 id="å…±åŒå…³æ³¨">å…±åŒå…³æ³¨</h2>
<ul>
<li>
<p>ç‚¹å‡»ç”¨æˆ·å¤´åƒï¼Œè¿›å…¥åˆ°ç”¨æˆ·è¯¦æƒ…é¡µï¼Œå¯ä»¥æŸ¥çœ‹ç”¨æˆ·å‘å¸ƒçš„ç¬”è®°ï¼Œå’Œå…±åŒå…³æ³¨åˆ—è¡¨<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/63635de616f2c2beb15b17cb.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/63635de616f2c2beb15b17cb.jpg" alt="img"></a></p>
</li>
<li>
<p>ä½†ç°åœ¨æˆ‘ä»¬è¿˜æ²¡å†™å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥ç°åœ¨æš‚æ—¶çœ‹ä¸åˆ°æ•°æ®</p>
</li>
<li>
<p>æ£€æµ‹NetWorké€‰é¡¹å¡ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<ul>
<li>
<p>æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/user/2">http://localhost:8080/api/user/2</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>æŸ¥çœ‹å…±åŒå…³æ³¨</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/common/undefined">http://localhost:8080/api/follow/common/undefined</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>ç¼–å†™<code>æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long userId)</span> &#123;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢è¯¦æƒ…</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¯¦æƒ…ï¼Œåº”è¯¥æ˜¯ç¬¬ä¸€æ¬¡æŸ¥çœ‹è¯¦æƒ…</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">    <span class="comment">// è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡å¯æœåŠ¡å™¨ï¼Œç°åœ¨å¯ä»¥çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½†æ˜¯ä¸èƒ½çœ‹åˆ°ç”¨æˆ·å‘å¸ƒçš„ç¬”è®°ä¿¡æ¯ï¼ŒæŸ¥çœ‹NetWorkæ£€æµ‹çš„è¯·æ±‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®Œæˆè¿™ä¸ªéœ€æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/of/user?&amp;id=2&amp;current=1">http://localhost:8080/api/blog/of/user?&amp;id=2&amp;current=1</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>ç¼–å†™<code>æŸ¥è¯¢ç”¨æˆ·ç¬”è®°</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/of/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogByUserId</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current, <span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Blog&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(Blog::getUserId, id);</span><br><span class="line">        Page&lt;Blog&gt; pageInfo = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE);</span><br><span class="line">        blogService.page(pageInfo, queryWrapper);</span><br><span class="line">        List&lt;Blog&gt; records = pageInfo.getRecords();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢è¿™æ˜¯è€å¸ˆçš„ä»£ç ï¼Œä¸ªäººæ„Ÿè§‰æˆ‘çš„å¯è¯»æ€§æ›´é«˜[doge]</span></span><br><span class="line"><span class="comment">// BlogController  æ ¹æ®idæŸ¥è¯¢åšä¸»çš„æ¢åº—ç¬”è®°</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/of/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogByUserId</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">		<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">	<span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">	Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">			.eq(<span class="string">&quot;user_id&quot;</span>, id).page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">	<span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">	List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">	<span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ•ˆæœå¦‚ä¸‹<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6363632816f2c2beb162b6de.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6363632816f2c2beb162b6de.jpg" alt="img"></a></p>
</li>
<li>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆå®ç°å…±åŒå…³æ³¨</p>
<p>éœ€æ±‚ï¼šåˆ©ç”¨Redisä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ï¼Œåœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨</p>
</li>
<li>
<p>å®ç°æ–¹å¼å½“ç„¶æ˜¯æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„seté›†åˆï¼Œåœ¨seté›†åˆä¸­ï¼Œæœ‰äº¤é›†å¹¶é›†è¡¥é›†çš„apiï¼Œå¯ä»¥æŠŠäºŒè€…å…³æ³¨çš„äººæ”¾å…¥åˆ°seté›†åˆä¸­ï¼Œç„¶åé€šè¿‡apiæŸ¥è¯¢ä¸¤ä¸ªseté›†åˆçš„äº¤é›†</p>
</li>
<li>
<p>é‚£æˆ‘ä»¬å°±å¾—å…ˆä¿®æ”¹æˆ‘ä»¬ä¹‹å‰çš„å…³æ³¨é€»è¾‘ï¼Œåœ¨å…³æ³¨åšä¸»çš„åŒæ—¶ï¼Œéœ€è¦å°†æ•°æ®æ”¾åˆ°seté›†åˆä¸­ï¼Œæ–¹ä¾¿åæœŸæˆ‘ä»¬å®ç°å…±åŒå…³æ³¨ï¼Œå½“å–æ¶ˆå…³æ³¨æ—¶ï¼Œä¹Ÿéœ€è¦å°†æ•°æ®ä»seté›†åˆä¸­åˆ é™¤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFellow)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å…³æ³¨</span></span><br><span class="line">    <span class="keyword">if</span> (isFellow) &#123;</span><br><span class="line">        <span class="comment">//å…³æ³¨ï¼Œåˆ™å°†ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="comment">//å¦‚æœä¿å­˜æˆåŠŸ</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="comment">//åˆ™å°†æ•°æ®ä¹Ÿå†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å–å…³ï¼Œåˆ™å°†æ•°æ®ä»æ•°æ®åº“ä¸­ç§»é™¤</span></span><br><span class="line">        LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">        <span class="comment">//å¦‚æœå–å…³æˆåŠŸ</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> remove(queryWrapper);</span><br><span class="line">        <span class="comment">//åˆ™å°†æ•°æ®ä¹Ÿä»Redisä¸­ç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (success)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°å…±åŒå…³æ³¨ä»£ç </p>
</li>
<li>
<p>Controllerå±‚</p>
</li>
<li>
<p>Impl</p>
</li>
</ul>
<p>ä¸šåŠ¡é€»è¾‘å†™åœ¨Implä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/common/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> followService.followCommons(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6363737716f2c2beb17fae7b.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6363737716f2c2beb17fae7b.jpg" alt="img"></a></li>
</ul>
<h2 id="Feedæµå®ç°æ–¹æ¡ˆ">Feedæµå®ç°æ–¹æ¡ˆ</h2>
<ul>
<li>
<p>å½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·ä¹‹åï¼Œè¿™ä¸ªç”¨æˆ·å‘å¸ƒäº†åŠ¨æ€ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬åˆç§°å…¶ä¸ºFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«ä½œFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ï¼Œä¸ºç”¨æˆ·æä¾›æ²‰æµ¸å¼ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ï¼Œ</p>
</li>
<li>
<p>å¯¹äºä¼ ç»Ÿçš„æ¨¡å¼å†…å®¹æ£€ç´¢ï¼šç”¨æˆ·éœ€è¦ä¸»åŠ¨é€šè¿‡æœç´¢å¼•æ“æˆ–è€…æ˜¯å…¶ä»–æ–¹å¼å»æŸ¥æ‰¾æƒ³çœ‹çš„å†…å®¹</p>
</li>
<li>
<p>å¯¹äºæ–°å‹Feedæµçš„æ•ˆæœï¼šç³»ç»Ÿåˆ†æç”¨æˆ·åˆ°åº•æƒ³çœ‹ä»€ä¹ˆï¼Œç„¶åç›´æ¥æŠŠå†…å®¹æ¨é€ç»™ç”¨æˆ·ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½æ›´åŠ èŠ‚çº¦æ—¶é—´ï¼Œä¸ç”¨å»ä¸»åŠ¨æœç´ </p>
</li>
<li>
<p>Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼</p>
<ol>
<li>Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨(Bç«™å…³æ³¨çš„upï¼Œæœ‹å‹åœˆç­‰)
<ul>
<li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ï¼Œå¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li>
<li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li>
</ul>
</li>
<li>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ï¼Œæ¨é€ç”¨æˆ·æ„Ÿå…´è¶£çš„ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·
<ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£çš„ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½ä¼šèµ·åˆ°åä½œç”¨ï¼ˆç»™ä½ æ¨çš„ä½ éƒ½ä¸çˆ±çœ‹ï¼‰</li>
</ul>
</li>
</ol>
</li>
<li>
<p>é‚£æˆ‘ä»¬è¿™é‡Œé’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„æ˜¯Timelineæ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</p>
</li>
<li>
<p>é‡‡ç”¨Timelineæ¨¡å¼ï¼Œæœ‰ä¸‰ç§å…·ä½“çš„å®ç°æ–¹æ¡ˆ</p>
<ol>
<li>æ‹‰æ¨¡å¼</li>
<li>æ¨æ¨¡å¼</li>
<li>æ¨æ‹‰ç»“åˆ</li>
</ol>
</li>
<li>
<pre><code>æ‹‰æ¨¡å¼
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ï¼šä¹Ÿå«è¯»æ‰©æ•£</span><br><span class="line"></span><br><span class="line">  - è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››ã€ç‹äº”å‘äº†æ¶ˆæ¯ä¹‹åï¼Œéƒ½ä¼šä¿å­˜åˆ°è‡ªå·±çš„å‘ä»¶ç®±ä¸­ï¼Œå¦‚æœèµµå…­è¦è¯»å–æ¶ˆæ¯ï¼Œé‚£ä¹ˆä»–ä¼šè¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼Œå°†ä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶åè¿›è¡Œæ’åº</span><br><span class="line">  - ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»å–ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œå¹¶ä¸”è¯»å–å®Œä¹‹åï¼Œå¯ä»¥å°†ä»–çš„æ”¶ä»¶ç®±æ¸…é™¤</span><br><span class="line">  - ç¼ºç‚¹ï¼šæœ‰å»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶ï¼Œæ‰ä¼šå»å…³æ³¨çš„äººçš„æ—¶å‘ä»¶ç®±ä¸­æ‹‰å–ä¿¡æ¯ï¼Œå‡è®¾è¯¥ç”¨æˆ·å…³æ³¨äº†æµ·é‡ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–å¾ˆå¤šä¿¡æ¯ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§</span><br><span class="line">    [![img](https:<span class="regexp">//</span>pic1.imgdb.cn<span class="regexp">/item/</span><span class="number">6363826516</span>f2c2beb1992291.jpg)](https:<span class="regexp">//</span>pic1.imgdb.cn<span class="regexp">/item/</span><span class="number">6363826516</span>f2c2beb1992291.jpg)</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  æ¨æ¨¡å¼</span><br></pre></td></tr></table></figure>

ï¼šä¹Ÿå«å†™æ‰©æ•£

- æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°å®ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†
- ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–
- ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå‘äº†ä¸€ä¸ªåŠ¨æ€ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œé‚£ä¹ˆå°±ä¼šå†™å¾ˆå¤šä»½æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»
  [![img](https://pic1.imgdb.cn/item/636383e816f2c2beb1a0ab75.jpg)](https://pic1.imgdb.cn/item/636383e816f2c2beb1a0ab75.jpg)

</code></pre>
</li>
<li>
<pre><code>æ¨æ‹‰ç»“åˆ
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ï¼šé¡µè„šè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">-</span> æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œç«™åœ¨å‘ä»¶äººè¿™ä¸€è¾¹ï¼Œå¦‚æœæ˜¯æ™®é€šäººï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨å†™æ‰©æ•£çš„æ–¹å¼ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­ï¼Œå› ä¸ºæ™®é€šäººçš„ç²‰ä¸æ•°é‡è¾ƒå°‘ï¼Œæ‰€ä»¥è¿™æ ·ä¸ä¼šäº§ç”Ÿå¤ªå¤§å‹åŠ›ã€‚ä½†å¦‚æœæ˜¯å¤§<span class="selector-tag">V</span>ï¼Œé‚£ä¹ˆä»–æ˜¯ç›´æ¥å°†æ•°æ®å†™å…¥ä¸€ä»½åˆ°å‘ä»¶ç®±ä¸­å»ï¼Œåœ¨ç›´æ¥å†™ä¸€ä»½åˆ°æ´»è·ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼Œç«™åœ¨æ”¶ä»¶äººè¿™è¾¹æ¥çœ‹ï¼Œå¦‚æœæ˜¯æ´»è·ƒç²‰ä¸ï¼Œé‚£ä¹ˆå¤§<span class="selector-tag">V</span>å’Œæ™®é€šäººå‘çš„éƒ½ä¼šå†™åˆ°è‡ªå·±çš„æ”¶ä»¶ç®±é‡Œï¼Œä½†å¦‚æœæ˜¯æ™®é€šç²‰ä¸ï¼Œç”±äºä¸Šçº¿ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥ç­‰ä»–ä»¬ä¸Šçº¿çš„æ—¶å€™ï¼Œå†ä»å‘ä»¶ç®±ä¸­å»æ‹‰å–ä¿¡æ¯ã€‚</span><br><span class="line">    <span class="selector-attr">[![img]</span>(<span class="attribute">https</span>:<span class="comment">//pic1.imgdb.cn/item/6363841b16f2c2beb1a1e1e3.jpg)](https://pic1.imgdb.cn/item/6363841b16f2c2beb1a1e1e3.jpg)</span></span><br><span class="line"></span><br><span class="line">## æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</span><br><span class="line"></span><br><span class="line">- éœ€æ±‚ï¼š</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>. ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</span><br><span class="line">  <span class="number">2</span>. æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ä½¿ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</span><br><span class="line">  <span class="number">3</span>. æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œè¯¾å®ç°åˆ†é¡µæŸ¥è¯¢</span><br><span class="line"></span><br><span class="line">- Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿä¼šä¸æ–­å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼</span><br><span class="line"></span><br><span class="line">- å‡è®¾åœ¨t1æ—¶åˆ»ï¼Œæˆ‘ä»¬å–è¯»å–ç¬¬ä¸€é¡µï¼Œæ­¤æ—¶page = <span class="number">1</span>ï¼Œsize = <span class="number">5</span>ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°çš„å°±æ˜¯<span class="built_in">`10~6`</span>è¿™å‡ æ¡è®°å½•ï¼Œå‡è®¾t2æ—¶åˆ»æœ‰å‘å¸ƒäº†ä¸€æ¡æ–°çºªå½•ï¼Œé‚£ä¹ˆåœ¨t3æ—¶åˆ»ï¼Œæˆ‘ä»¬æ¥è¯»å–ç¬¬äºŒé¡µï¼Œæ­¤æ—¶page = <span class="number">2</span>ï¼Œsize = <span class="number">5</span>ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯»å–çš„æ•°æ®æ˜¯ä»<span class="number">6</span>å¼€å§‹çš„ï¼Œè¯»åˆ°çš„æ˜¯<span class="built_in">`6~2`</span>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯»åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨Feedæµçš„åˆ†é¡µï¼Œä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„åˆ†é¡µ</span><br><span class="line">  [![img](<span class="attribute">https</span>:<span class="comment">//pic1.imgdb.cn/item/63638cce16f2c2beb1b72c2f.jpg)](https://pic1.imgdb.cn/item/63638cce16f2c2beb1b72c2f.jpg)</span></span><br><span class="line"></span><br><span class="line">- Feedæµçš„æ»šåŠ¨åˆ†é¡µ</span><br><span class="line"></span><br><span class="line">  - æˆ‘ä»¬éœ€è¦è®°å½•æ¯æ¬¡æ“ä½œçš„æœ€åä¸€æ¡ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å»å¼€å§‹è¯»æ•°æ®</span><br><span class="line">  - ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä»t1æ—¶åˆ»å¼€å§‹ï¼Œæ‹¿åˆ°ç¬¬ä¸€é¡µæ•°æ®ï¼Œæ‹¿åˆ°äº†<span class="built_in">`10~6`</span>ï¼Œç„¶åè®°å½•ä¸‹å½“å‰æœ€åä¸€æ¬¡è¯»å–çš„è®°å½•ï¼Œå°±æ˜¯<span class="number">6</span>ï¼Œt2æ—¶åˆ»å‘å¸ƒäº†æ–°çºªå½•ï¼Œæ­¤æ—¶è¿™ä¸ª<span class="number">11</span>åœ¨æœ€ä¸Šé¢ï¼Œä½†ä¸ä¼šå½±å“æˆ‘ä»¬ä¹‹å‰æ‹¿åˆ°çš„<span class="number">6</span>ï¼Œæ­¤æ—¶t3æ—¶åˆ»æ¥è¯»å–ç¬¬äºŒé¡µï¼Œç¬¬äºŒé¡µè¯»æ•°æ®çš„æ—¶å€™ï¼Œä»<span class="built_in">`6-1=5`</span>å¼€å§‹è¯»ï¼Œè¿™æ ·å°±æ‹¿åˆ°äº†<span class="built_in">`5~1`</span>çš„è®°å½•ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹å¯ä»¥ä½¿ç”¨SortedSetæ¥åšï¼Œä½¿ç”¨æ—¶é—´æˆ³æ¥å……å½“è¡¨ä¸­çš„<span class="built_in">`1~10`</span></span><br><span class="line">    [![img](<span class="attribute">https</span>:<span class="comment">//pic1.imgdb.cn/item/63638cdb16f2c2beb1b743f5.jpg)](https://pic1.imgdb.cn/item/63638cdb16f2c2beb1b743f5.jpg)</span></span><br><span class="line"></span><br><span class="line">- æ ¸å¿ƒæ€è·¯ï¼šæˆ‘ä»¬ä¿å­˜å®Œæ¢åº—ç¬”è®°åï¼Œè·å–å½“å‰ç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨ï¼Œç„¶åå°†æ•°æ®æ¨é€ç»™ç²‰ä¸</span><br><span class="line"></span><br><span class="line">- é‚£ç°åœ¨æˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹ä¿å­˜ç¬”è®°çš„æ–¹æ³•</span><br><span class="line"></span><br><span class="line">  <span class="built_in">``</span>`JAVA</span><br><span class="line">  <span class="variable">@Override</span></span><br><span class="line">  public Result <span class="built_in">saveBlog</span>(Blog blog) &#123;</span><br><span class="line">      <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">      UserDTO user = UserHolder.<span class="built_in">getUser</span>();</span><br><span class="line">      blog.<span class="built_in">setUserId</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">      <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">      <span class="built_in">save</span>(blog);</span><br><span class="line">      <span class="comment">// æ¡ä»¶æ„é€ å™¨</span></span><br><span class="line">      LambdaQueryWrapper&lt;Follow&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">      <span class="comment">// ä»followè¡¨æœ€ä¸­ï¼ŒæŸ¥æ‰¾å½“å‰ç”¨æˆ·çš„ç²‰ä¸  select * from follow where follow_user_id = user_id</span></span><br><span class="line">      queryWrapper.<span class="built_in">eq</span>(<span class="attribute">Follow</span>::getFollowUserId, user.<span class="built_in">getId</span>());</span><br><span class="line">      <span class="comment">//è·å–å½“å‰ç”¨æˆ·çš„ç²‰ä¸</span></span><br><span class="line">      List&lt;Follow&gt; follows = followService.<span class="built_in">list</span>(queryWrapper);</span><br><span class="line">      for (Follow <span class="attribute">follow </span>: follows) &#123;</span><br><span class="line">          Long userId = follow.<span class="built_in">getUserId</span>();</span><br><span class="line">          String key = FEED_KEY + userId;</span><br><span class="line">          <span class="comment">//æ¨é€æ•°æ®</span></span><br><span class="line">          stringRedisTemplate.<span class="built_in">opsForZSet</span>().<span class="built_in">add</span>(key, blog.<span class="built_in">getId</span>().<span class="built_in">toString</span>(), System.<span class="built_in">currentTimeMillis</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è¿”å›id</span></span><br><span class="line">      return Result.<span class="built_in">ok</span>(blog.<span class="built_in">getId</span>());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
<h2 id="å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±">å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</h2>
<ul>
<li>
<p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„<code>å…³æ³¨æ </code>ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯</p>
</li>
<li>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹</p>
<ol>
<li>æ¯æ¬¡æŸ¥è¯¢å®Œæˆä¹‹åï¼Œæˆ‘ä»¬è¦åˆ†æå‡ºæŸ¥è¯¢å‡ºçš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªå€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡çš„æŸ¥è¯¢æ¡ä»¶</li>
<li>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ï¼Œå¹¶ä½œä¸ºåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œè·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼ˆä¾‹å¦‚æ—¶é—´æˆ³8 6 6 5 5 4ï¼Œæˆ‘ä»¬æ¯æ¬¡æŸ¥è¯¢3ä¸ªï¼Œç¬¬ä¸€æ¬¡æ˜¯8 6 6ï¼Œæ­¤æ—¶æœ€å°æ—¶é—´æˆ³æ˜¯6ï¼Œå¦‚æœä¸è®¾ç½®åç§»é‡ï¼Œä¼šä»ç¬¬ä¸€ä¸ª6ä¹‹åå¼€å§‹æŸ¥è¯¢ï¼Œé‚£ä¹ˆæŸ¥è¯¢åˆ°çš„å°±æ˜¯6 5 5ï¼Œè€Œä¸æ˜¯5 5 4ï¼Œå¦‚æœè¿™é‡Œè¯´çš„ä¸æ¸…æ¥šï¼Œé‚£å°±çœ‹åç»­çš„ä»£ç ï¼‰</li>
</ol>
</li>
<li>
<p>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­éœ€è¦æºå¸¦lastIdå’Œoffsetï¼Œå³ä¸Šä¸€æ¬¡æŸ¥è¯¢æ—¶çš„æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡ï¼Œè¿™ä¸¤ä¸ªå‚æ•°</p>
</li>
<li>
<p>ç¼–å†™ä¸€ä¸ªé€šç”¨çš„å®ä½“ç±»ï¼Œä¸ä¸€å®šåªå¯¹blogè¿›è¡Œåˆ†é¡µæŸ¥è¯¢ï¼Œè¿™é‡Œç”¨æ³›å‹åšä¸€ä¸ªé€šç”¨çš„åˆ†é¡µæŸ¥è¯¢ï¼Œlistæ˜¯å°è£…è¿”å›çš„ç»“æœï¼ŒminTimeæ˜¯è®°å½•çš„æœ€å°æ—¶é—´æˆ³ï¼Œoffsetæ˜¯è®°å½•åç§»é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç‚¹å‡»ä¸ªäººä¸»é¡µä¸­çš„<code>å…³æ³¨</code>æ ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/of/follow?&amp;lastId=1667472294526">http://localhost:8080/api/blog/of/follow?&amp;lastId=1667472294526</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>åœ¨BlogControllerä¸­åˆ›å»ºå¯¹åº”çš„æ–¹æ³•ï¼Œå…·ä½“å®ç°å»ServiceImplä¸­å®Œæˆ</p>
<ul>
<li>tabName</li>
<li>Implå…·ä½“å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(<span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="meta">@RequestParam(value = &quot;offset&quot;,defaultValue = &quot;0&quot;)</span> Integer offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max,offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼Œåœ¨æœ€ä¸Šæ–¹æ˜¾ç¤ºçš„éƒ½æ˜¯æˆ‘ä»¬æœ€æ–°å‘å¸ƒçš„åŠ¨æ€<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6363a7da16f2c2beb1e17702.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6363a7da16f2c2beb1e17702.jpg" alt="img"></a></p>
</li>
</ul>
<h1>é™„è¿‘å•†æˆ·</h1>
<h2 id="GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•">GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</h2>
<ul>
<li>
<p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ï¼Œå¸¸è§çš„å‘½ä»¤æœ‰</p>
<ul>
<li>
<p>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</p>
<ul>
<li>
<p>å‘½ä»¤æ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOADD key longitude latitude member [longitude latitude member â€¦]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¿”å›å€¼ï¼šæ·»åŠ åˆ°sorted setå…ƒç´ çš„æ•°ç›®ï¼Œä½†ä¸åŒ…æ‹¬å·²æ›´æ–°scoreçš„å…ƒç´ </p>
</li>
<li>
<p>å¤æ‚åº¦ï¼šæ¯â¼€ä¸ªå…ƒç´ æ·»åŠ æ˜¯O(log(N)) ï¼ŒNæ˜¯sorted setçš„å…ƒç´ æ•°é‡</p>
</li>
<li>
<p>ä¸¾ä¾‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOADD china 13.361389 38.115556 <span class="string">&quot;shanghai&quot;</span> 15.087269 37.502669 <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</p>
<ul>
<li>
<p>å‘½ä»¤æ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEODIST key member1 member2 [m|km|ft|mi]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¦‚æœä¸¤ä¸ªä½ç½®ä¹‹é—´çš„å…¶ä¸­â¼€ä¸ªä¸å­˜åœ¨ï¼Œ é‚£ä¹ˆå‘½ä»¤è¿”å›ç©ºå€¼ã€‚</p>
</li>
<li>
<p>æŒ‡å®šå•ä½çš„å‚æ•° unit å¿…é¡»æ˜¯ä»¥ä¸‹å•ä½çš„å…¶ä¸­â¼€ä¸ªï¼š</p>
<ul>
<li>m è¡¨ç¤ºå•ä½ä¸ºç±³ã€‚</li>
<li>km è¡¨ç¤ºå•ä½ä¸ºåƒç±³ã€‚</li>
<li>mi è¡¨ç¤ºå•ä½ä¸ºè‹±â¾¥ã€‚</li>
<li>ft è¡¨ç¤ºå•ä½ä¸ºè‹±å°ºã€‚</li>
</ul>
</li>
<li>
<p>å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜¾å¼åœ°æŒ‡å®šå•ä½å‚æ•°ï¼Œ é‚£ä¹ˆ GEODIST é»˜è®¤ä½¿ç”¨ç±³ä½œä¸ºå•ä½ã€‚</p>
</li>
<li>
<p>GEODIST å‘½ä»¤åœ¨è®¡ç®—è·ç¦»æ—¶ä¼šå‡è®¾åœ°çƒä¸ºå®Œç¾çš„çƒå½¢ï¼Œ åœ¨æé™æƒ…å†µä¸‹ï¼Œ è¿™â¼€å‡è®¾æœ€â¼¤ä¼šé€ æˆ 0.5% çš„è¯¯å·®</p>
</li>
<li>
<p>è¿”å›å€¼ï¼šè®¡ç®—å‡ºçš„è·ç¦»ä¼šä»¥åŒç²¾åº¦æµ®ç‚¹æ•°çš„å½¢å¼è¢«è¿”å›ã€‚ å¦‚æœç»™å®šçš„ä½ç½®å…ƒç´ ä¸å­˜åœ¨ï¼Œ é‚£ä¹ˆå‘½ä»¤è¿”å›ç©ºå€¼</p>
</li>
<li>
<p>ä¸¾ä¾‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEODIST china beijing shanghai km</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬åŒ–ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</p>
<ul>
<li>
<p>å‘½ä»¤æ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOHASH key member [member â€¦]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é€šå¸¸ä½¿ç”¨è¡¨ç¤ºä½ç½®çš„å…ƒç´ ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯ï¼Œä½¿ç”¨Geohashä½ç½®52ç‚¹æ•´æ•°ç¼–ç ã€‚ç”±äºç¼–ç å’Œè§£ç è¿‡ç¨‹ä¸­æ‰€ä½¿ç”¨çš„åˆå§‹æœ€å°å’Œæœ€å¤§åæ ‡ä¸åŒï¼Œç¼–ç çš„ç¼–ç ä¹Ÿä¸åŒäºæ ‡å‡†ã€‚æ­¤å‘½ä»¤è¿”å›ä¸€ä¸ªæ ‡å‡†çš„Geohashï¼Œåœ¨ç»´åŸºç™¾ç§‘å’Œgeohash.orgç½‘ç«™éƒ½æœ‰ç›¸å…³æè¿°</p>
</li>
<li>
<p>è¿”å›å€¼ï¼šä¸€ä¸ªæ•°ç»„ï¼Œ æ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª geohash ã€‚ å‘½ä»¤è¿”å›çš„ geohash çš„ä½ç½®ä¸ç”¨æˆ·ç»™å®šçš„ä½ç½®å…ƒç´ çš„ä½ç½®ä¸€ä¸€å¯¹åº”</p>
</li>
<li>
<p>å¤æ‚åº¦ï¼šO(log(N)) for each member requested, where N is the number of elements in the sorted set</p>
</li>
<li>
<p>ä¸¾ä¾‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">äº‘æœåŠ¡å™¨:0&gt;GEOHASH china beijing shanghai</span><br><span class="line">1) <span class="string">&quot;sqdtr74hyu0&quot;</span></span><br><span class="line">2) <span class="string">&quot;sqc8b49rny0&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</p>
<ul>
<li>
<p>æ ¼å¼ï¼šGEOPOS key member [member â€¦]</p>
</li>
<li>
<p>ç»™å®šä¸€ä¸ªsorted setè¡¨ç¤ºçš„ç©ºé—´ç´¢å¼•ï¼Œå¯†é›†ä½¿ç”¨ geoadd å‘½ä»¤ï¼Œå®ƒä»¥è·å¾—æŒ‡å®šæˆå‘˜çš„åæ ‡å¾€å¾€æ˜¯æœ‰ç›Šçš„ã€‚å½“ç©ºé—´ç´¢å¼•å¡«å……é€šè¿‡ geoadd çš„åæ ‡è½¬æ¢æˆä¸€ä¸ª52ä½Geohashï¼Œæ‰€ä»¥è¿”å›çš„åæ ‡å¯èƒ½ä¸å®Œå…¨ä»¥æ·»åŠ å…ƒç´ çš„ï¼Œä½†å°çš„é”™è¯¯å¯èƒ½ä¼šå‡ºå°ã€‚</p>
</li>
<li>
<p>å› ä¸º GEOPOS å‘½ä»¤æ¥å—å¯å˜æ•°é‡çš„ä½ç½®å…ƒç´ ä½œä¸ºè¾“å…¥ï¼Œ æ‰€ä»¥å³ä½¿ç”¨æˆ·åªç»™å®šäº†ä¸€ä¸ªä½ç½®å…ƒç´ ï¼Œ å‘½ä»¤ä¹Ÿä¼šè¿”å›æ•°ç»„å›å¤</p>
</li>
<li>
<p>è¿”å›å€¼ï¼šGEOPOS å‘½ä»¤è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ æ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆï¼š ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç»™å®šä½ç½®å…ƒç´ çš„ç»åº¦ï¼Œ è€Œç¬¬äºŒä¸ªå…ƒç´ åˆ™ä¸ºç»™å®šä½ç½®å…ƒç´ çš„çº¬åº¦ã€‚å½“ç»™å®šçš„ä½ç½®å…ƒç´ ä¸å­˜åœ¨æ—¶ï¼Œ å¯¹åº”çš„æ•°ç»„é¡¹ä¸ºç©ºå€¼</p>
</li>
<li>
<p>å¤æ‚åº¦ï¼šO(log(N)) for each member requested, where N is the number of elements in the sorted set</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">äº‘æœåŠ¡å™¨:0&gt;geopos china beijing shanghai</span><br><span class="line">1)  1) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">    2) <span class="string">&quot;37.50266842333162032&quot;</span></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">    2) <span class="string">&quot;38.11555639549629859&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>GEOGADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥å›­å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ï¼Œ</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">6</span>.<span class="number">2</span>ä¹‹åå·²åºŸå¼ƒ</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>å‘½ä»¤æ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] </span><br><span class="line">[COUNT count [ANY]] [ASC|DESC] [STORE key] [STOREDIST key]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>èŒƒå›´å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å…¶ä¸­ä¸€ä¸ªå•ä½ï¼š</p>
<ul>
<li>m è¡¨ç¤ºå•ä½ä¸ºç±³ã€‚</li>
<li>km è¡¨ç¤ºå•ä½ä¸ºåƒç±³ã€‚</li>
<li>mi è¡¨ç¤ºå•ä½ä¸ºè‹±é‡Œã€‚</li>
<li>ft è¡¨ç¤ºå•ä½ä¸ºè‹±å°ºã€‚</li>
</ul>
</li>
<li>
<p>åœ¨ç»™å®šä»¥ä¸‹å¯é€‰é¡¹æ—¶ï¼Œ å‘½ä»¤ä¼šè¿”å›é¢å¤–çš„ä¿¡æ¯ï¼š</p>
<ul>
<li>WITHDIST: åœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶ï¼Œ å°†ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚ è·ç¦»çš„å•ä½å’Œç”¨æˆ·ç»™å®šçš„èŒƒå›´å•ä½ä¿æŒä¸€è‡´ã€‚</li>
<li>WITHCOORD: å°†ä½ç½®å…ƒç´ çš„ç»åº¦å’Œç»´åº¦ä¹Ÿä¸€å¹¶è¿”å›ã€‚</li>
<li>WITHHASH: ä»¥ 52 ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼ï¼Œ è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹ geohash ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•ï¼Œ å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚</li>
</ul>
</li>
<li>
<p>å‘½ä»¤é»˜è®¤è¿”å›æœªæ’åºçš„ä½ç½®å…ƒç´ ã€‚ é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼Œ ç”¨æˆ·å¯ä»¥æŒ‡å®šè¢«è¿”å›ä½ç½®å…ƒç´ çš„æ’åºæ–¹å¼ï¼š</p>
<ul>
<li>ASC: æ ¹æ®ä¸­å¿ƒçš„ä½ç½®ï¼Œ æŒ‰ç…§ä»è¿‘åˆ°è¿œçš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´ ã€‚</li>
<li>DESC: æ ¹æ®ä¸­å¿ƒçš„ä½ç½®ï¼Œ æŒ‰ç…§ä»è¿œåˆ°è¿‘çš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´ ã€‚</li>
</ul>
</li>
<li>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ GEORADIUS å‘½ä»¤ä¼šè¿”å›æ‰€æœ‰åŒ¹é…çš„ä½ç½®å…ƒç´ ã€‚ è™½ç„¶ç”¨æˆ·å¯ä»¥ä½¿ç”¨ COUNT é€‰é¡¹å»è·å–å‰ N ä¸ªåŒ¹é…å…ƒç´ ï¼Œ ä½†æ˜¯å› ä¸ºå‘½ä»¤åœ¨å†…éƒ¨å¯èƒ½ä¼šéœ€è¦å¯¹æ‰€æœ‰è¢«åŒ¹é…çš„å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œ æ‰€ä»¥åœ¨å¯¹ä¸€ä¸ªéå¸¸å¤§çš„åŒºåŸŸè¿›è¡Œæœç´¢æ—¶ï¼Œ å³ä½¿åªä½¿ç”¨ COUNT é€‰é¡¹å»è·å–å°‘é‡å…ƒç´ ï¼Œ å‘½ä»¤çš„æ‰§è¡Œé€Ÿåº¦ä¹Ÿå¯èƒ½ä¼šéå¸¸æ…¢ã€‚ ä½†æ˜¯ä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œ ä½¿ç”¨ COUNT é€‰é¡¹å»å‡å°‘éœ€è¦è¿”å›çš„å…ƒç´ æ•°é‡ï¼Œ å¯¹äºå‡å°‘å¸¦å®½æ¥è¯´ä»ç„¶æ˜¯éå¸¸æœ‰ç”¨çš„</p>
</li>
<li>
<p>è¿”å›å€¼ï¼š</p>
<ul>
<li>åœ¨æ²¡æœ‰ç»™å®šä»»ä½• WITH é€‰é¡¹çš„æƒ…å†µä¸‹ï¼Œ å‘½ä»¤åªä¼šè¿”å›ä¸€ä¸ªåƒ [â€œNew Yorkâ€,â€Milanâ€,â€Parisâ€] è¿™æ ·çš„çº¿æ€§ï¼ˆlinearï¼‰åˆ—è¡¨ã€‚</li>
<li>åœ¨æŒ‡å®šäº† WITHCOORD ã€ WITHDIST ã€ WITHHASH ç­‰é€‰é¡¹çš„æƒ…å†µä¸‹ï¼Œ å‘½ä»¤è¿”å›ä¸€ä¸ªäºŒå±‚åµŒå¥—æ•°ç»„ï¼Œ å†…å±‚çš„æ¯ä¸ªå­æ•°ç»„å°±è¡¨ç¤ºä¸€ä¸ªå…ƒç´ ã€‚</li>
<li>åœ¨è¿”å›åµŒå¥—æ•°ç»„æ—¶ï¼Œ å­æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ€»æ˜¯ä½ç½®å…ƒç´ çš„åå­—ã€‚ è‡³äºé¢å¤–çš„ä¿¡æ¯ï¼Œ åˆ™ä¼šä½œä¸ºå­æ•°ç»„çš„åç»­å…ƒç´ ï¼Œ æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¢«è¿”å›ï¼š
<ul>
<li>ä»¥æµ®ç‚¹æ•°æ ¼å¼è¿”å›çš„ä¸­å¿ƒä¸ä½ç½®å…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼Œ å•ä½ä¸ç”¨æˆ·æŒ‡å®šèŒƒå›´æ—¶çš„å•ä½ä¸€è‡´ã€‚</li>
<li>geohash æ•´æ•°ã€‚</li>
<li>ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆçš„åæ ‡ï¼Œåˆ†åˆ«ä¸ºç»åº¦å’Œçº¬åº¦</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¸¾ä¾‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">äº‘æœåŠ¡å™¨:0&gt;GEORADIUS china 15 37 200 km WITHDIST WITHCOORD</span><br><span class="line">1)  1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    2) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">        2) <span class="string">&quot;38.11555639549629859&quot;</span></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    2) <span class="string">&quot;56.4413&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">        2) <span class="string">&quot;37.50266842333162032&quot;</span></span><br><span class="line"></span><br><span class="line">äº‘æœåŠ¡å™¨:0&gt;GEORADIUS china 15 37 200 km WITHDIST</span><br><span class="line">1)  1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    2) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    2) <span class="string">&quot;56.4413&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸åˆ¶å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ï¼ŒèŒƒå›´å¯ä»¥ä½¿åœ†å½¢æˆ–çŸ©å½¢ï¼Œ6.2çš„æ–°åŠŸèƒ½</p>
<p>å‘½ä»¤æ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCH key [FROMMEMBER member] [FROMLONLAT longitude latitude] [BYRADIUS radius m|km|ft|mi] </span><br><span class="line">[BYBOX width height m|km|ft|mi] [ASC|DESC] [COUNT count [ANY]] [WITHCOORD] [WITHDIST] [WITHHASH]</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>ä¸¾ä¾‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">äº‘æœåŠ¡å™¨:0&gt;geosearch china FROMLONLAT 15 37 BYRADIUS 200 km ASC WITHCOORD WITHDIST</span><br><span class="line">1)  1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    2) <span class="string">&quot;56.4413&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">        2) <span class="string">&quot;37.50266842333162032&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    2) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">        2) <span class="string">&quot;38.11555639549629859&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">äº‘æœåŠ¡å™¨:0&gt;geosearch china FROMLONLAT 15 37 BYBOX 400 400 km DESC WITHCOORD WITHDIST</span><br><span class="line">1)  1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    2) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">        2) <span class="string">&quot;38.11555639549629859&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    2) <span class="string">&quot;56.4413&quot;</span></span><br><span class="line">    3)  S1) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">        2) <span class="string">&quot;37.50266842333162032&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyï¼Œä¹Ÿæ˜¯6.2çš„æ–°åŠŸèƒ½</p>
<ul>
<li>
<p>å‘½ä»¤æ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCHSTORE destination <span class="built_in">source</span> [FROMMEMBER member] [FROMLONLAT longitude latitude] </span><br><span class="line">[BYRADIUS radius m|km|ft|mi] [BYBOX width height m|km|ft|mi] </span><br><span class="line">[ASC|DESC] [COUNT count [ANY]] [STOREDIST]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¿™ä¸ªå‘½ä»¤å’Œ GEORADIUS å‘½ä»¤ä¸€æ ·ï¼Œ éƒ½å¯ä»¥æ‰¾å‡ºä½äºæŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼Œ ä½†æ˜¯ GEORADIUSBYMEMBER çš„ä¸­å¿ƒç‚¹æ˜¯ç”±ç»™å®šçš„ä½ç½®å…ƒç´ å†³å®šçš„ï¼Œ è€Œä¸æ˜¯åƒ GEORADIUS é‚£æ ·ï¼Œ ä½¿ç”¨è¾“å…¥çš„ç»åº¦å’Œçº¬åº¦æ¥å†³å®šä¸­å¿ƒç‚¹</p>
</li>
<li>
<p>æŒ‡å®šæˆå‘˜çš„ä½ç½®è¢«ç”¨ä½œæŸ¥è¯¢çš„ä¸­å¿ƒã€‚</p>
</li>
<li>
<p>å…³äº GEORADIUSBYMEMBER å‘½ä»¤çš„æ›´å¤šä¿¡æ¯ï¼Œ è¯·å‚è€ƒ GEORADIUS å‘½ä»¤çš„æ–‡æ¡£</p>
</li>
<li>
<p>å¤æ‚åº¦ï¼šO(N+log(M)) where N is the number of elements inside the bounding box of the circular area delimited by center and radius and M is the number of items inside the index</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">äº‘æœåŠ¡å™¨:0&gt;GEORADIUSBYMEMBER china beijing 200 km</span><br><span class="line">1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">2) <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO">å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h2>
<ul>
<li>å…·ä½“åœºæ™¯è¯´æ˜ï¼Œä¾‹å¦‚ç¾å›¢/é¥¿äº†ä¹ˆè¿™ç§å¤–å–Appï¼Œä½ æ˜¯å¯ä»¥çœ‹åˆ°å•†å®¶ç¦»ä½ æœ‰å¤šè¿œçš„ï¼Œé‚£æˆ‘ä»¬ç°åœ¨ä¹Ÿè¦å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GEOæ¥å®ç°è¯¥åŠŸèƒ½ï¼Œä»¥å½“å‰åæ ‡ä¸ºåœ†å¿ƒï¼ŒåŒæ—¶ç»‘å®šç›¸åŒçš„åº—å®¶ç±»å‹typeï¼Œä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ŒæŠŠè¿™å‡ ä¸ªæ¡ä»¶æ’å…¥åå°ï¼Œåå°æŸ¥è¯¢å‡ºå¯¹åº”çš„æ•°æ®å†è¿”å›</li>
<li>é‚£ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼šå°†æ•°æ®åº“ä¸­çš„æ•°æ®å¯¼å…¥åˆ°Redisä¸­å»ï¼ŒGEOåœ¨Redisä¸­å°±æ˜¯ä¸€ä¸ªmemberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œç»çº¬åº¦å¯¹åº”çš„å°±æ˜¯tb_shopä¸­çš„xå’Œyï¼Œè€Œmemberï¼Œæˆ‘ä»¬ç”¨shop_idæ¥å­˜ï¼Œå› ä¸ºRedisåªæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡çš„æ•°æ®ï¼Œè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åªå­˜ä¸€ä¸ªidï¼Œç”¨çš„æ—¶å€™å†æ‹¿idå»SQLæ•°æ®åº“ä¸­æŸ¥è¯¢shopä¿¡æ¯</li>
<li>ä½†æ˜¯æ­¤æ—¶è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨redisä¸­æ²¡æœ‰å­˜å‚¨shop_typeï¼Œæ— æ³•æ ¹æ®åº—é“ºç±»å‹æ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œè§£å†³åŠæ³•å°±æ˜¯å°†type_idä½œä¸ºkeyï¼Œå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆå³å¯</li>
</ul>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
<th>Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>shop:geo:ç¾é£Ÿ</td>
<td>æµ·åº•æ</td>
<td>40691512240174598</td>
</tr>
<tr>
<td>å‰é‡å®¶</td>
<td>40691519846517915</td>
<td></td>
</tr>
<tr>
<td>shop:geo:KTV</td>
<td>KTV 01</td>
<td>40691165486458787</td>
</tr>
<tr>
<td>KTV 02</td>
<td>40691514154651657</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. æŸ¥è¯¢æ‰€æœ‰åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; shopList = shopService.list();</span><br><span class="line">    <span class="comment">//2. æŒ‰ç…§typeIdï¼Œå°†åº—é“ºè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = shopList.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">//3. é€ä¸ªå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//3.1 è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="comment">//3.2 è·å–åŒç±»å‹åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; shops = entry.getValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//3.3 å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">            stringRedisTemplate.opsForGeo().add(key,<span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(),shop.getY()),shop.getId().toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½†æ˜¯ä¸Šé¢çš„ä»£ç ä¸å¤Ÿä¼˜é›…ï¼Œæ˜¯ä¸€æ¡ä¸€æ¡å†™å…¥çš„ï¼Œæ•ˆç‡è¾ƒä½ï¼Œé‚£æˆ‘ä»¬ç°åœ¨æ¥æ”¹è¿›ä¸€ä¸‹ï¼Œè¿™æ ·åªéœ€è¦å†™å…¥ç­‰åŒäºtype_idæ•°é‡çš„æ¬¡æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Shop&gt; shopList = shopService.list();</span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = shopList.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        List&lt;Shop&gt; shops = entry.getValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(shops.size());</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//å°†å½“å‰typeçš„å•†é“ºéƒ½æ·»åŠ åˆ°locationsé›†åˆä¸­</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(shop.getId().toString(), <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰¹é‡å†™å…¥</span></span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»£ç ç¼–å†™å®Œæ¯•ï¼Œæˆ‘ä»¬å¯åŠ¨æµ‹è¯•æ–¹æ³•ï¼Œç„¶åå»Rediså›¾å½¢åŒ–ç•Œé¢ä¸­æŸ¥çœ‹æ˜¯å¦æœ‰å¯¹åº”çš„æ•°æ®</p>
</li>
</ul>
<h2 id="å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½">å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h2>
<ul>
<li>
<p>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„pom.xmlæ–‡ä»¶</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç‚¹å‡»è·ç¦»åˆ†ç±»ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</p>
<blockquote>
<p>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/shop/of/type?&amp;typeId=1&amp;current=1&amp;x=120.149993&amp;y=30.334229">http://localhost:8080/api/shop/of/type?&amp;typeId=1&amp;current=1&amp;x=120.149993&amp;y=30.334229</a><br>
è¯·æ±‚æ–¹æ³•: GET</p>
</blockquote>
</li>
<li>
<p>çœ‹æ ·å­æ˜¯ShopControllerä¸­çš„æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç°åœ¨æ¥ä¿®æ”¹å…¶ä»£ç ï¼Œé™¤äº†typeIdï¼Œåˆ†é¡µç ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…¶åæ ‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId,current,x,y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…·ä½“ä¸šåŠ¡é€»è¾‘ä¾æ—§æ˜¯å†™åœ¨ShopServiceImplä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">    <span class="comment">//1. åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®è·ç¦»æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2. è®¡ç®—åˆ†é¡µæŸ¥è¯¢å‚æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.MAX_PAGE_SIZE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.MAX_PAGE_SIZE;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">    <span class="comment">//3. æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µ; ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">    <span class="comment">//GEOSEARCH key FROMLONLAT x y BYRADIUS 5000 m WITHDIST</span></span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo().search(key,</span><br><span class="line">            GeoReference.fromCoordinate(x, y),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),</span><br><span class="line">            RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end));</span><br><span class="line">    <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. è§£æå‡ºid</span></span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">    <span class="keyword">if</span> (list.size() &lt; from) &#123;</span><br><span class="line">        <span class="comment">//èµ·å§‹æŸ¥è¯¢ä½ç½®å¤§äºæ•°æ®æ€»é‡ï¼Œåˆ™è¯´æ˜æ²¡æ•°æ®äº†ï¼Œè¿”å›ç©ºé›†åˆ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">    HashMap&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">    list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">        ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">        <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">        distanceMap.put(shopIdStr, distance);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//5. æ ¹æ®idæŸ¥è¯¢shop</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD( id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®shopçš„ä¸¾ä¾‹å±æ€§ï¼Œä»distanceMapä¸­æ ¹æ®shopIdæŸ¥è¯¢</span></span><br><span class="line">        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥æ˜¾ç¤ºå‡ºè·ç¦»<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6364c8c216f2c2beb16eb996.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6364c8c216f2c2beb16eb996.jpg" alt="img"></a></p>
</li>
</ul>
<h1>ç”¨æˆ·ç­¾åˆ°</h1>
<h2 id="BitMapåŠŸèƒ½æ¼”ç¤º">BitMapåŠŸèƒ½æ¼”ç¤º</h2>
<ul>
<li>æˆ‘ä»¬é’ˆå¯¹ç­¾åˆ°åŠŸèƒ½å®Œå…¨å¯ä»¥é€šè¿‡MySQLæ¥å®Œæˆï¼Œä¾‹å¦‚ä¸‹é¢è¿™å¼ è¡¨</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">ä¸»é”®</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç”¨æˆ·id</td>
</tr>
<tr>
<td style="text-align:center">year</td>
<td style="text-align:center">year</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç­¾åˆ°çš„å¹´</td>
</tr>
<tr>
<td style="text-align:center">month</td>
<td style="text-align:center">tinyint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç­¾åˆ°çš„æœˆ</td>
</tr>
<tr>
<td style="text-align:center">date</td>
<td style="text-align:center">date</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç­¾åˆ°çš„æ—¥æœŸ</td>
</tr>
<tr>
<td style="text-align:center">is_backup</td>
<td style="text-align:center">tinyint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">æ˜¯å¦è¡¥ç­¾</td>
</tr>
</tbody>
</table>
<ul>
<li>ç”¨æˆ·ç­¾åˆ°ä¸€æ¬¡ï¼Œå°±æ˜¯ä¸€æ¡è®°å½•ï¼Œå‡å¦‚æœ‰1000Wç”¨æˆ·ï¼Œå¹³å‡æ²¡äººæ¯å¹´ç­¾åˆ°10æ¬¡ï¼Œé‚£è¿™å¼ è¡¨ä¸€å¹´çš„æ•°æ®é‡å°±æœ‰1äº¿æ¡</li>
<li>é‚£æœ‰æ²¡æœ‰æ–¹æ³•èƒ½ç®€åŒ–ä¸€ç‚¹å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶ä½æ¥è®°å½•æ¯ä¸ªæœˆçš„ç­¾åˆ°æƒ…å†µï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°è®°å½•ä¸º0</li>
<li>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆæ˜ å°„å…³ç³»ï¼Œç”¨0å’Œ1æ ‡è¯†ä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±æˆä¸ºä½å›¾ï¼ˆBitMapï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°å¤§é‡æ•°æ®çš„è¡¨ç¤º</li>
<li>Redisä¸­æ˜¯åˆ©ç”¨Stringç±»å‹æ•°æ®ç»“æ„å®ç°BitMapï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯2^32ä¸ªbitä½</li>
<li>BitMapçš„æ“ä½œå‘½ä»¤æœ‰
<ul>
<li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li>
<li>GETBITï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li>
<li>BITCOUNTï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li>
<li>BITFIELDï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li>
<li>BITFIELD_ROï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li>
<li>BITOPï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ã€æˆ–ã€å¼‚æˆ–ï¼‰</li>
<li>BITPOSï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li>
</ul>
</li>
</ul>
<h2 id="å®ç°ç­¾åˆ°åŠŸèƒ½">å®ç°ç­¾åˆ°åŠŸèƒ½</h2>
<ul>
<li>éœ€æ±‚ï¼šå®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">è¯·æ±‚æ–¹å¼</td>
<td style="text-align:center">Post</td>
</tr>
<tr>
<td style="text-align:center">è¯·æ±‚è·¯å¾„</td>
<td style="text-align:center">/user/sign</td>
</tr>
<tr>
<td style="text-align:center">è¯·æ±‚å‚æ•°</td>
<td style="text-align:center">æ— </td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">æ— </td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥æŠŠå¹´å’Œæœˆä½œä¸ºBitMapçš„keyï¼Œç„¶åä¿å­˜åˆ°ä¸€ä¸ªBitMapä¸­ï¼Œæ¯æ¬¡ç­¾åˆ°å°±æŠŠå¯¹åº”ä½ä¸Šçš„0å˜æˆ1ï¼Œåªè¦æ˜¯1å°±è¯´æ˜è¿™ä¸€å¤©å·²ç»ç­¾åˆ°äº†ï¼Œåä¹‹åˆ™æ²¡æœ‰ç­¾åˆ°</p>
</li>
<li>
<p>ç”±äºBitMapåº•å±‚æ˜¯åŸºäºStringæ•°æ®ç»“æ„ï¼Œå› æ­¤å…¶æ“ä½œä¹Ÿéƒ½å°è£…åœ¨å­—ç¬¦ä¸²ç›¸å…³æ“ä½œä¸­äº†</p>
</li>
<li>
<p>åœ¨UserControllerä¸­ç¼–å†™å¯¹åº”çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.sign();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…·ä½“å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">//3. æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4. è·å–ä»Šå¤©æ˜¯å½“æœˆç¬¬å‡ å¤©(1~31)</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5. å†™å…¥Redis  BITSET key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨PostManå‘é€è¯·æ±‚æµ‹è¯•ï¼Œæ³¨æ„è¯·æ±‚å¤´ä¸­éœ€æºå¸¦ç™»å½•ç”¨æˆ·çš„tokenï¼Œå¦åˆ™æ— æ•ˆï¼ˆåˆæµªè´¹æˆ‘äº”åˆ†é’Ÿæ‰¾è¿™ä¸ªé—®é¢˜ï¼‰</p>
</li>
<li>
<p>å‘é€æˆåŠŸä¹‹åï¼Œåœ¨Rediså›¾å½¢åŒ–ç•Œé¢ä¸­æ˜¯å¯ä»¥çœ‹åˆ°çš„</p>
</li>
</ul>
<h2 id="ç­¾åˆ°ç»Ÿè®¡">ç­¾åˆ°ç»Ÿè®¡</h2>
<ul>
<li>
<p>å¦‚ä½•è·å–æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ</p>
<ul>
<li>BITFIELD key GET u[dayOfMonth] 0</li>
</ul>
</li>
<li>
<p>å¦‚ä½•ä»åå¾€å‰éå†æ¯ä¸ªbitä½ï¼Œè·å–è¿ç»­ç­¾åˆ°å¤©æ•°</p>
<ul>
<li>
<p>è¿ç»­ç­¾åˆ°å¤©æ•°ï¼Œå°±æ˜¯ä»æœ«å°¾å¾€å‰æ•°ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª1</p>
</li>
<li>
<p>ç®€å•çš„ä½è¿ç®—ç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>((num &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        count++;</span><br><span class="line">    num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> count;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">è¯·æ±‚æ–¹å¼</td>
<td style="text-align:center">GET</td>
</tr>
<tr>
<td style="text-align:center">è¯·æ±‚è·¯å¾„</td>
<td style="text-align:center">/user/sign/count</td>
</tr>
<tr>
<td style="text-align:center">è¯·æ±‚å‚æ•°</td>
<td style="text-align:center">æ— </td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">è¿ç»­ç­¾åˆ°å¤©æ•°</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>åœ¨UserControllerä¸­åˆ›å»ºå¯¹åº”çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sign/count&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.signCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åœ¨UserServiceImplä¸­å®ç°æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">//3. æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4. è·å–ä»Šå¤©æ˜¯å½“æœˆç¬¬å‡ å¤©(1~31)</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5. è·å–æˆªæ­¢è‡³ä»Šæ—¥çš„ç­¾åˆ°è®°å½•  BITFIELD key GET uDay 0</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(key, BitFieldSubCommands.create()</span><br><span class="line">            .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. å¾ªç¯éå†</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            count++;</span><br><span class="line">        <span class="comment">//æ•°å­—å³ç§»ï¼ŒæŠ›å¼ƒæœ€åä¸€ä½</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨PostManå‘é€è¯·æ±‚ï¼Œå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹redisä¸­çš„ç­¾åˆ°æ•°æ®å¤šæ¬¡æµ‹è¯•ï¼Œå‘è¯·æ±‚çš„æ—¶å€™è¿˜æ˜¯è¦æ³¨æ„æºå¸¦ç™»å½•ç”¨æˆ·çš„token</p>
</li>
</ul>
<h1>UVç»Ÿè®¡</h1>
<h2 id="HyperLogLog">HyperLogLog</h2>
<ul>
<li>
<p>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</p>
</li>
<li>
<p>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</p>
</li>
<li>
<p>æœ¬åšå®¢çš„é¦–é¡µä¾§è¾¹æ å°±æœ‰æœ¬ç«™è®¿å®¢é‡å’Œæœ¬ç«™æ€»è®¿é—®é‡ï¼Œå¯¹åº”çš„å°±æ˜¯UVå’ŒPV</p>
</li>
<li>
<p>é€šå¸¸æ¥è¯´PVä¼šæ¯”UVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ã€‚</p>
</li>
<li>
<p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šå¾ˆéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ä¿¡æ¯ä¿å­˜ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œé‚£ä¹ˆæ•°æ®åº“ä¼šéå¸¸ææ€–ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
</li>
<li>
<p>HyperLogLog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨æˆ·ç¡®å®šéå¸¸å¤§çš„é›†åˆåŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ï¼Œç®—æ³•ç›¸å…³åŸç†å¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a></p>
</li>
<li>
<p>Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜<code>æ°¸è¿œå°äº16kb</code>ï¼Œ<code>å†…å­˜å ç”¨ä½</code>çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<code>æœ‰å°äº0.81ï¼…çš„è¯¯å·®</code>ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p>
</li>
<li>
<p>å¸¸ç”¨çš„ä¸‰ä¸ªæ–¹æ³•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PFADD key element [element...]</span><br><span class="line">summary: Adds the specified elements to the specified HyperLogLog</span><br><span class="line"></span><br><span class="line">PFCOUNT key [key ...]</span><br><span class="line">Return the approximated cardinality of the <span class="built_in">set</span>(s) observed by the HyperLogLog at key(s).</span><br><span class="line"></span><br><span class="line">PFMERGE destkey sourcekey [sourcekey ...]</span><br><span class="line">lnternal commands <span class="keyword">for</span> debugging HyperLogLog values</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡">æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</h2>
<ul>
<li>
<p>ä½¿ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨æ˜¯å¦çœŸçš„é‚£ä¹ˆä½ï¼Œä»¥åŠç»Ÿè®¡è¯¯å·®å¦‚ä½•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] users = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        j = i % <span class="number">1000</span>;</span><br><span class="line">        users[j] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">999</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;HLL&quot;</span>, users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;HLL&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ’å…¥100Wæ¡æ•°æ®ï¼Œå¾—åˆ°çš„countä¸º997593ï¼Œè¯¯å·®ç‡ä¸º0.002407%</p>
</li>
<li>
<p>å»Rediså›¾å½¢åŒ–ç•Œé¢ä¸­æŸ¥çœ‹å ç”¨æƒ…å†µä¸ºï¼š12.3Kå­—èŠ‚</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Redisé«˜çº§</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://w-zx.cc/posts/redis03.html">https://w-zx.cc/posts/redis03.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>çˆ±å­¦æŠ€æœ¯çš„å°å´ğŸµ</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2023-05-15</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-05-20</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>æ•°æ®åº“</a><a class="post-meta__tags" href="/tags/Redis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Redis</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://i.postimg.cc/1tmk8v0k/QQ-20230520160616.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.postimg.cc/1tmk8v0k/QQ-20230520160616.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://i.postimg.cc/3JkHjbM7/QQ-20230520160610.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.postimg.cc/3JkHjbM7/QQ-20230520160610.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/ssm01.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27069" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ssmæ•´åˆ</div></div></a></div><div class="next-post pull-right"><a href="/posts/C07.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">C++èŒå·¥ç³»ç»Ÿé¡¹ç›®</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/redis01.html" title="Rediså…¥é—¨"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27067" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-05-20</div><div class="title">Rediså…¥é—¨</div></div></a></div><div><a href="/posts/redis02.html" title="RedisåŸºç¡€"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27055" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-05-20</div><div class="title">RedisåŸºç¡€</div></div></a></div><div><a href="/posts/shujuku01.html" title="MYSQL"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-05-17</div><div class="title">MYSQL</div></div></a></div><div><a href="/posts/MyBatis02.html" title="MyBatis - Plus"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27057" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-05-17</div><div class="title">MyBatis - Plus</div></div></a></div><div><a href="/posts/MyBatis01.html" title="MyBatis"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27068" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-05-17</div><div class="title">MyBatis</div></div></a></div><div><a href="/posts/shujuku02.html" title="MYSQL"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27062" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-05-27</div><div class="title">MYSQL</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">å†…å®¹æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E9%A1%B9%E7%9B%AE"><span class="toc-text">å¯¼å…¥é¡¹ç›®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5SQL"><span class="toc-text">å¯¼å…¥SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E5%85%B3%E5%BD%93%E5%89%8D%E6%A8%A1%E5%9E%8B"><span class="toc-text">æœ‰å…³å½“å‰æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-text">å¯¼å…¥åç«¯é¡¹ç›®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B"><span class="toc-text">å¯¼å…¥å‰ç«¯å·¥ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ESession%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-text">åŸºäºSessionå®ç°ç™»å½•æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD"><span class="toc-text">å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA%E5%8A%9F%E8%83%BD"><span class="toc-text">å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-text">éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-text">sessionå…±äº«é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E6%9B%BF%E4%BB%A3session%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">Redisæ›¿ä»£sessionçš„ä¸šåŠ¡æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1key%E7%BB%93%E6%9E%84"><span class="toc-text">è®¾è®¡keyç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1key%E7%9A%84%E5%85%B7%E4%BD%93%E7%BB%86%E8%8A%82"><span class="toc-text">è®¾è®¡keyçš„å…·ä½“ç»†èŠ‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-text">æ•´ä½“è®¿é—®æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-text">è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E6%96%B9%E6%A1%88"><span class="toc-text">åˆå§‹æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-text">ä¼˜åŒ–æ–¹æ¡ˆ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-text">ä»€ä¹ˆæ˜¯ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98"><span class="toc-text">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98"><span class="toc-text">å¦‚ä½•ä½¿ç”¨ç¼“å­˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%95%86%E6%88%B7%E7%BC%93%E5%AD%98"><span class="toc-text">æ·»åŠ å•†æˆ·ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%80%9D%E8%B7%AF"><span class="toc-text">ç¼“å­˜æ¨¡å‹å’Œæ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%81%E7%83%AD%E6%89%93%E9%93%81"><span class="toc-text">è¶çƒ­æ‰“é“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E9%A1%B5%E5%88%97%E8%A1%A8%E7%BC%93%E5%AD%98-P37"><span class="toc-text">é¦–é¡µåˆ—è¡¨ç¼“å­˜(P37)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stirng%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E5%AE%9E%E7%8E%B0"><span class="toc-text">Stirngç¼“å­˜ç­–ç•¥å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#List%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E5%AE%9E%E7%8E%B0"><span class="toc-text">Listç¼“å­˜ç­–ç•¥å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E9%87%87%E7%94%A8%E4%BB%80%E4%B9%88%E6%96%B9%E6%A1%88"><span class="toc-text">æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%95%86%E9%93%BA%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4"><span class="toc-text">å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">ç¼“å­˜ç©¿é€é—®é¢˜çš„è§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E8%A7%A3%E5%86%B3%E5%95%86%E5%93%81%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="toc-text">ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94%E4%BA%92%E6%96%A5%E9%94%81%E4%B8%8E%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4"><span class="toc-text">å¯¹æ¯”äº’æ–¥é”ä¸é€»è¾‘åˆ é™¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E4%BA%92%E6%96%A5%E9%94%81%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-text">åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-text">åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85Redis%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">å°è£…Rediså·¥å…·ç±»</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">ä¼˜æƒ åˆ¸ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">Rediså®ç°å…¨å±€å”¯ä¸€ID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BC%98%E6%83%A0%E5%88%B8"><span class="toc-text">æ·»åŠ ä¼˜æƒ åˆ¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">å®ç°ç§’æ€ä¸‹å•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-text">è¶…å–é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-text">ä¸€äººä¸€å•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-text">é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-text">åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF"><span class="toc-text">Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">å®ç°åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E6%83%85%E5%86%B5%E8%AF%B4%E6%98%8E"><span class="toc-text">Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E9%97%AE%E9%A2%98"><span class="toc-text">è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E8%84%9A%E6%9C%AC%E8%A7%A3%E5%86%B3%E5%A4%9A%E6%9D%A1%E5%91%BD%E4%BB%A4%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Java%E4%BB%A3%E7%A0%81%E8%B0%83%E7%94%A8Lua%E8%84%9A%E6%9C%AC%E6%94%B9%E9%80%A0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">åˆ†å¸ƒå¼é”-Redisson</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E5%85%A5%E9%97%A8"><span class="toc-text">Redissonå…¥é—¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">Redissonå¯é‡å…¥é”åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E9%94%81%E9%87%8D%E8%AF%95%E5%92%8CWatchDog%E6%9C%BA%E5%88%B6"><span class="toc-text">Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E9%94%81%E7%9A%84MutiLock%E5%8E%9F%E7%90%86"><span class="toc-text">Redissoné”çš„MutiLockåŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">ç§’æ€ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E6%80%9D%E8%B7%AF"><span class="toc-text">å¼‚æ­¥ç§’æ€æ€è·¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%AE%8C%E6%88%90%E7%A7%92%E6%9D%80%E8%B5%84%E6%A0%BC%E5%88%A4%E6%96%AD"><span class="toc-text">Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-text">å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">Redisæ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EList%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EPubSub%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E2%80%94%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-text">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—â€”æ¶ˆè´¹è€…ç»„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stream%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">Streamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">è¾¾äººæ¢åº—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">å‘å¸ƒæ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">æŸ¥çœ‹æ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">ç‚¹èµåŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-text">ç‚¹èµæ’è¡Œæ¦œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">å¥½å‹å…³æ³¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-text">å…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">Feedæµå®ç°æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">é™„è¿‘å•†æˆ·</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO"><span class="toc-text">å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-text">å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">ç”¨æˆ·ç­¾åˆ°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BitMap%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA"><span class="toc-text">BitMapåŠŸèƒ½æ¼”ç¤º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">å®ç°ç­¾åˆ°åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-text">ç­¾åˆ°ç»Ÿè®¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">UVç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HyperLogLog"><span class="toc-text">HyperLogLog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="toc-text">æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/nav/">ç½‘å€å¯¼èˆª</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="FomalhautğŸ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2023</b></span><span><b>&nbsp;&nbsp;By çˆ±å­¦æŠ€æœ¯çš„å°å´ğŸµ</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/èŒICPå¤‡-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="èŠå¤©"><i class="fas fa-sms"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span>é˜…è¯»æ¨¡å¼</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'qRHraBhVfBon4UW97vUo6c6k-gzGzoHsz',
      appKey: 'KcuRFd21A85bofYWkqw7bO5M',
      placeholder: '',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      master: ''.split(','),
      friends: ''.split(','),
      tagMeta: 'åšä¸»,å°ä¼™ä¼´,è®¿å®¢'.split(','),
      metaPlaceholder: {},
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdnjs.cloudflare.com/ajax/libs/valine/1.4.18/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/canvas-fluttering-ribbon.min.js"></script><script src="//code.tidio.co/s6lf1eubpeuqxvderp74uj8qlp7dx0qc.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ ç®—æ³•å­¦ä¹ ç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/C/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ C++ç¬”è®° (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/MyBatis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ MyBatisç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/MySql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ MySqlç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/JVM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸƒ JVMç¬”è®° (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/SpringBoot/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‘ SpringBootç¬”è®° (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/SpringCloud/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥­ SpringCloudç¬”è®° (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/SSM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸƒ SSMç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‚ Redisç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://w-zx.cc/categories/JavaWeb/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ JavaWebç¬”è®° (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://w-zx.cc/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/f4ff8066a7ba7ab5adc730e776aadbc3.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/ç»“æ„/&quot;);" href="javascript:void(0);">ç»“æ„</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">è®¡ç®—æœºçŸ¥è¯†çš„å­¦ä¹ </span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/f38fc3400758385eff9bf77265ca2509.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/C/&quot;);" href="javascript:void(0);">C++</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr">C++</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/a8436f6a4af0bec512f29f9a8c71d86d.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/SpringCloud/&quot;);" href="javascript:void(0);">SpringCloud</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">SpringCloud</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/c562fbb36709afc81f1068deacea08fd.md.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/JAVA/&quot;);" href="javascript:void(0);">JAVA</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr">JAVA</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/0fd95029a75de05623edc2512e94b0b8.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/JVM/&quot;);" href="javascript:void(0);">JVM</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">JVM</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/8e17d3ab324aecc1164680e55d2b316e.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/JavaWeb/&quot;);" href="javascript:void(0);">JavaWeb</a><span class="categoryBar-list-count">7</span><span class="categoryBar-list-descr">JavaWeb</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/6675847a2f316263e92d7cacb5fee143.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Redis/&quot;);" href="javascript:void(0);">Redis</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">Redis</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/0b571a5a0b0e91f4289ddeb7fe643f66.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/MyBatis/&quot;);" href="javascript:void(0);">MyBatis</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">MyBatis</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/987d0ff1c8f1f402cc76df347b79f660.md.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/MySql/&quot;);" href="javascript:void(0);">MySql</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">MySql</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/96a9486dfa9f0d06b9dd3aae8bca1c1d.md.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/SSM/&quot;);" href="javascript:void(0);">SSM</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">SSM</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/168c6a1a28074990a9919f48dc0b9abd.md.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/SpringBoot/&quot;);" href="javascript:void(0);">SpringBoot</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">SpringBoot</span></li><li class="categoryBar-list-item" style="background:url(https://img.gejiba.com/images/3df36772603dcb3ec71392a2ed49543e.md.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/ç®—æ³•/&quot;);" href="javascript:void(0);">ç®—æ³•</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">ç®—æ³•</span></li></ul></div></div>';
      console.log('å·²æŒ‚è½½butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/shujuku02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27062" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-23</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/shujuku02.html&quot;);" href="javascript:void(0);" alt="">MYSQL</a><div class="blog-slider__text">æ•°æ®åº“çš„åŸºç¡€å­¦ä¹ </div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/shujuku02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/shujuku01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-23</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/shujuku01.html&quot;);" href="javascript:void(0);" alt="">MYSQL</a><div class="blog-slider__text">æ•°æ®åº“çš„åŸºç¡€å­¦ä¹ </div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/shujuku01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/sjms01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/sjms01.html&quot;);" href="javascript:void(0);" alt="">è®¾è®¡æ¨¡å¼</a><div class="blog-slider__text">äº†è§£æ¯ä¸ªæ¨¡å¼å¼€å‘çš„ä½¿ç”¨ç¯å¢ƒ</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/sjms01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javaShuJu.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27056" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javaShuJu.html&quot;);" href="javascript:void(0);" alt="">Javaæ•°æ®ç»“æ„</a><div class="blog-slider__text">äº†è§£ç»“æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javaShuJu.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/own01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27056" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/own01.html&quot;);" href="javascript:void(0);" alt="">ä¸ªäººå­¦ä¹ è·¯çº¿</a><div class="blog-slider__text">è‡ªå·±çš„å­¦ä¹ æ–¹å‘ä»¥åŠä¸ªäººä¸€äº›æ„Ÿæ‚Ÿ</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/own01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javawl.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27050" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javawl.html&quot;);" href="javascript:void(0);" alt="">Javaç½‘ç»œç¼–ç¨‹</a><div class="blog-slider__text">JAVAè¿›é˜¶æ¨¡å—,äº†è§£ç½‘ç»œ</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javawl.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ES01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27063" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ES01.html&quot;);" href="javascript:void(0);" alt="">ElasticSearch</a><div class="blog-slider__text">æœç´ å¼•æ“ï¼Œå…·å¤‡éå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»æµ·é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å†…å®¹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ES01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/MQ01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27056" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-27</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/MQ01.html&quot;);" href="javascript:void(0);" alt="">MeassagerQueue</a><div class="blog-slider__text">æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨ä¸­çš„Broker</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/MQ01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ruiji01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27067" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ruiji01.html&quot;);" href="javascript:void(0);" alt="">ç‘å‰å¤–å–</a><div class="blog-slider__text">SpringBooté¡¹ç›®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ruiji01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ruiji02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27058" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ruiji02.html&quot;);" href="javascript:void(0);" alt="">ç‘å‰å¤–å–ä¼˜åŒ–</a><div class="blog-slider__text">SpringBooté¡¹ç›®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ruiji02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/redis03.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27050" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/redis03.html&quot;);" href="javascript:void(0);" alt="">Redisé«˜çº§</a><div class="blog-slider__text">ä¸€ä¸ªåŸºäºå†…å­˜çš„`key-value`ç»“æ„æ•°æ®åº“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/redis03.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/springcloud01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27058" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/springcloud01.html&quot;);" href="javascript:void(0);" alt="">SpringCloud</a><div class="blog-slider__text">æŒ‡å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æ•°åˆ†å¸ƒå¼æ¶æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/springcloud01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ssm01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27069" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ssm01.html&quot;);" href="javascript:void(0);" alt="">ssmæ•´åˆ</a><div class="blog-slider__text">ä¸‰ä¸ªæ¡†æ¶æ•´åˆåœ¨ä¸€èµ·ï¼Œæ¥å®Œæˆæˆ‘ä»¬çš„ä¸šåŠ¡åŠŸèƒ½å¼€å‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ssm01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/springboot01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27056" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/springboot01.html&quot;);" href="javascript:void(0);" alt="">SpringBoot</a><div class="blog-slider__text">åŸºäºSpringBootçš„å®ŒæˆSSMæ•´åˆé¡¹ç›®å¼€å‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/springboot01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/git01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27060" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/git01.html&quot;);" href="javascript:void(0);" alt="">Git</a><div class="blog-slider__text">åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œä¸»è¦ç”¨äºç®¡ç†å¼€å‘è¿‡ç¨‹ä¸­çš„æºä»£ç æ–‡ä»¶</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/git01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/jdbc01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27067" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/jdbc01.html&quot;);" href="javascript:void(0);" alt="">JDBC</a><div class="blog-slider__text">æ•°æ®åº“è¿æ¥æ± ,æŒæ¡æ•°æ®åº“çš„ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/jdbc01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/redis02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27055" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/redis02.html&quot;);" href="javascript:void(0);" alt="">RedisåŸºç¡€</a><div class="blog-slider__text">ä¸€ä¸ªåŸºäºå†…å­˜çš„`key-value`ç»“æ„æ•°æ®åº“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/redis02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/maven01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27068" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/maven01.html&quot;);" href="javascript:void(0);" alt="">Maven</a><div class="blog-slider__text">ä»“åº“çš„ä½¿ç”¨, é¡¹ç›®çš„ä¼˜åŒ–å¤„ç†, åˆ†æ¨¡å—å¼€å‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/maven01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/redis01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27067" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/redis01.html&quot;);" href="javascript:void(0);" alt="">Rediså…¥é—¨</a><div class="blog-slider__text">ä¸€ä¸ªåŸºäºå†…å­˜çš„`key-value`ç»“æ„æ•°æ®åº“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/redis01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/linux01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/linux01.html&quot;);" href="javascript:void(0);" alt="">Linux</a><div class="blog-slider__text">æ“ä½œç³»ç»Ÿ</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/linux01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/doceker01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27050" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/doceker01.html&quot;);" href="javascript:void(0);" alt="">Docker</a><div class="blog-slider__text">å†³å¤§å‹é¡¹ç›®ä¾èµ–å…³ç³»å¤æ‚ï¼Œä¸åŒç»„ä»¶ä¾èµ–çš„å…¼å®¹æ€§é—®é¢˜</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/doceker01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/SpringBootds.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27059" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/SpringBootds.html&quot;);" href="javascript:void(0);" alt="">SpringBootç”µå•†é¡¹ç›®</a><div class="blog-slider__text">äº†è§£SpringBoot+Mybatisç­‰çš„ç»“æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/SpringBootds.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/SpringMVC01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27062" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/SpringMVC01.html&quot;);" href="javascript:void(0);" alt="">SpringMVC</a><div class="blog-slider__text">SSMä¸­çš„MVCåŸºæœ¬ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/SpringMVC01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/C02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27068" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/C02.html&quot;);" href="javascript:void(0);" alt="">C++é«˜çº§</a><div class="blog-slider__text">C++æ·±å…¥çš„ç ”ç©¶</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/C02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/MyBatis01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27068" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/MyBatis01.html&quot;);" href="javascript:void(0);" alt="">MyBatis</a><div class="blog-slider__text">æ•°æ®åº“Value-keysçš„åŸºæœ¬ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/MyBatis01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/MyBatis02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27057" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/MyBatis02.html&quot;);" href="javascript:void(0);" alt="">MyBatis - Plus</a><div class="blog-slider__text">MyBatisçš„åŠ å¼ºç‰ˆæœ¬</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/MyBatis02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/C04.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27055" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/C04.html&quot;);" href="javascript:void(0);" alt="">C++è¿›é˜¶ä½¿ç”¨</a><div class="blog-slider__text">C++çš„ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/C04.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/C05.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27062" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/C05.html&quot;);" href="javascript:void(0);" alt="">C++é€šè®¯ç®¡ç†é¡¹ç›®</a><div class="blog-slider__text">C++çš„ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/C05.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/C07.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/C07.html&quot;);" href="javascript:void(0);" alt="">C++èŒå·¥ç³»ç»Ÿé¡¹ç›®</a><div class="blog-slider__text">C++èŒå·¥ç³»ç»Ÿé¡¹ç›®, æ›´å¥½çš„äº†è§£é¢å‘å¯¹è±¡çš„çŸ¥è¯†</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/C07.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/C01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27069" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/C01.html&quot;);" href="javascript:void(0);" alt="">C++å…¥é—¨</a><div class="blog-slider__text">äº†è§£C++çš„åŸºæœ¬è¯­æ³•å’Œä½¿ç”¨æ–¹æ³•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/C01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/SFzhdl.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27069" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/SFzhdl.html&quot;);" href="javascript:void(0);" alt="">æ ˆå’Œé˜Ÿåˆ—</a><div class="blog-slider__text">ç®—æ³•ç»“æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/SFzhdl.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javaWeb03.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27057" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javaWeb03.html&quot;);" href="javascript:void(0);" alt="">JavaWab(ä¸‰)</a><div class="blog-slider__text">æ­£å¼çš„å¼€å¯è½¯ä»¶çš„å¤§é—¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javaWeb03.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javaWeb02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-27</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javaWeb02.html&quot;);" href="javascript:void(0);" alt="">JavaWab(äºŒ)</a><div class="blog-slider__text">æ­£å¼çš„å¼€å¯è½¯ä»¶çš„å¤§é—¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javaWeb02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/SFecs.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27068" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-01</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/SFecs.html&quot;);" href="javascript:void(0);" alt="">äºŒå‰æ ‘</a><div class="blog-slider__text">ç®—æ³•ç»“æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/SFecs.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/SFhs.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27064" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/SFhs.html&quot;);" href="javascript:void(0);" alt="">å›æº¯</a><div class="blog-slider__text">ç®—æ³•ç»“æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/SFhs.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javaWeb04.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javaWeb04.html&quot;);" href="javascript:void(0);" alt="">JavaWab(å››)</a><div class="blog-slider__text">æ­£å¼çš„å¼€å¯è½¯ä»¶çš„å¤§é—¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javaWeb04.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/JVM04.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27059" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/JVM04.html&quot;);" href="javascript:void(0);" alt="">JVMç±»åŠ è½½</a><div class="blog-slider__text">JAVAä¸­ç±»çš„åŠ è½½è¿‡ç¨‹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/JVM04.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javaWeb01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27069" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-26</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javaWeb01.html&quot;);" href="javascript:void(0);" alt="">JavaWab(ä¸€)</a><div class="blog-slider__text">æ­£å¼çš„å¼€å¯è½¯ä»¶çš„å¤§é—¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javaWeb01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/JVM03.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27057" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/JVM03.html&quot;);" href="javascript:void(0);" alt="">JVMåƒåœ¾å›æ”¶</a><div class="blog-slider__text">JVMåƒåœ¾å›æ”¶æœºåˆ¶</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/JVM03.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/JVM01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27053" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-04</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/JVM01.html&quot;);" href="javascript:void(0);" alt="">JVMå¯¼å­¦</a><div class="blog-slider__text">JVMå…¥é—¨å¯¼å­¦</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/JVM01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/JVM02.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27059" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/JVM02.html&quot;);" href="javascript:void(0);" alt="">JVMå†…å­˜ç»“æ„</a><div class="blog-slider__text">JVMçš„å†…å­˜ç»“æ„</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/JVM02.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/JVM05.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27063" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/JVM05.html&quot;);" href="javascript:void(0);" alt="">JAVAå†…å­˜æ¨¡å‹</a><div class="blog-slider__text">JAVAçš„å†…å­˜æ¨¡å‹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/JVM05.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/javadx.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27053" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/javadx.html&quot;);" href="javascript:void(0);" alt="">Javaé¢å‘å¯¹è±¡</a><div class="blog-slider__text">è¿›è¡Œæ·±å…¥å­¦ä¹ </div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/javadx.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/java.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27064" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/java.html&quot;);" href="javascript:void(0);" alt="">Java</a><div class="blog-slider__text">è¿›è¡Œä¸€äº›åŸºç¡€çš„å­¦ä¹ </div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/java.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/Spring01.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgbed.link/file/27065" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/Spring01.html&quot;);" href="javascript:void(0);" alt="">Spring</a><div class="blog-slider__text">æ¡†æ¶çš„æ­å»ºä»¥åŠä¸€äº›åŸºæœ¬ä½¿ç”¨æ–¹æ³•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/Spring01.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>